<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO - PMAM | Sistema de Procedimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pmam-blue': '#1e3a8a',
                        'pmam-navy': '#0f172a',
                        'pmam-light': '#3b82f6',
                        'pmam-accent': '#0ea5e9',
                        'pmam-gold': '#D4AF37',
                        'pmam-gold-dark': '#B8941F',
                        'pmam-success': '#10b981',
                        'pmam-warning': '#f59e0b',
                        'pmam-error': '#ef4444',
                        'pmam-surface': '#f8fafc',
                        'pmam-card': '#ffffff',
                        'pmam-border': '#e2e8f0',
                        'pmam-text': '#334155',
                        'pmam-muted': '#64748b',
                        'pmam-dark': '#1e293b',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'slide-in': 'slideIn 0.4s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                    },
                    boxShadow: {
                        'pmam-lg': '0 10px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'pmam-xl': '0 20px 40px -10px rgba(0, 0, 0, 0.1)',
                    },
                }
            }
        }
const SUPABASE_URL = 'SUA_URL_AQUI';
const SUPABASE_KEY = 'SUA_CHAVE_ANON_AQUI';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Função para testar se o banco responde
async function testarBanco() {
    try {
        const { data, error } = await supabase.from('procedimentos').select('*').limit(1);
        if (error) throw error;
        console.log("✅ Banco de Dados conectado!");
    } catch (err) {
        console.error("❌ Erro na conexão:", err.message);
    }
}

testarBanco();

        
    </script>
    
    <style>
        body {
            font-feature-settings: "kern", "liga", "clig", "calt";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .shield-logo {
            width: 60px;
            height: 70px;
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }
        
        .shield-inner {
            width: 54px;
            height: 64px;
            background: #000;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .shield-icon {
            color: #D4AF37;
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .shield-text {
            color: #D4AF37;
            font-size: 10px;
            font-weight: 800;
            letter-spacing: 1px;
        }
        
        .step-bar {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin-bottom: 3rem;
        }
        
        .step-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #cbd5e1;
            z-index: 0;
        }
        
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            flex: 1;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #cbd5e1;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }
        
        .step-item.active .step-circle {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            color: #000;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.5);
        }
        
        .step-item.completed .step-circle {
            background: #10b981;
            color: white;
        }
        
        .step-label {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            font-weight: 500;
        }
        
        .step-item.active .step-label {
            color: #1e3a8a;
            font-weight: 600;
        }
        
        .card-procedimento {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        
        .card-procedimento:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border-color: #D4AF37;
        }
        
        .doc-card {
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            cursor: pointer;
        }
        
        .doc-card:hover {
            border-color: #D4AF37;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
        }
        
        .doc-card.generated {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #D4AF37;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .btn-gold {
            background: linear-gradient(135deg, #D4AF37, #FFD700);
            color: #000;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.4);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .sidebar {
            width: 280px;
            transition: transform 0.3s ease;
        }
        
        .main-content {
            margin-left: 280px;
            transition: margin 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                left: 0;
                height: 100vh;
                z-index: 40;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* Estilos para o botão de edição no preview */
        .edit-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        
        .document-content {
            position: relative;
        }
        
        .textarea-editable {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        
        .document-grid {
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        }
    </style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="text-pmam-text font-sans">
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-white border-r border-pmam-border fixed top-0 left-0 h-full overflow-y-auto custom-scrollbar">
        <div class="flex items-center justify-center p-2">
    <img src="logo-sispro.png" alt="SISPRO Logo" class="h-20 w-auto">
</div>
                <div>
                    <h2 class="text-xl font-bold text-pmam-navy">SISPRO - PMAM</h2>
                    <p class="text-sm text-pmam-muted">Sistema de Procedimentos</p>
                </div>
            </div>
        </div>
        
        <!-- Progresso do Processo -->
        <div class="p-6 border-b border-pmam-border">
            <h3 class="font-semibold text-pmam-navy mb-4">Progresso do Procedimento</h3>
            <div class="space-y-4">
                <div class="step-item" id="sidebar-step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Tipo de<br>Procedimento</div>
                    <div id="step-1-info" class="text-xs text-pmam-muted mt-1 text-center">Não selecionado</div>
                </div>
                <div class="step-item" id="sidebar-step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Caracterização<br>das Partes</div>
                    <div id="step-2-info" class="text-xs text-pmam-muted mt-1 text-center">Aguardando</div>
                </div>
                <div class="step-item" id="sidebar-step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Documentos<br>Variáveis</div>
                    <div id="step-3-info" class="text-xs text-pmam-muted mt-1 text-center">0/5 seções</div>
                </div>
            </div>
        </div>
        
        <!-- Documentos Gerados -->
        <div class="p-6">
            <h3 class="font-semibold text-pmam-navy mb-4">Documentos Gerados</h3>
            <div id="lista-documentos-sidebar" class="space-y-2">
                <!-- Documentos serão listados aqui -->
            </div>
        </div>
        
        <!-- Botão para abrir/fechar sidebar no mobile -->
        <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-pmam-blue text-white rounded-lg shadow-lg">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-pmam-border sticky top-0 z-30 shadow-pmam-lg">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-pmam-navy">Sistema de Procedimentos - PMAM</h1>
                    <div class="flex gap-3">
                        <button onclick="sistema.salvarProcedimento()" 
                                class="px-4 py-2 bg-pmam-success text-white rounded-lg hover:bg-green-600 text-sm font-medium transition-all flex items-center gap-2">
                            <i class="fas fa-save"></i>
                            <span class="hidden md:inline">Salvar</span>
                        </button>
                        <button onclick="sistema.abrirGerenciador()" 
                                class="px-4 py-2 bg-pmam-blue text-white rounded-lg hover:bg-blue-800 text-sm font-medium transition-all flex items-center gap-2">
                            <i class="fas fa-folder-open"></i>
                            <span class="hidden md:inline">Procedimentos</span>
                        </button>
                        <button onclick="sistema.exportarTodosPDF()" 
                                class="btn-gold px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i>
                            <span class="hidden md:inline">Exportar PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Content Area -->
        <div class="container mx-auto px-4 py-8">
            <!-- Progress Bar -->
            <div class="step-bar max-w-4xl mx-auto mb-12">
                <div class="step-item active" id="step-indicator-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Tipo de<br>Procedimento</div>
                </div>
                <div class="step-item" id="step-indicator-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Caracterização<br>das Partes</div>
                </div>
                <div class="step-item" id="step-indicator-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Documentos<br>Variáveis</div>
                </div>
            </div>
            
            <!-- TELA 1: Escolha do Procedimento -->
            <div id="tela-1" class="animate-fadeIn">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-pmam-navy mb-3">Escolha o Procedimento</h2>
                    <p class="text-pmam-muted">Selecione o tipo de procedimento que deseja iniciar</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
                    <!-- SAD -->
                    <div onclick="sistema.selecionarProcedimento('SAD')" 
                         class="card-procedimento bg-white rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center">
                                <i class="fas fa-gavel text-white text-2xl"></i>
                            </div>
                            <span class="text-xs font-bold bg-blue-100 text-blue-700 px-3 py-1 rounded-full">DISCIPLINAR</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">SAD</h3>
                        <p class="text-sm text-gray-600 mb-1">Sindicância Disciplinar</p>
                        <p class="text-xs text-gray-500">Apuração de infrações disciplinares</p>
                    </div>
                    
                    <!-- SINDINVEST -->
                    <div onclick="sistema.selecionarProcedimento('SINDINVEST')" 
                         class="card-procedimento bg-white rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-search text-white text-2xl"></i>
                            </div>
                            <span class="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full">INVESTIGATIVO</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">SINDINVEST</h3>
                        <p class="text-sm text-gray-600 mb-1">Sindicância Investigativa</p>
                        <p class="text-xs text-gray-500">Investigação de fatos</p>
                    </div>
                    
                    <!-- IPM -->
                    <div onclick="sistema.selecionarProcedimento('IPM')" 
                         class="card-procedimento bg-white rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center">
                                <i class="fas fa-shield-alt text-white text-2xl"></i>
                            </div>
                            <span class="text-xs font-bold bg-red-100 text-red-700 px-3 py-1 rounded-full">PENAL MILITAR</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">IPM</h3>
                        <p class="text-sm text-gray-600 mb-1">Inquérito Policial Militar</p>
                        <p class="text-xs text-gray-500">Investigação de infrações penais militares</p>
                    </div>
                    
                    <!-- PAD -->
                    <div onclick="sistema.selecionarProcedimento('PAD')" 
                         class="card-procedimento bg-white rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center">
                                <i class="fas fa-scale-balanced text-white text-2xl"></i>
                            </div>
                            <span class="text-xs font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full">ADMINISTRATIVO</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">PAD</h3>
                        <p class="text-sm text-gray-600 mb-1">Processo Administrativo Disciplinar</p>
                        <p class="text-xs text-gray-500">Processo formal de apuração</p>
                    </div>
                    
                    <!-- PARE -->
                    <div onclick="sistema.selecionarProcedimento('PARE')" 
                         class="card-procedimento bg-white rounded-2xl p-6">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-white text-2xl"></i>
                            </div>
                            <span class="text-xs font-bold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full">RESSARCIMENTO</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">PARE</h3>
                        <p class="text-sm text-gray-600 mb-1">Procedimento de Ressarcimento</p>
                        <p class="text-xs text-gray-500">Apuração de responsabilidade civil</p>
                    </div>
                </div>
                
                <div id="procedimento-selecionado-info" class="hidden mt-8 max-w-4xl mx-auto bg-blue-50 border border-blue-200 rounded-xl p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <div class="flex items-center mb-2">
                                <div id="procedimento-icon" class="w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas text-white"></i>
                                </div>
                                <div>
                                    <h3 id="procedimento-nome" class="text-xl font-bold text-pmam-navy"></h3>
                                    <p id="procedimento-descricao" class="text-pmam-muted"></p>
                                </div>
                            </div>
                        </div>
                        <button onclick="sistema.avancarParaCaracterizacao()" 
                                class="mt-4 md:mt-0 btn-gold px-8 py-3 rounded-lg font-medium flex items-center gap-2">
                            Continuar para Caracterização
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- TELA 2: Caracterização -->
            <div id="tela-2" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-pmam-navy mb-3">Caracterização das Partes</h2>
                    <p class="text-pmam-muted">Preencha os dados fundamentais do procedimento</p>
                </div>
                
                <div class="max-w-5xl mx-auto bg-white rounded-2xl border border-pmam-border p-8 shadow-pmam-xl">
                    <div class="mb-8 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-200">
                        <div class="text-sm text-blue-600 mb-1">Procedimento Selecionado:</div>
                        <div id="procedimento-selecionado-nome" class="text-2xl font-bold text-pmam-navy"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Coluna 1 -->
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-file-alt text-pmam-gold mr-2"></i>Número da Portaria*
                                </label>
                                <input type="text" id="numero-portaria" 
                                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: 05.02/2024/SAD/SJD/PMAM">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-calendar text-pmam-gold mr-2"></i>Data da Portaria*
                                </label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input type="number" id="data-dia" min="1" max="31"
                                               class="input-field w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Dia</label>
                                    </div>
                                    <div>
                                        <input type="text" id="data-mes" 
                                               class="input-field w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Mês</label>
                                    </div>
                                    <div>
                                        <input type="number" id="data-ano" min="2000" max="2100"
                                               class="input-field w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Ano</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-building text-pmam-gold mr-2"></i>Local/Unidade*
                                </label>
                                <input type="text" id="local-unidade" 
                                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: SJD do Comando de Policiamento Leste">
                            </div>
                        </div>
                        
                        <!-- Coluna 2 -->
                        <div class="space-y-6">
                            <div>
                                <label id="label-encarregado" class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-user-tie text-pmam-gold mr-2"></i>Encarregado/Responsável*
                                </label>
                                <input type="text" id="encarregado-nome" 
                                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: CAP QOPM NOME COMPLETO (12345)">
                            </div>
                            
                            <!-- NOVO CAMPO: ESCRIVÃO -->
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-pen-fancy text-pmam-gold mr-2"></i>Escrivão*
                                </label>
                                <input type="text" id="escrivao-nome" 
                                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: 1º TEN QOPM NOME COMPLETO (22892)">
                            </div>
                            
                            <div>
                                <label id="titulo-acusado" class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-user text-pmam-gold mr-2"></i>Acusado/Sindicado*
                                </label>
                                <input type="text" id="acusado-nome" 
                                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Nome, Posto/Grad e CI">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-users text-pmam-gold mr-2"></i>Ofendido/Vítima*
                                </label>
                                <select id="ofendido-tipo" class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                                    <option value="PMAM">Polícia Militar do Amazonas</option>
                                    <option value="FAZENDA">Fazenda Pública/PMAM</option>
                                    <option value="PARTICULAR">Particular</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">
                                    <i class="fas fa-clipboard-list text-pmam-gold mr-2"></i>Objeto da Apuração*
                                </label>
                                <textarea id="objeto-apuracao" rows="3"
                                          class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue resize-none"
                                          placeholder="Descreva sucintamente o objeto do procedimento..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-10 pt-6 border-t border-pmam-border">
                        <button onclick="sistema.voltarParaTela(1)" 
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-pmam-text rounded-lg font-medium transition-all flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i>
                            Voltar
                        </button>
                        <button onclick="sistema.gerarDocumentosBasicos()" 
                                class="btn-gold px-8 py-3 rounded-lg flex items-center gap-2">
                            Gerar Documentos Básicos
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- TELA 3: Documentos Variáveis -->
            <div id="tela-3" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold text-pmam-navy mb-3">Documentos do Procedimento</h2>
                    <p class="text-pmam-muted">Gerencie todos os documentos do procedimento</p>
                </div>
                
                <div class="max-w-6xl mx-auto space-y-8">
                    <!-- Documentos Básicos Gerados -->
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border-2 border-green-200 p-6">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                            <h3 class="text-xl font-bold text-pmam-navy">Documentos Básicos (Gerados Automaticamente)</h3>
                        </div>
                        <div id="lista-documentos-basicos" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 document-grid">
                            <!-- Preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <!-- Documentos Variáveis -->
                    <div class="bg-white rounded-2xl border border-pmam-border p-6 shadow-pmam-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <i class="fas fa-file-alt text-pmam-gold text-2xl"></i>
                            <h3 class="text-xl font-bold text-pmam-navy">Documentos Variáveis</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <!-- Ofícios -->
                            <div onclick="sistema.abrirModalDocumento('oficios')" 
                                 class="doc-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-envelope text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-pmam-navy mb-2">Ofícios</h4>
                                <p class="text-sm text-pmam-muted mb-3">Comunicações oficiais</p>
                                <div id="status-oficios" class="text-xs text-pmam-muted">Não gerado</div>
                            </div>
                            
                            <!-- Termos -->
                            <div onclick="sistema.abrirModalDocumento('termos')" 
                                 class="doc-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-gavel text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-pmam-navy mb-2">Termos</h4>
                                <p class="text-sm text-pmam-muted mb-3">Declarações e interrogatórios</p>
                                <div id="status-termos" class="text-xs text-pmam-muted">Não gerado</div>
                            </div>
                            
                            <!-- Certidões -->
                            <div onclick="sistema.abrirModalDocumento('certidoes')" 
                                 class="doc-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-certificate text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-pmam-navy mb-2">Certidões</h4>
                                <p class="text-sm text-pmam-muted mb-3">Documentos certificados</p>
                                <div id="status-certidoes" class="text-xs text-pmam-muted">Não gerado</div>
                            </div>
                            
                            <!-- Relatório -->
                            <div onclick="sistema.abrirModalDocumento('relatorio')" 
                                 class="doc-card rounded-xl p-6 text-center">
                                <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-amber-500 to-amber-600 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-file-contract text-white text-2xl"></i>
                                </div>
                                <h4 class="font-bold text-pmam-navy mb-2">Relatório Final</h4>
                                <p class="text-sm text-pmam-muted mb-3">Relatório final e conclusão</p>
                                <div id="status-relatorio" class="text-xs text-pmam-muted">Não gerado</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ações -->
                    <div class="flex justify-between items-center">
                        <button onclick="sistema.voltarParaTela(2)" 
                                class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-pmam-text rounded-lg font-medium transition-all flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i>
                            Voltar
                        </button>
                        <div class="flex gap-3">
                            <button onclick="sistema.visualizarTodos()" 
                                    class="px-6 py-3 bg-pmam-blue text-white rounded-lg font-medium transition-all flex items-center gap-2">
                                <i class="fas fa-eye"></i>
                                Visualizar/Editar Todos
                            </button>
                            <button onclick="sistema.exportarTodosPDF()" 
                                    class="btn-gold px-6 py-3 rounded-lg flex items-center gap-2">
                                <i class="fas fa-file-pdf"></i>
                                Exportar PDF
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Documento -->
    <div id="modal-documento" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl border-2 border-pmam-gold shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-pmam-border flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 id="modal-titulo" class="text-2xl font-bold text-pmam-navy"></h3>
                    <button onclick="sistema.fecharModal()" class="text-pmam-muted hover:text-pmam-navy transition-colors">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-6 custom-scrollbar">
                <div id="modal-conteudo"></div>
            </div>
            
            <div class="p-6 border-t border-pmam-border flex-shrink-0">
                <div class="flex justify-end gap-3">
                    <button onclick="sistema.fecharModal()" 
                            class="px-6 py-3 bg-gray-200 hover:bg-gray-300 text-pmam-text rounded-lg font-medium transition-all">
                        Cancelar
                    </button>
                    <button onclick="sistema.salvarDocumento()" 
                            class="btn-gold px-8 py-3 rounded-lg flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Salvar Documento
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Gerenciador -->
    <div id="modal-gerenciador" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl border-2 border-pmam-gold shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-pmam-border">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-pmam-navy">Gerenciador de Procedimentos</h3>
                    <button onclick="sistema.fecharGerenciador()" class="text-pmam-muted hover:text-pmam-navy">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <input type="text" id="busca-procedimento" 
                       class="input-field w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                       placeholder="Buscar por número da portaria...">
            </div>
            
            <div class="flex-1 overflow-auto p-6 custom-scrollbar">
                <div id="lista-procedimentos-salvos"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Preview -->
    <div id="modal-preview" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl border-2 border-pmam-gold shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-pmam-border flex-shrink-0">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-2xl font-bold text-pmam-navy">Preview - Todos os Documentos</h3>
                    <button onclick="sistema.fecharPreview()" class="text-pmam-muted hover:text-pmam-navy">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="flex gap-3">
                    <select id="seletor-documento-preview" 
                            class="flex-1 p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                        <option value="">Selecione um documento</option>
                    </select>
                    <button onclick="sistema.habilitarEdicaoPreview()" 
                            class="px-4 py-3 bg-amber-500 text-white rounded-lg hover:bg-amber-600 flex items-center gap-2">
                        <i class="fas fa-edit"></i>
                        Editar
                    </button>
                    <button onclick="sistema.exportarPDFSelecionado()" 
                            class="px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i>
                        Exportar PDF
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-6 custom-scrollbar">
                <div id="preview-conteudo" class="font-mono text-sm bg-gray-50 p-6 rounded-lg border border-pmam-border whitespace-pre-wrap"></div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-3 w-80"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        
        class SistemaSISPRO {
            constructor() {
               // No topo da sua classe SistemaSISPRO
constructor() {
    this.supabase = supabase.createClient('SUA_URL_DO_SUPABASE', 'SUA_CHAVE_ANON_PUBLIC');
    // ... restante do construtor
}

async salvarProcedimento(dados) {
    const { data, error } = await this.supabase
        .from('procedimentos')
        .insert([{ 
            tipo_documento: dados.tipo, 
            conteudo: dados,
            numero_procedimento: dados.numero 
        }]);
    
    if (error) throw error;
    this.notificar('Procedimento salvo com sucesso!', 'success');
} this.telaAtual = 1;
                this.procedimentoSelecionado = null;
                this.dadosCaracterizacao = null;
                this.documentos = {
                    basicos: {
                        autuacao: { gerado: false, conteudo: '', titulo: 'Autuação' },
                        abertura: { gerado: false, conteudo: '', titulo: 'Termo de Abertura' },
                        designacaoEscrivao: { gerado: false, conteudo: '', titulo: 'Designação do Escrivão' },
                        termoCompromisso: { gerado: false, conteudo: '', titulo: 'Termo de Compromisso' },
                        designacao: { gerado: false, conteudo: '', titulo: 'Designação de Escrivão' }
                    },
                    variaveis: {
                        oficios: [],
                        termos: [],
                        certidoes: [],
                        relatorio: { gerado: false, conteudo: '', titulo: 'Relatório Final' }
                    }
                };
                this.documentoAtualTipo = null;
                this.procedimentosSalvos = this.carregarProcedimentosSalvos();
                this.edicaoHabilitada = false;
                
                this.init();
            }
            
            init() {
                this.preencherDataAtual();
                this.inicializarEventos();
                this.atualizarProgressoSidebar();
            }
            
            inicializarEventos() {
                // Sidebar toggle
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                });
                
                // Fechar sidebar ao clicar fora (mobile)
                document.addEventListener('click', (e) => {
                    const sidebar = document.getElementById('sidebar');
                    const toggleBtn = document.getElementById('sidebar-toggle');
                    if (window.innerWidth < 1024 && 
                        !sidebar.contains(e.target) && 
                        !toggleBtn.contains(e.target) && 
                        sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                    }
                });
            }
            
            selecionarProcedimento(tipo) {
                const procedimentos = {
                    'SAD': { 
                        id: 'SAD', 
                        nome: 'SINDICÂNCIA DISCIPLINAR',
                        nomeCompleto: 'Sindicância Disciplinar',
                        cor: 'blue',
                        icon: 'fa-gavel',
                        descricao: 'Para apuração de infrações disciplinares cometidas por militares.'
                    },
                    'SINDINVEST': { 
                        id: 'SINDINVEST', 
                        nome: 'SINDICÂNCIA INVESTIGATIVA',
                        nomeCompleto: 'Sindicância Investigativa',
                        cor: 'purple',
                        icon: 'fa-search',
                        descricao: 'Para investigação de fatos que possam configurar infrações.'
                    },
                    'IPM': { 
                        id: 'IPM', 
                        nome: 'INQUÉRITO POLICIAL MILITAR',
                        nomeCompleto: 'Inquérito Policial Militar',
                        cor: 'red',
                        icon: 'fa-shield-alt',
                        descricao: 'Para investigação de infrações penais militares.'
                    },
                    'PAD': { 
                        id: 'PAD', 
                        nome: 'PROCESSO ADMINISTRATIVO DISCIPLINAR',
                        nomeCompleto: 'Processo Administrativo Disciplinar',
                        cor: 'amber',
                        icon: 'fa-scale-balanced',
                        descricao: 'Processo formal para apuração de infrações disciplinares.'
                    },
                    'PARE': { 
                        id: 'PARE', 
                        nome: 'PROCEDIMENTO DE RESSARCIMENTO',
                        nomeCompleto: 'Procedimento de Ressarcimento',
                        cor: 'emerald',
                        icon: 'fa-hand-holding-usd',
                        descricao: 'Para apuração de responsabilidade civil por danos.'
                    }
                };
                
                this.procedimentoSelecionado = procedimentos[tipo];
                
                // Atualizar interface
                document.getElementById('procedimento-selecionado-nome').textContent = 
                    `${this.procedimentoSelecionado.id} - ${this.procedimentoSelecionado.nome}`;
                
                // Mostrar painel de confirmação
                const infoDiv = document.getElementById('procedimento-selecionado-info');
                infoDiv.classList.remove('hidden');
                
                document.getElementById('procedimento-nome').textContent = 
                    `${this.procedimentoSelecionado.id} - ${this.procedimentoSelecionado.nome}`;
                document.getElementById('procedimento-descricao').textContent = this.procedimentoSelecionado.descricao;
                
                // Atualizar ícone
                const iconDiv = document.getElementById('procedimento-icon');
                iconDiv.className = `w-10 h-10 rounded-lg flex items-center justify-center mr-3 bg-${this.procedimentoSelecionado.cor}-500`;
                iconDiv.innerHTML = `<i class="fas ${this.procedimentoSelecionado.icon} text-white"></i>`;
                
                this.atualizarProgressoSidebar();
                this.mostrarToast('Procedimento selecionado com sucesso', 'sucesso');
            }
            
            avancarParaCaracterizacao() {
                if (!this.procedimentoSelecionado) {
                    this.mostrarToast('Selecione um tipo de procedimento primeiro', 'erro');
                    return;
                }
                
                this.avancarTela(2);
                
                // Atualizar labels específicos
                if (this.procedimentoSelecionado.id === 'IPM') {
                    document.getElementById('label-encarregado').innerHTML = 
                        '<i class="fas fa-user-tie text-pmam-gold mr-2"></i>Encarregado do IPM*';
                }
                
                if (this.procedimentoSelecionado.id === 'PARE') {
                    document.getElementById('titulo-acusado').innerHTML = 
                        '<i class="fas fa-user text-pmam-gold mr-2"></i>Indiciado/Responsável*';
                }
                
                // Preencher número padrão
                const ano = document.getElementById('data-ano').value || new Date().getFullYear();
                document.getElementById('numero-portaria').value = `XX.XX/${ano}/${this.procedimentoSelecionado.id}/SJD/PMAM`;
            }
            
            gerarDocumentosBasicos() {
                // Validar campos
                if (!this.validarCamposCaracterizacao()) {
                    return;
                }
                
                // Coletar dados
                this.dadosCaracterizacao = {
                    procedimento: this.procedimentoSelecionado,
                    portaria: document.getElementById('numero-portaria').value,
                    data: {
                        dia: document.getElementById('data-dia').value,
                        mes: document.getElementById('data-mes').value,
                        ano: document.getElementById('data-ano').value,
                        completa: `${document.getElementById('data-dia').value} de ${document.getElementById('data-mes').value} de ${document.getElementById('data-ano').value}`
                    },
                    local: document.getElementById('local-unidade').value,
                    encarregado: document.getElementById('encarregado-nome').value,
                    escrivao: document.getElementById('escrivao-nome').value,
                    acusado: document.getElementById('acusado-nome').value,
                    ofendido: document.getElementById('ofendido-tipo').options[document.getElementById('ofendido-tipo').selectedIndex].text,
                    objeto: document.getElementById('objeto-apuracao').value
                };
                
                // Gerar documentos básicos automaticamente
                this.documentos.basicos.autuacao = {
                    gerado: true,
                    conteudo: this.gerarAutuacao(),
                    titulo: 'Autuação'
                };
                
                this.documentos.basicos.abertura = {
                    gerado: true,
                    conteudo: this.gerarAbertura(),
                    titulo: 'Termo de Abertura'
                };
                
                this.documentos.basicos.designacao = {
                    gerado: true,
                    conteudo: this.gerarDesignacao(),
                    titulo: 'Designação de Escrivão'
                };
                
                // NOVOS DOCUMENTOS BÁSICOS
                this.documentos.basicos.designacaoEscrivao = {
                    gerado: true,
                    conteudo: this.gerarDesignacaoEscrivao(),
                    titulo: 'Designação do Escrivão'
                };
                
                this.documentos.basicos.termoCompromisso = {
                    gerado: true,
                    conteudo: this.gerarTermoCompromissoEscrivao(),
                    titulo: 'Termo de Compromisso'
                };
                
                this.avancarTela(3);
                this.atualizarListaDocumentosBasicos();
                this.atualizarListaDocumentosSidebar();
                this.atualizarProgressoSidebar();
                this.mostrarToast('Documentos básicos gerados automaticamente!', 'sucesso');
            }
            
            validarCamposCaracterizacao() {
                const campos = [
                    { id: 'numero-portaria', nome: 'Número da Portaria' },
                    { id: 'data-dia', nome: 'Dia' },
                    { id: 'data-mes', nome: 'Mês' },
                    { id: 'data-ano', nome: 'Ano' },
                    { id: 'local-unidade', nome: 'Local/Unidade' },
                    { id: 'encarregado-nome', nome: 'Encarregado' },
                    { id: 'escrivao-nome', nome: 'Escrivão' },
                    { id: 'acusado-nome', nome: 'Acusado/Sindicado' },
                    { id: 'objeto-apuracao', nome: 'Objeto da Apuração' }
                ];
                
                for (const campo of campos) {
                    const elemento = document.getElementById(campo.id);
                    if (!elemento.value.trim()) {
                        this.mostrarToast(`Campo obrigatório: ${campo.nome}`, 'erro');
                        elemento.focus();
                        return false;
                    }
                }
                
                return true;
            }
            
            gerarAutuacao() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `${d.procedimento.nome}

ENCARREGADO: ${d.encarregado}
ESCRIVÃO: ${d.escrivao}
${d.procedimento.id === 'PARE' ? 'RESPONSÁVEL' : 'ACUSADO'}: ${d.acusado}
OFENDIDO: ${d.ofendido}


A U T U A Ç Ã O

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta cidade de Manaus, Estado do Amazonas, na ${d.local}, autuo a Portaria nº ${d.portaria}, datada de ${d.data.completa}, e demais documentos que a este junto, do que para constar, lavro o presente termo. Eu, ${d.encarregado}, ${cargo} que o digitei e assino.

__________________________________
${d.encarregado}
${cargo}`;
            }
            
            gerarAbertura() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `TERMO DE ABERTURA

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta cidade de Manaus, Estado do Amazonas, na ${d.local}, dei início ao presente ${d.procedimento.nome}, tendo como objeto: ${d.objeto}. Do que para constar lavro o presente Termo que o escrevi e assino.

__________________________________
${d.encarregado}
${cargo}`;
            }
            
            gerarDesignacao() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `TERMO DE DESIGNAÇÃO DE ESCRIVÃO

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, eu, ${d.encarregado}, ${cargo}, RESOLVO:

DESIGNAR o(a) ${d.escrivao}, para exercer a função de ESCRIVÃO no presente ${d.procedimento.nome} acima referenciado, devendo cumprir todas as determinações legais inerentes ao cargo.

Para constar, lavro o presente termo que vai assinado.

__________________________________
${d.encarregado}
${cargo}`;
            }
            
            // NOVO MÉTODO: Designação do Escrivão
            gerarDesignacaoEscrivao() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `GOVERNO DO ESTADO

DESIGNAÇÃO DE ESCRIVÃO

Designo, nos termos do Art. 11 do Código de Processo Penal Militar, o ${d.escrivao}, para servir como Escrivão do ${d.procedimento.nome} do qual sou encarregado, lavrando-se o competente termo de compromisso.

Manaus, AM, ${d.data.dia} de ${d.data.mes} de ${d.data.ano}.

__________________________________
${d.encarregado}
${cargo}`;
            }
            
            // NOVO MÉTODO: Termo de Compromisso do Escrivão
            gerarTermoCompromissoEscrivao() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `TERMO DE COMPROMISSO DO ESCRIVÃO

Aos ${d.data.dia} dias do mês de ${d.data.mes} de ${d.data.ano}, nesta Cidade de Manaus, Estado do Amazonas, na ${d.local}, foi designado pelo Senhor ${d.encarregado}, Encarregado deste ${d.procedimento.nome}, o ${d.escrivao}, para exercer a função de Escrivão, que perante o referido Encarregado prestou compromisso legal de manter o sigilo do procedimento e cumprir fielmente as determinações legais, durante o exercício da função.

${d.encarregado.split('(')[0].trim()}
${cargo}`;
            }
            
            abrirModalDocumento(tipo) {
                this.documentoAtualTipo = tipo;
                
                const titulos = {
                    'oficios': 'Novo Ofício',
                    'termos': 'Novo Termo de Declaração',
                    'certidoes': 'Nova Certidão',
                    'relatorio': 'Relatório Final'
                };
                
                document.getElementById('modal-titulo').textContent = titulos[tipo];
                
                let conteudoHTML = '';
                
                if (tipo === 'oficios') {
                    conteudoHTML = `
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-pmam-text mb-2">Data do Ofício*</label>
                                    <input type="date" id="campo-data-oficio" class="input-field w-full p-3 border border-pmam-border rounded-lg" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-pmam-text mb-2">Número do Ofício</label>
                                    <div class="text-sm bg-gray-100 p-3 rounded-lg">
                                        Automático: ${String(this.documentos.variaveis.oficios.length + 1).padStart(3, '0')}/${this.dadosCaracterizacao.data.ano}/${this.procedimentoSelecionado.id}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Destinatário*</label>
                                <input type="text" id="campo-destinatario" class="input-field w-full p-3 border border-pmam-border rounded-lg" placeholder="Nome, cargo e unidade">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Assunto*</label>
                                <input type="text" id="campo-assunto" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Conteúdo*</label>
                                <textarea id="campo-conteudo" rows="8" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none"></textarea>
                            </div>
                        </div>
                    `;
                } else if (tipo === 'termos') {
                    conteudoHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Tipo*</label>
                                <select id="campo-tipo-termo" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                                    <option value="Testemunha">Testemunha</option>
                                    <option value="Vítima/Ofendido">Vítima/Ofendido</option>
                                    <option value="Acusado/Sindicado">Acusado/Sindicado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Nome Completo*</label>
                                <input type="text" id="campo-declarante-nome" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-pmam-text mb-2">CPF*</label>
                                    <input type="text" id="campo-declarante-cpf" class="input-field w-full p-3 border border-pmam-border rounded-lg" placeholder="000.000.000-00">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-pmam-text mb-2">RG*</label>
                                    <input type="text" id="campo-declarante-rg" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Filiação*</label>
                                <input type="text" id="campo-declarante-filiacao" class="input-field w-full p-3 border border-pmam-border rounded-lg" placeholder="Nome do pai e da mãe">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Endereço*</label>
                                <input type="text" id="campo-declarante-endereco" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Depoimento*</label>
                                <textarea id="campo-depoimento" rows="6" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none"></textarea>
                            </div>
                        </div>
                    `;
                } else if (tipo === 'certidoes') {
                    conteudoHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Tipo de Certidão*</label>
                                <select id="campo-tipo-certidao" class="input-field w-full p-3 border border-pmam-border rounded-lg">
                                    <option value="Certidão de Autos">Certidão de Autos</option>
                                    <option value="Certidão de Publicação">Certidão de Publicação</option>
                                    <option value="Certidão de Conclusão">Certidão de Conclusão</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">Conteúdo*</label>
                                <textarea id="campo-conteudo-certidao" rows="10" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none"></textarea>
                            </div>
                        </div>
                    `;
                } else if (tipo === 'relatorio') {
                    conteudoHTML = `
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">I – INFORMAÇÕES PRELIMINARES*</label>
                                <textarea id="campo-historico" rows="4" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none" placeholder="Descreva as informações preliminares do procedimento..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">II – DILIGÊNCIAS REALIZADAS*</label>
                                <textarea id="campo-diligencias" rows="4" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none" placeholder="Descreva as diligências realizadas..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">III – ANÁLISE E FUNDAMENTAÇÃO*</label>
                                <textarea id="campo-analise" rows="4" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none" placeholder="Descreva a análise e fundamentação..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-pmam-text mb-2">IV – CONCLUSÃO E PROPOSTA*</label>
                                <textarea id="campo-conclusao" rows="4" class="input-field w-full p-3 border border-pmam-border rounded-lg resize-none" placeholder="Descreva a conclusão e proposta..."></textarea>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('modal-conteudo').innerHTML = conteudoHTML;
                document.getElementById('modal-documento').classList.remove('hidden');
                document.getElementById('modal-documento').classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
            
            salvarDocumento() {
                const tipo = this.documentoAtualTipo;
                let conteudo = '';
                
                if (tipo === 'oficios') {
                    const destinatario = document.getElementById('campo-destinatario').value;
                    const assunto = document.getElementById('campo-assunto').value;
                    const conteudoOf = document.getElementById('campo-conteudo').value;
                    const dataOfício = document.getElementById('campo-data-oficio').value;
                    
                    if (!destinatario || !assunto || !conteudoOf) {
                        this.mostrarToast('Preencha todos os campos', 'erro');
                        return;
                    }
                    
                    // Validar data não retroativa
                    if (this.documentos.variaveis.oficios.length > 0) {
                        const ultimoOfício = this.documentos.variaveis.oficios[this.documentos.variaveis.oficios.length - 1];
                        if (ultimoOfício.data && dataOfício < ultimoOfício.data) {
                            this.mostrarToast('Data do ofício não pode ser anterior ao último ofício gerado', 'erro');
                            return;
                        }
                    }
                    
                    conteudo = this.gerarOficio(destinatario, assunto, conteudoOf, dataOfício);
                    const numeroOfício = String(this.documentos.variaveis.oficios.length + 1).padStart(3, '0');
                    
                    this.documentos.variaveis.oficios.push({ 
                        conteudo, 
                        timestamp: Date.now(),
                        titulo: `Ofício ${numeroOfício} para ${destinatario.split(',')[0]}`,
                        data: dataOfício,
                        numero: numeroOfício
                    });
                    
                } else if (tipo === 'termos') {
                    const tipoTermo = document.getElementById('campo-tipo-termo').value;
                    const nome = document.getElementById('campo-declarante-nome').value;
                    const cpf = document.getElementById('campo-declarante-cpf').value;
                    const rg = document.getElementById('campo-declarante-rg').value;
                    const filiacao = document.getElementById('campo-declarante-filiacao').value;
                    const endereco = document.getElementById('campo-declarante-endereco').value;
                    const depoimento = document.getElementById('campo-depoimento').value;
                    
                    if (!nome || !cpf || !rg || !filiacao || !endereco || !depoimento) {
                        this.mostrarToast('Preencha todos os campos', 'erro');
                        return;
                    }
                    
                    conteudo = this.gerarTermo(tipoTermo, nome, cpf, rg, filiacao, endereco, depoimento);
                    this.documentos.variaveis.termos.push({ 
                        conteudo, 
                        timestamp: Date.now(),
                        titulo: `Termo de ${tipoTermo} - ${nome}` 
                    });
                    
                } else if (tipo === 'certidoes') {
                    const tipoCertidao = document.getElementById('campo-tipo-certidao').value;
                    const conteudoCert = document.getElementById('campo-conteudo-certidao').value;
                    
                    if (!conteudoCert) {
                        this.mostrarToast('Preencha o conteúdo', 'erro');
                        return;
                    }
                    
                    conteudo = this.gerarCertidao(tipoCertidao, conteudoCert);
                    this.documentos.variaveis.certidoes.push({ 
                        conteudo, 
                        timestamp: Date.now(),
                        titulo: tipoCertidao 
                    });
                    
                } else if (tipo === 'relatorio') {
                    const historico = document.getElementById('campo-historico').value;
                    const diligencias = document.getElementById('campo-diligencias').value;
                    const analise = document.getElementById('campo-analise').value;
                    const conclusao = document.getElementById('campo-conclusao').value;
                    
                    if (!historico || !diligencias || !analise || !conclusao) {
                        this.mostrarToast('Preencha todos os campos', 'erro');
                        return;
                    }
                    
                    conteudo = this.gerarRelatorio(historico, diligencias, analise, conclusao);
                    this.documentos.variaveis.relatorio = { 
                        gerado: true, 
                        conteudo,
                        titulo: 'Relatório Final'
                    };
                }
                
                this.atualizarStatusDocumento(tipo);
                this.atualizarListaDocumentosSidebar();
                this.fecharModal();
                this.mostrarToast('Documento salvo com sucesso!', 'sucesso');
            }
            
            gerarOficio(destinatario, assunto, conteudo, dataOfício = null) {
                const d = this.dadosCaracterizacao;
                const numeroOfício = String(this.documentos.variaveis.oficios.length + 1).padStart(3, '0');
                
                // Formatar data
                let dataFormatada = d.data.completa;
                if (dataOfício) {
                    const data = new Date(dataOfício);
                    const meses = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                    dataFormatada = `${data.getDate()} de ${meses[data.getMonth()]} de ${data.getFullYear()}`;
                }
                
                return `OFÍCIO Nº ${numeroOfício}/${d.data.ano}/${d.procedimento.id}
Quartel em Manaus/AM, ${dataFormatada}

Ao ${destinatario}

Assunto: ${assunto}

Senhor(a),

${conteudo}

Atenciosamente,

__________________________________
${d.encarregado}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante'}`;
            }
            
            gerarTermo(tipo, nome, cpf, rg, filiacao, endereco, depoimento) {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante';
                
                return `TERMO DE DECLARAÇÃO - ${tipo.toUpperCase()}

AUTOS: ${d.procedimento.nome} (${d.procedimento.id}) nº ${d.portaria}
${d.procedimento.id === 'IPM' ? 'ENCARREGADO' : 'SINDICANTE'}: ${d.encarregado}

${tipo.toUpperCase()}: ${nome}
CPF: ${cpf}
RG/IDENTIDADE: ${rg}
FILIAÇÃO: ${filiacao}
ENDEREÇO: ${endereco}

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta Cidade de Manaus, Estado do Amazonas, na ${d.local}, perante o ${d.procedimento.id === 'IPM' ? 'Encarregado' : 'Sindicante'}, presente o Escrivão, foi inquirido(a) o(a) ${tipo.toLowerCase()} acima qualificado(a), que ao ser perguntado(a) sobre o objeto da apuração, declarou:

${depoimento}

Lida e achada conforme, dou por encerrado o presente Termo, que segue assinado.

Manaus-AM, ${d.data.completa}.

__________________________________
${nome}
${tipo}

__________________________________
${d.escrivao}
ESCRIVÃO

__________________________________
${d.encarregado}
${cargo}`;
            }
            
            gerarCertidao(tipo, conteudo) {
                const d = this.dadosCaracterizacao;
                
                return `${tipo.toUpperCase()}

AUTOS: ${d.procedimento.nome} (${d.procedimento.id}) nº ${d.portaria}

CERTIFICO que, nos autos acima referenciados:

${conteudo}

Para constar, lavro a presente certidão.

Manaus-AM, ${d.data.completa}.

__________________________________
${d.encarregado}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante'}`;
            }
            
            gerarRelatorio(historico, diligencias, analise, conclusao) {
                const d = this.dadosCaracterizacao;
                
                return `RELATÓRIO DO ${d.procedimento.nome}

REFERÊNCIA: ${d.portaria}
ENCARREGADO: ${d.encarregado}
ESCRIVÃO: ${d.escrivao}
${d.procedimento.id === 'PARE' ? 'RESPONSÁVEIS:' : 'INVESTIGADOS:'}
${d.acusado}

OBJETO: ${d.objeto}

I – INFORMAÇÕES PRELIMINARES

${historico}

II – DILIGÊNCIAS REALIZADAS

${diligencias}

III – ANÁLISE E FUNDAMENTAÇÃO

${analise}

IV – CONCLUSÃO E PROPOSTA

${conclusao}

Manaus-AM, ${d.data.completa}.

__________________________________
${d.encarregado}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Sindicante'}`;
            }
            
            atualizarStatusDocumento(tipo) {
                const status = document.getElementById(`status-${tipo}`);
                if (!status) return;
                
                let count = 0;
                if (tipo === 'oficios') count = this.documentos.variaveis.oficios.length;
                else if (tipo === 'termos') count = this.documentos.variaveis.termos.length;
                else if (tipo === 'certidoes') count = this.documentos.variaveis.certidoes.length;
                else if (tipo === 'relatorio') count = this.documentos.variaveis.relatorio.gerado ? 1 : 0;
                
                if (count > 0) {
                    status.textContent = `✓ ${count} gerado${count > 1 ? 's' : ''}`;
                    status.className = 'text-xs text-green-500 font-semibold';
                    status.closest('.doc-card').classList.add('generated');
                }
            }
            
            atualizarListaDocumentosBasicos() {
                const lista = document.getElementById('lista-documentos-basicos');
                const docs = [
                    { id: 'autuacao', nome: 'Autuação', icon: 'fa-file-signature' },
                    { id: 'abertura', nome: 'Termo de Abertura', icon: 'fa-folder-open' },
                    { id: 'designacao', nome: 'Designação de Escrivão', icon: 'fa-user-tie' },
                    { id: 'designacaoEscrivao', nome: 'Designação do Escrivão', icon: 'fa-id-card' },
                    { id: 'termoCompromisso', nome: 'Termo de Compromisso', icon: 'fa-handshake' }
                ];
                
                lista.innerHTML = docs.map(doc => {
                    const documento = this.documentos.basicos[doc.id];
                    const gerado = documento && documento.gerado;
                    
                    return `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center gap-3 mb-2">
                                <i class="fas ${doc.icon} ${gerado ? 'text-green-500' : 'text-gray-400'}"></i>
                                <h5 class="font-semibold text-pmam-navy">${doc.nome}</h5>
                            </div>
                            <div class="text-xs ${gerado ? 'text-green-600' : 'text-gray-500'}">
                                ${gerado ? '✓ Gerado automaticamente' : 'Aguardando dados'}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            atualizarListaDocumentosSidebar() {
                const lista = document.getElementById('lista-documentos-sidebar');
                let html = '';
                let totalDocumentos = 0;
                
                // Documentos básicos
                Object.values(this.documentos.basicos).forEach(doc => {
                    if (doc.gerado) {
                        totalDocumentos++;
                        html += `<div class="bg-green-50 border border-green-200 p-3 rounded mb-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-pmam-navy truncate">${doc.titulo}</span>
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                        </div>`;
                    }
                });
                
                // Documentos variáveis
                Object.values(this.documentos.variaveis).forEach((categoria, index) => {
                    if (Array.isArray(categoria)) {
                        categoria.forEach(doc => {
                            totalDocumentos++;
                            html += `<div class="bg-blue-50 border border-blue-200 p-3 rounded mb-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-pmam-navy truncate">${doc.titulo || 'Documento'}</span>
                                    <i class="fas fa-check text-blue-500"></i>
                                </div>
                            </div>`;
                        });
                    } else if (categoria.gerado) {
                        totalDocumentos++;
                        html += `<div class="bg-blue-50 border border-blue-200 p-3 rounded mb-2">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium text-pmam-navy">${categoria.titulo}</span>
                                <i class="fas fa-check text-blue-500"></i>
                            </div>
                        </div>`;
                    }
                });
                
                lista.innerHTML = html || '<p class="text-sm text-pmam-muted text-center">Nenhum documento gerado</p>';
                document.getElementById('step-3-info').textContent = `${totalDocumentos} documentos`;
            }
            
            visualizarTodos() {
                // Configurar seletor de documentos
                const seletor = document.getElementById('seletor-documento-preview');
                seletor.innerHTML = '<option value="">Selecione um documento para visualizar</option>';
                
                // Adicionar documentos básicos
                Object.entries(this.documentos.basicos).forEach(([tipo, doc]) => {
                    if (doc.gerado) {
                        const option = document.createElement('option');
                        option.value = `basico_${tipo}`;
                        option.textContent = `📄 ${doc.titulo}`;
                        seletor.appendChild(option);
                    }
                });
                
                // Adicionar ofícios
                this.documentos.variaveis.oficios.forEach((doc, index) => {
                    const option = document.createElement('option');
                    option.value = `oficio_${index}`;
                    option.textContent = `📨 Ofício ${doc.numero || index + 1}`;
                    seletor.appendChild(option);
                });
                
                // Adicionar termos
                this.documentos.variaveis.termos.forEach((doc, index) => {
                    const option = document.createElement('option');
                    option.value = `termo_${index}`;
                    option.textContent = `📝 Termo ${index + 1}`;
                    seletor.appendChild(option);
                });
                
                // Adicionar certidões
                this.documentos.variaveis.certidoes.forEach((doc, index) => {
                    const option = document.createElement('option');
                    option.value = `certidao_${index}`;
                    option.textContent = `📜 Certidão ${index + 1}`;
                    seletor.appendChild(option);
                });
                
                // Adicionar relatório
                if (this.documentos.variaveis.relatorio.gerado) {
                    const option = document.createElement('option');
                    option.value = 'relatorio';
                    option.textContent = '📊 Relatório Final';
                    seletor.appendChild(option);
                }
                
                // Abrir modal
                document.getElementById('modal-preview').classList.remove('hidden');
                document.getElementById('modal-preview').classList.add('flex');
                document.body.style.overflow = 'hidden';
                
                // Mostrar primeiro documento se existir
                if (seletor.options.length > 1) {
                    seletor.selectedIndex = 1;
                    this.mostrarPreview(seletor.value);
                }
            }
            
            mostrarPreview(valor) {
                const preview = document.getElementById('preview-conteudo');
                if (!valor) {
                    preview.textContent = 'Selecione um documento para visualizar...';
                    return;
                }
                
                const [tipo, index] = valor.split('_');
                
                let conteudo = '';
                
                if (tipo === 'basico') {
                    const doc = this.documentos.basicos[index];
                    if (doc) {
                        conteudo = doc.conteudo;
                    }
                } else if (tipo === 'oficio') {
                    const doc = this.documentos.variaveis.oficios[parseInt(index)];
                    if (doc) {
                        conteudo = doc.conteudo;
                    }
                } else if (tipo === 'termo') {
                    const doc = this.documentos.variaveis.termos[parseInt(index)];
                    if (doc) {
                        conteudo = doc.conteudo;
                    }
                } else if (tipo === 'certidao') {
                    const doc = this.documentos.variaveis.certidoes[parseInt(index)];
                    if (doc) {
                        conteudo = doc.conteudo;
                    }
                } else if (tipo === 'relatorio') {
                    const doc = this.documentos.variaveis.relatorio;
                    if (doc.gerado) {
                        conteudo = doc.conteudo;
                    }
                }
                
                if (this.edicaoHabilitada) {
                    preview.innerHTML = `
                        <div class="mb-4">
                            <button onclick="sistema.salvarEdicaoPreview()" 
                                    class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2">
                                <i class="fas fa-save"></i>
                                Salvar Alterações
                            </button>
                            <button onclick="sistema.cancelarEdicaoPreview()" 
                                    class="ml-2 px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">
                                Cancelar
                            </button>
                        </div>
                        <textarea id="editor-conteudo" 
                                  class="w-full h-96 p-4 border border-pmam-border rounded-lg font-mono text-sm resize-none textarea-editable">
${conteudo}
                        </textarea>
                        <div class="text-xs text-gray-500 mt-2">
                            Pressione Ctrl+S para salvar
                        </div>
                    `;
                    
                    // Focar no textarea
                    setTimeout(() => {
                        document.getElementById('editor-conteudo').focus();
                    }, 100);
                    
                    // Adicionar atalho Ctrl+S
                    const editor = document.getElementById('editor-conteudo');
                    editor.addEventListener('keydown', (e) => {
                        if (e.ctrlKey && e.key === 's') {
                            e.preventDefault();
                            this.salvarEdicaoPreview();
                        }
                    });
                } else {
                    preview.textContent = conteudo;
                }
            }
            
            habilitarEdicaoPreview() {
                this.edicaoHabilitada = true;
                const valor = document.getElementById('seletor-documento-preview').value;
                if (valor) {
                    this.mostrarPreview(valor);
                }
            }
            
            salvarEdicaoPreview() {
                const valor = document.getElementById('seletor-documento-preview').value;
                const editor = document.getElementById('editor-conteudo');
                
                if (!valor || !editor) {
                    this.mostrarToast('Nenhum documento selecionado para edição', 'erro');
                    return;
                }
                
                const [tipo, index] = valor.split('_');
                const novoConteudo = editor.value;
                
                // Atualizar documento na memória
                if (tipo === 'basico') {
                    this.documentos.basicos[index].conteudo = novoConteudo;
                } else if (tipo === 'oficio') {
                    this.documentos.variaveis.oficios[parseInt(index)].conteudo = novoConteudo;
                } else if (tipo === 'termo') {
                    this.documentos.variaveis.termos[parseInt(index)].conteudo = novoConteudo;
                } else if (tipo === 'certidao') {
                    this.documentos.variaveis.certidoes[parseInt(index)].conteudo = novoConteudo;
                } else if (tipo === 'relatorio') {
                    this.documentos.variaveis.relatorio.conteudo = novoConteudo;
                }
                
                this.edicaoHabilitada = false;
                this.mostrarToast('Documento atualizado com sucesso!', 'sucesso');
                this.mostrarPreview(valor);
            }
            
            cancelarEdicaoPreview() {
                this.edicaoHabilitada = false;
                const valor = document.getElementById('seletor-documento-preview').value;
                if (valor) {
                    this.mostrarPreview(valor);
                }
            }
            
            exportarPDFSelecionado() {
                const valor = document.getElementById('seletor-documento-preview').value;
                if (!valor) {
                    this.mostrarToast('Selecione um documento primeiro', 'erro');
                    return;
                }
                
                const [tipo, index] = valor.split('_');
                let conteudo = '';
                let nomeArquivo = '';
                
                if (tipo === 'basico') {
                    const doc = this.documentos.basicos[index];
                    conteudo = doc.conteudo;
                    nomeArquivo = `${this.procedimentoSelecionado.id}_${doc.titulo.replace(/\s+/g, '_')}`;
                } else if (tipo === 'oficio') {
                    const doc = this.documentos.variaveis.oficios[parseInt(index)];
                    conteudo = doc.conteudo;
                    nomeArquivo = `${this.procedimentoSelecionado.id}_Oficio_${doc.numero || parseInt(index) + 1}`;
                } else if (tipo === 'termo') {
                    const doc = this.documentos.variaveis.termos[parseInt(index)];
                    conteudo = doc.conteudo;
                    nomeArquivo = `${this.procedimentoSelecionado.id}_Termo_${parseInt(index) + 1}`;
                } else if (tipo === 'certidao') {
                    const doc = this.documentos.variaveis.certidoes[parseInt(index)];
                    conteudo = doc.conteudo;
                    nomeArquivo = `${this.procedimentoSelecionado.id}_Certidao_${parseInt(index) + 1}`;
                } else if (tipo === 'relatorio') {
                    const doc = this.documentos.variaveis.relatorio;
                    conteudo = doc.conteudo;
                    nomeArquivo = `${this.procedimentoSelecionado.id}_Relatorio_Final`;
                }
                
                this.gerarPDF(conteudo, nomeArquivo);
            }
            
            exportarTodosPDF() {
                // Coletar todos os documentos
                const todosDocumentos = [];
                
                // Documentos básicos
                Object.entries(this.documentos.basicos).forEach(([tipo, doc]) => {
                    if (doc.gerado) {
                        todosDocumentos.push({
                            conteudo: doc.conteudo,
                            nome: `${this.procedimentoSelecionado.id}_${doc.titulo.replace(/\s+/g, '_')}`
                        });
                    }
                });
                
                // Ofícios
                this.documentos.variaveis.oficios.forEach((doc, index) => {
                    todosDocumentos.push({
                        conteudo: doc.conteudo,
                        nome: `${this.procedimentoSelecionado.id}_Oficio_${doc.numero || index + 1}`
                    });
                });
                
                // Termos
                this.documentos.variaveis.termos.forEach((doc, index) => {
                    todosDocumentos.push({
                        conteudo: doc.conteudo,
                        nome: `${this.procedimentoSelecionado.id}_Termo_${index + 1}`
                    });
                });
                
                // Certidões
                this.documentos.variaveis.certidoes.forEach((doc, index) => {
                    todosDocumentos.push({
                        conteudo: doc.conteudo,
                        nome: `${this.procedimentoSelecionado.id}_Certidao_${index + 1}`
                    });
                });
                
                // Relatório
                if (this.documentos.variaveis.relatorio.gerado) {
                    todosDocumentos.push({
                        conteudo: this.documentos.variaveis.relatorio.conteudo,
                        nome: `${this.procedimentoSelecionado.id}_Relatorio_Final`
                    });
                }
                
                if (todosDocumentos.length === 0) {
                    this.mostrarToast('Nenhum documento para exportar', 'erro');
                    return;
                }
                
                // Gerar PDFs com delay para evitar bloqueio do navegador
                todosDocumentos.forEach((doc, index) => {
                    setTimeout(() => {
                        this.gerarPDF(doc.conteudo, doc.nome);
                    }, index * 500);
                });
                
                this.mostrarToast(`${todosDocumentos.length} PDFs serão gerados`, 'sucesso');
            }
            
            gerarPDF(conteudo, nomeArquivo) {
                const doc = new jsPDF();
                doc.setFont('helvetica');
                doc.setFontSize(11);
                
                const margem = 20;
                const largura = 210 - 2 * margem;
                
                // Título
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`${this.procedimentoSelecionado.id} - ${nomeArquivo.split('_').slice(1).join(' ')}`, 105, margem, { align: 'center' });
                
                // Conteúdo
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const linhas = doc.splitTextToSize(conteudo, largura);
                doc.text(linhas, margem, margem + 15);
                
                doc.save(`${nomeArquivo}.pdf`);
            }
            
            avancarTela(numero) {
                this.telaAtual = numero;
                
                // Atualizar telas
                document.getElementById('tela-1').classList.add('hidden');
                document.getElementById('tela-2').classList.add('hidden');
                document.getElementById('tela-3').classList.add('hidden');
                
                document.getElementById(`tela-${numero}`).classList.remove('hidden');
                
                // Atualizar barra de progresso
                document.querySelectorAll('.step-item').forEach(item => {
                    item.classList.remove('active', 'completed');
                });
                
                for (let i = 1; i <= numero; i++) {
                    const step = document.getElementById(`step-indicator-${i}`);
                    if (i < numero) {
                        step.classList.add('completed');
                    } else {
                        step.classList.add('active');
                    }
                }
                
                // Atualizar sidebar
                this.atualizarProgressoSidebar();
            }
            
            voltarParaTela(numero) {
                this.avancarTela(numero);
            }
            
            atualizarProgressoSidebar() {
                // Atualizar passos
                const steps = ['sidebar-step-1', 'sidebar-step-2', 'sidebar-step-3'];
                steps.forEach((stepId, index) => {
                    const step = document.getElementById(stepId);
                    step.classList.remove('active', 'completed');
                    
                    if (index + 1 < this.telaAtual) {
                        step.classList.add('completed');
                    } else if (index + 1 === this.telaAtual) {
                        step.classList.add('active');
                    }
                });
                
                // Atualizar informações
                if (this.procedimentoSelecionado) {
                    document.getElementById('step-1-info').textContent = this.procedimentoSelecionado.nomeCompleto;
                }
                
                if (this.telaAtual >= 2) {
                    document.getElementById('step-2-info').textContent = 'Em preenchimento';
                }
                
                if (this.telaAtual === 3) {
                    const totalDocs = Object.values(this.documentos.basicos).filter(d => d.gerado).length +
                                     this.documentos.variaveis.oficios.length +
                                     this.documentos.variaveis.termos.length +
                                     this.documentos.variaveis.certidoes.length +
                                     (this.documentos.variaveis.relatorio.gerado ? 1 : 0);
                    document.getElementById('step-3-info').textContent = `${totalDocs} documentos`;
                }
            }
            
            fecharModal() {
                document.getElementById('modal-documento').classList.remove('flex');
                document.getElementById('modal-documento').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            
            fecharPreview() {
                this.edicaoHabilitada = false;
                document.getElementById('modal-preview').classList.remove('flex');
                document.getElementById('modal-preview').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            
            salvarProcedimento() {
                if (!this.procedimentoSelecionado || !this.dadosCaracterizacao) {
                    this.mostrarToast('Complete a caracterização primeiro', 'erro');
                    return;
                }
                
                const procedimento = {
                    id: Date.now().toString(),
                    numeroPortaria: this.dadosCaracterizacao.portaria,
                    tipo: this.procedimentoSelecionado.id,
                    nome: this.procedimentoSelecionado.nome,
                    data: new Date().toISOString(),
                    caracterizacao: this.dadosCaracterizacao,
                    documentos: this.documentos,
                    status: 'em_andamento',
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                // Verificar se já existe
                const indexExistente = this.procedimentosSalvos.findIndex(
                    p => p.numeroPortaria === procedimento.numeroPortaria
                );
                
                if (indexExistente >= 0) {
                    this.procedimentosSalvos[indexExistente] = procedimento;
                } else {
                    this.procedimentosSalvos.push(procedimento);
                }
                
                localStorage.setItem('sispro_procedimentos', JSON.stringify(this.procedimentosSalvos));
                this.mostrarToast('Procedimento salvo com sucesso', 'sucesso');
            }
            
            abrirGerenciador() {
                this.atualizarGerenciador();
                document.getElementById('modal-gerenciador').classList.remove('hidden');
                document.getElementById('modal-gerenciador').classList.add('flex');
                document.body.style.overflow = 'hidden';
            }
            
            fecharGerenciador() {
                document.getElementById('modal-gerenciador').classList.remove('flex');
                document.getElementById('modal-gerenciador').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            
            atualizarGerenciador() {
                const lista = document.getElementById('lista-procedimentos-salvos');
                
                if (this.procedimentosSalvos.length === 0) {
                    lista.innerHTML = `<div class="text-center py-12">
                        <i class="fas fa-folder-open text-pmam-muted text-4xl mb-4"></i>
                        <p class="text-pmam-muted">Nenhum procedimento salvo</p>
                    </div>`;
                    return;
                }
                
                const procedimentosOrdenados = [...this.procedimentosSalvos].sort(
                    (a, b) => new Date(b.ultimaAtualizacao) - new Date(a.ultimaAtualizacao)
                );
                
                lista.innerHTML = procedimentosOrdenados.map(proc => `
                    <div class="bg-white border border-pmam-border rounded-lg p-4 mb-3 hover:bg-blue-50 transition-colors">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-folder text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-pmam-navy">${proc.nome}</h4>
                                    <p class="text-sm text-pmam-muted">Portaria: ${proc.numeroPortaria}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="text-pmam-muted">
                                ${new Date(proc.ultimaAtualizacao).toLocaleDateString('pt-BR')}
                            </div>
                            <button onclick="sistema.carregarProcedimentoSalvo('${proc.id}')" 
                                    class="text-pmam-blue hover:text-pmam-light font-medium">
                                <i class="fas fa-edit mr-1"></i> Carregar
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            carregarProcedimentoSalvo(id) {
                const procedimento = this.procedimentosSalvos.find(p => p.id === id);
                if (!procedimento) return;
                
                // Carregar dados
                this.procedimentoSelecionado = {
                    id: procedimento.tipo,
                    nome: procedimento.nome,
                    nomeCompleto: procedimento.nome,
                    descricao: '',
                    cor: 'blue',
                    icon: 'fa-folder'
                };
                
                this.dadosCaracterizacao = procedimento.caracterizacao;
                this.documentos = procedimento.documentos;
                
                // Preencher formulários
                document.getElementById('numero-portaria').value = procedimento.numeroPortaria;
                if (procedimento.caracterizacao.data) {
                    document.getElementById('data-dia').value = procedimento.caracterizacao.data.dia;
                    document.getElementById('data-mes').value = procedimento.caracterizacao.data.mes;
                    document.getElementById('data-ano').value = procedimento.caracterizacao.data.ano;
                }
                document.getElementById('local-unidade').value = procedimento.caracterizacao.local || '';
                document.getElementById('encarregado-nome').value = procedimento.caracterizacao.encarregado || '';
                document.getElementById('escrivao-nome').value = procedimento.caracterizacao.escrivao || '';
                document.getElementById('acusado-nome').value = procedimento.caracterizacao.acusado || '';
                document.getElementById('objeto-apuracao').value = procedimento.caracterizacao.objeto || '';
                
                // Atualizar interface
                this.avancarTela(3);
                this.atualizarListaDocumentosBasicos();
                this.atualizarListaDocumentosSidebar();
                this.fecharGerenciador();
                
                // Atualizar status dos documentos
                Object.entries(this.documentos.basicos).forEach(([tipo, doc]) => {
                    if (doc.gerado) {
                        // Atualizar visual se necessário
                    }
                });
                
                // Atualizar documentos variáveis
                ['oficios', 'termos', 'certidoes', 'relatorio'].forEach(tipo => {
                    let count = 0;
                    if (tipo === 'relatorio') {
                        count = this.documentos.variaveis[tipo].gerado ? 1 : 0;
                    } else {
                        count = this.documentos.variaveis[tipo].length;
                    }
                    
                    if (count > 0) {
                        const status = document.getElementById(`status-${tipo}`);
                        if (status) {
                            status.textContent = `✓ ${count} gerado${count > 1 ? 's' : ''}`;
                            status.className = 'text-xs text-green-500 font-semibold';
                            
                            const card = status.closest('.doc-card');
                            if (card) card.classList.add('generated');
                        }
                    }
                });
                
                this.mostrarToast('Procedimento carregado com sucesso', 'sucesso');
            }
            
            buscarProcedimentos() {
                const termo = document.getElementById('busca-procedimento').value.toLowerCase();
                const lista = document.getElementById('lista-procedimentos-salvos');
                
                if (!termo.trim()) {
                    this.atualizarGerenciador();
                    return;
                }
                
                const resultados = this.procedimentosSalvos.filter(proc => 
                    proc.numeroPortaria.toLowerCase().includes(termo) ||
                    proc.nome.toLowerCase().includes(termo)
                );
                
                if (resultados.length === 0) {
                    lista.innerHTML = `<div class="text-center py-12">
                        <i class="fas fa-search text-pmam-muted text-4xl mb-4"></i>
                        <p class="text-pmam-muted">Nenhum procedimento encontrado</p>
                    </div>`;
                    return;
                }
                
                lista.innerHTML = resultados.map(proc => `
                    <div class="bg-white border border-pmam-border rounded-lg p-4 mb-3 hover:bg-blue-50">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-folder text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-pmam-navy">${proc.nome}</h4>
                                    <p class="text-sm text-pmam-muted">${proc.numeroPortaria}</p>
                                </div>
                            </div>
                        </div>
                        <button onclick="sistema.carregarProcedimentoSalvo('${proc.id}')" 
                                class="w-full mt-2 px-4 py-2 bg-pmam-blue text-white rounded-lg hover:bg-blue-800 text-sm">
                            <i class="fas fa-edit mr-1"></i> Carregar Procedimento
                        </button>
                    </div>
                `).join('');
            }
            
            carregarProcedimentosSalvos() {
                try {
                    const dados = localStorage.getItem('sispro_procedimentos');
                    return dados ? JSON.parse(dados) : [];
                } catch (e) {
                    return [];
                }
            }
            
            preencherDataAtual() {
                const hoje = new Date();
                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                
                if (!document.getElementById('data-dia').value) {
                    document.getElementById('data-dia').value = hoje.getDate();
                }
                if (!document.getElementById('data-mes').value) {
                    document.getElementById('data-mes').value = meses[hoje.getMonth()];
                }
                if (!document.getElementById('data-ano').value) {
                    document.getElementById('data-ano').value = hoje.getFullYear();
                }
            }
            
            mostrarToast(mensagem, tipo) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                let cor = 'bg-pmam-blue';
                let icone = 'fas fa-info-circle';
                
                if (tipo === 'sucesso') {
                    cor = 'bg-green-500';
                    icone = 'fas fa-check-circle';
                } else if (tipo === 'erro') {
                    cor = 'bg-red-500';
                    icone = 'fas fa-exclamation-circle';
                }
                
                toast.className = `${cor} text-white p-4 rounded-xl shadow-lg animate-slide-in`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icone} mr-3"></i>
                        <span>${mensagem}</span>
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, 3000);
            }
        }
        
        // Inicializar sistema
        const sistema = new SistemaSISPRO();
        
        // Configurar eventos
        document.getElementById('seletor-documento-preview').addEventListener('change', function() {
            sistema.mostrarPreview(this.value);
        });
        
        document.getElementById('busca-procedimento').addEventListener('input', function() {
            sistema.buscarProcedimentos();
        });
        
        // Fechar modais com ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!document.getElementById('modal-documento').classList.contains('hidden')) {
                    sistema.fecharModal();
                }
                if (!document.getElementById('modal-gerenciador').classList.contains('hidden')) {
                    sistema.fecharGerenciador();
                }
                if (!document.getElementById('modal-preview').classList.contains('hidden')) {
                    sistema.fecharPreview();
                }
            }
        });
    </script>
</body>
</html>





