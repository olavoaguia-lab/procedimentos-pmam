<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO - PMAM | Sistema de Procedimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --navy: #0f172a;
            --gold: #c5a059;
            --bg: #f8fafc;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg);
            color: #1e293b;
        }

        .header { 
            background: #ffffff;
            border-bottom: 2px solid #e2e8f0;
            padding: 1.5rem 2rem;
        }

        .step-pill {
            @apply flex items-center gap-3 px-6 py-3 rounded-full transition-all duration-300 font-semibold text-sm border-2;
        }
        .step-pill.active { @apply bg-navy text-white border-navy shadow-lg; }
        .step-pill.pending { @apply bg-white text-slate-400 border-slate-200; }

        .card {
            @apply bg-white rounded-2xl border border-slate-100 shadow-xl p-8 transition-all hover:border-l-4 hover:border-l-navy;
        }

        .input {
            @apply w-full border-b-2 border-slate-200 bg-transparent py-3 px-1 focus:border-navy outline-none transition-all text-sm;
        }

        .btn-primary { @apply bg-navy text-white px-8 py-3 rounded-xl font-bold hover:bg-black transition-all shadow-md active:scale-95; }
        .btn-gold { @apply bg-gradient-to-r from-yellow-600 to-yellow-500 text-white px-8 py-3 rounded-xl font-bold hover:from-yellow-700 hover:to-yellow-600 transition-all shadow-md active:scale-95; }

        .title-gold { font-family: 'Playfair Display', serif; color: var(--gold); }

        /* Responsividade sidebar */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 1023px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 60;
            }
            #sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                padding-left: 0 !important;
            }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Sidebar -->
    <div id="sidebar" class="fixed top-0 left-0 h-full w-80 bg-white border-r border-slate-200 shadow-2xl overflow-y-auto z-50 lg:translate-x-0">
        <div class="p-8 border-b border-slate-200 flex flex-col items-center">
            <img src="logo-pmam.png" alt="Brasão PMAM" class="w-36 mb-6 drop-shadow-xl">
            <h2 class="text-2xl font-black text-navy tracking-tight">SISPRO - PMAM</h2>
            <p class="text-xs text-slate-400 uppercase font-bold tracking-widest mt-1">Sistema de Procedimentos</p>
        </div>

        <div class="p-6 border-b border-slate-200">
            <h3 class="font-semibold text-navy mb-6 text-sm uppercase tracking-widest">Etapas</h3>
            <div class="space-y-4">
                <div class="step-pill active"><i class="fas fa-check-circle"></i> Tipo</div>
                <div class="step-pill pending"><i class="fas fa-circle"></i> Qualificação</div>
                <div class="step-pill pending"><i class="fas fa-circle"></i> Documentos</div>
                <div class="step-pill pending"><i class="fas fa-circle"></i> Relatório</div>
            </div>
        </div>

        <div class="p-6">
            <h3 class="font-semibold text-navy mb-4 text-xs uppercase tracking-widest">Documentos Gerados</h3>
            <div id="lista-documentos-sidebar" class="space-y-2 text-xs text-slate-500">Nenhum documento gerado</div>
        </div>
    </div>

    <!-- Hamburger mobile -->
    <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-70 p-4 bg-navy text-white rounded-xl shadow-2xl">
        <i class="fas fa-bars text-2xl"></i>
    </button>

    <!-- Main -->
    <div class="min-h-screen lg:pl-80 main-content flex flex-col">
        <header class="header flex items-center justify-between">
            <div class="flex items-center gap-6">
                <img src="logo-sispro.png" alt="Logo SISPRO" class="w-24 drop-shadow-xl">
                <div>
                    <h1 class="text-3xl title-gold">SISPRO - Sistema de Procedimentos</h1>
                    <p class="text-lg text-slate-500 font-medium">Polícia Militar do Amazonas</p>
                </div>
            </div>
            <div class="flex gap-4">
                <button onclick="sistema.salvarNoBanco()" class="btn-primary flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt"></i> Salvar no Banco
                </button>
                <button onclick="sistema.exportarTodosPDF()" class="btn-gold flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
            </div>
        </header>

        <!-- Tela 1 -->
        <div id="tela-1" class="container mx-auto px-6 py-12 flex-1">
            <h2 class="text-4xl title-gold mb-12 text-center">Selecione o Tipo de Procedimento</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10 max-w-6xl mx-auto">
                <div onclick="sistema.selecionarProcedimento('IPM')" class="card cursor-pointer">
                    <i class="fas fa-gavel text-6xl text-navy mb-6"></i>
                    <h3 class="text-2xl font-bold text-navy">IPM</h3>
                    <p class="text-sm text-slate-500">Inquérito Policial Militar</p>
                </div>
                <div onclick="sistema.selecionarProcedimento('SAD')" class="card cursor-pointer">
                    <i class="fas fa-balance-scale text-6xl text-navy mb-6"></i>
                    <h3 class="text-2xl font-bold text-navy">SAD</h3>
                    <p class="text-sm text-slate-500">Sindicância Administrativa</p>
                </div>
                <div onclick="sistema.selecionarProcedimento('SINDINVEST')" class="card cursor-pointer">
                    <i class="fas fa-magnifying-glass text-6xl text-navy mb-6"></i>
                    <h3 class="text-2xl font-bold text-navy">SINDINVEST</h3>
                    <p class="text-sm text-slate-500">Sindicância Investigativa</p>
                </div>
                <div onclick="sistema.selecionarProcedimento('PAD')" class="card cursor-pointer">
                    <i class="fas fa-file-contract text-6xl text-navy mb-6"></i>
                    <h3 class="text-2xl font-bold text-navy">PAD</h3>
                    <p class="text-sm text-slate-500">Processo Administrativo Disciplinar</p>
                </div>
                <div onclick="sistema.selecionarProcedimento('PARE')" class="card cursor-pointer">
                    <i class="fas fa-exclamation-triangle text-6xl text-navy mb-6"></i>
                    <h3 class="text-2xl font-bold text-navy">PARE</h3>
                    <p class="text-sm text-slate-500">Rito Especial</p>
                </div>
            </div>
        </div>

        <!-- Tela 2 - Qualificação -->
        <div id="tela-2" class="hidden container mx-auto px-6 py-12 flex-1">
            <h2 class="text-4xl title-gold mb-12 text-center">Qualificação</h2>
            <div class="card">
                <h3 class="text-2xl font-bold text-navy mb-6">Dados Gerais</h3>
                <input id="portaria" placeholder="Portaria nº" class="input mb-4">
                <input id="data" type="date" class="input mb-4">
                <input id="unidade" placeholder="Unidade" class="input mb-4">
                <textarea id="preceito-legal" rows="4" placeholder="Preceito Legal / Enquadramento" class="w-full border-2 border-slate-200 rounded-xl p-4 focus:border-navy mt-6"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="card">
                    <h4 class="text-xl font-bold text-navy mb-4">Encarregado</h4>
                    <input id="encarregado-nome" placeholder="Nome" class="input mb-4">
                    <input id="encarregado-posto" placeholder="Posto/Grad" class="input mb-4">
                    <input id="encarregado-matricula" placeholder="Matrícula" class="input">
                </div>
                <div class="card">
                    <h4 class="text-xl font-bold text-navy mb-4">Sindicado</h4>
                    <input id="sindicado-nome" placeholder="Nome" class="input mb-4">
                    <input id="sindicado-posto" placeholder="Posto/Grad" class="input mb-4">
                    <input id="sindicado-matricula" placeholder="Matrícula" class="input">
                </div>
                <div class="card">
                    <h4 class="text-xl font-bold text-navy mb-4">Ofendido</h4>
                    <input id="ofendido-nome" placeholder="Nome" class="input mb-4">
                    <input id="ofendido-posto" placeholder="Posto/Grad" class="input mb-4">
                    <input id="ofendido-matricula" placeholder="RG/CPF" class="input">
                </div>
            </div>

            <div class="card mt-8">
                <h3 class="text-2xl font-bold text-navy mb-6">Testemunhas</h3>
                <div id="lista-testemunhas"></div>
                <button onclick="sistema.adicionarTestemunha()" class="btn-primary mt-6">+ Adicionar Testemunha</button>
            </div>

            <div class="text-center mt-12">
                <button onclick="sistema.salvarParcial(); sistema.avancarParaTela(3)" class="btn-primary text-lg px-12 py-4">Próximo: Documentos</button>
            </div>
        </div>

        <!-- Tela 3 - Documentos -->
        <div id="tela-3" class="hidden container mx-auto px-6 py-12 flex-1">
            <h2 class="text-4xl title-gold mb-12 text-center">Documentos</h2>
            <div class="card">
                <h3 class="text-2xl font-bold text-navy mb-6">Básicos (Auto-gerados)</h3>
                <button onclick="sistema.gerarDocumentosBasicos()" class="btn-primary mb-6">Gerar Documentos Básicos</button>
                <div id="lista-documentos-basicos" class="space-y-4"></div>
            </div>

            <div class="card mt-8">
                <h3 class="text-2xl font-bold text-navy mb-6">Diversos & SIGED</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="sistema.gerarDocumentoDiverso('prorrogacao')" class="card cursor-pointer text-center py-8">
                        <i class="fas fa-clock text-5xl text-navy mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Prorrogação de Prazo</h4>
                    </div>
                    <div onclick="sistema.gerarDocumentoDiverso('escrivao')" class="card cursor-pointer text-center py-8">
                        <i class="fas fa-user-tie text-5xl text-navy mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Designação de Escrivão</h4>
                    </div>
                    <div onclick="sistema.gerarDocumentoDiverso('defensorDativo')" class="card cursor-pointer text-center py-8">
                        <i class="fas fa-user-shield text-5xl text-navy mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Defensor Dativo</h4>
                    </div>
                    <div onclick="sistema.gerarDocumentoDiverso('despacho')" class="card cursor-pointer text-center py-8">
                        <i class="fas fa-gavel text-5xl text-navy mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Despacho</h4>
                    </div>
                    <div onclick="sistema.gerarDocumentoDiverso('oficio')" class="card cursor-pointer text-center py-8">
                        <i class="fas fa-envelope text-5xl text-navy mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Ofício</h4>
                    </div>
                    <div onclick="sistema.enviarParaSIGED()" class="card cursor-pointer text-center py-8 border-4 border-dashed border-gold">
                        <i class="fas fa-paper-plane text-5xl text-gold mb-4"></i>
                        <h4 class="text-xl font-bold text-navy">Enviar para SIGED</h4>
                    </div>
                </div>
                <div id="lista-documentos-diversos" class="space-y-4 mt-8"></div>
            </div>

            <div class="text-center mt-12">
                <button onclick="sistema.salvarParcial(); sistema.avancarParaTela(4)" class="btn-primary text-lg px-12 py-4">Próximo: Relatório</button>
            </div>
        </div>

        <!-- Tela 4 - Relatório -->
        <div id="tela-4" class="hidden container mx-auto px-6 py-12 flex-1">
            <h2 class="text-4xl title-gold mb-12 text-center">Relatório Final</h2>
            <div class="card">
                <h3 class="text-2xl font-bold text-navy mb-6">Capitulação Legal (Obrigatória)</h3>
                <input id="tipificacao-direta" placeholder="Tipificação Direta (ex.: art. 160 CPM)" class="input mb-4">
                <input id="tipificacao-indireta" placeholder="Tipificação Indireta (ex.: inc. I art. 9º CPM)" class="input mb-4">
            </div>
            <div class="card mt-6">
                <h3 class="text-2xl font-bold text-navy mb-6">Conteúdo do Relatório</h3>
                <textarea id="relatorio-conteudo" rows="20" class="w-full border-2 border-slate-200 rounded-xl p-4 focus:border-navy"></textarea>
            </div>
            <div class="text-center mt-12">
                <button onclick="sistema.exportarRelatorioPDF()" class="btn-primary text-lg px-12 py-4">Exportar Relatório</button>
                <button onclick="sistema.exportarTodosPDF()" class="btn-gold text-lg px-12 py-4 ml-6">Exportar Tudo</button>
            </div>
        </div>

        <!-- Modal -->
        <div id="modal-edicao" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="card w-11/12 max-w-4xl">
                <h3 id="modal-titulo" class="text-2xl font-bold text-navy mb-4"></h3>
                <textarea id="modal-conteudo" rows="15" class="w-full border-2 border-slate-200 rounded-xl p-4 focus:border-navy font-mono text-sm"></textarea>
                <div class="flex justify-end gap-4 mt-6">
                    <button onclick="sistema.salvarEdicaoDocumento()" class="btn-primary">Salvar</button>
                    <button onclick="sistema.fecharModal()" class="btn-outline">Cancelar</button>
                </div>
            </div>
        </div>

        <!-- JavaScript Completo -->
        <script>
            const SUPABASE_URL = 'https://dzknjtstiptcbkvszibo.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6a25qdHN0aXB0Y2JrdnN6aWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTU3NDYsImV4cCI6MjA4MTQ3MTc0Nn0.LN4j37EHqLQpdoS0mNAIW9v-MTgWo8nXoFl1FrhSSHE';

            class SistemaSISPRO {
                constructor() {
                    this.telaAtual = 1;
                    this.dados = { tipo: '', portaria: '', data: '', unidade: '', preceitoLegal: '', encarregado: {}, sindicado: {}, ofendido: {}, testemunhas: [] };
                    this.documentos = { basicos: [], diversos: [] };
                    this.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    this.atualizarEtapas();
                }

                notificar(msg, tipo = 'success') {
                    alert(msg); // Substituir por toast bonito se quiser
                }

                selecionarProcedimento(tipo) {
                    this.dados.tipo = tipo;
                    this.avancarParaTela(2);
                }

                adicionarTestemunha() {
                    const container = document.getElementById('lista-testemunhas');
                    const div = document.createElement('div');
                    div.className = 'card mt-4 p-6';
                    div.innerHTML = `
                        <input placeholder="Nome da Testemunha" class="input mb-4">
                        <input placeholder="Posto/Grad" class="input mb-4">
                        <input placeholder="Matrícula/RG" class="input mb-4">
                        <textarea placeholder="Declaração" rows="3" class="w-full border-2 border-slate-200 rounded-xl p-4"></textarea>
                    `;
                    container.appendChild(div);
                }

                salvarParcial() {
                    // Coleta dados (simplificado)
                    this.notificar('Dados salvos localmente!');
                }

                gerarDocumentosBasicos() {
                    this.documentos.basicos = [{titulo: 'Autuação', conteudo: 'Template autuação...'}];
                    this.atualizarListaDocumentos();
                }

                gerarDocumentoDiverso(tipo) {
                    let template = '';
                    if (tipo === 'prorrogacao') template = `PEDIDO DE PRORROGAÇÃO\nPortaria nº ${this.dados.portaria}\nJustificativa: [Edite]\nDiligências: [Edite]\nVia SIGED em 48h`;
                    // Outros templates
                    const doc = {titulo: tipo.toUpperCase(), conteudo: template};
                    this.documentos.diversos.push(doc);
                    this.atualizarListaDocumentos();
                }

                enviarParaSIGED() {
                    const memo = `MEMORANDO SIGED\nNº ${Math.random().toString(36).substring(7).toUpperCase()}/${new Date().getFullYear()}\nPortaria ${this.dados.portaria}\nAssunto: Envio de Autos\n${this.dados.encarregado.nome || '[Encarregado]'}`;
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    pdf.text(memo, 15, 20);
                    pdf.save('MEMO_SIGED.pdf');
                    window.open('https://sistemas.sefaz.am.gov.br/siged/', '_blank');
                    this.notificar('MEMO gerado e portal SIGED aberto para submissão!');
                }

                gerarRelatorio() {
                    const direta = document.getElementById('tipificacao-direta').value;
                    const indireta = document.getElementById('tipificacao-indireta').value;
                    if (!direta || !indireta) return this.notificar('Capitulação obrigatória!');
                    document.getElementById('relatorio-conteudo').value = `RELATÓRIO\nTip. Direta: ${direta}\nTip. Indireta: ${indireta}\n...`;
                }

                exportarRelatorioPDF() {
                    this.gerarRelatorio();
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    pdf.text(document.getElementById('relatorio-conteudo').value, 15, 20);
                    pdf.save('Relatorio.pdf');
                }

                exportarTodosPDF() {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    let y = 20;
                    [...this.documentos.basicos, ...this.documentos.diversos].forEach(d => {
                        pdf.text(d.titulo, 15, y);
                        y += 10;
                        pdf.text(d.conteudo, 15, y, {maxWidth: 180});
                        y += 50;
                        if (y > 280) { pdf.addPage(); y = 20; }
                    });
                    pdf.save('SISPRO_Completo.pdf');
                }

                async salvarNoBanco() {
                    const { error } = await this.supabase.from('procedimentos').insert([this.dados]);
                    this.notificar(error ? 'Erro' : 'Salvo no banco!');
                }

                avancarParaTela(n) {
                    document.querySelectorAll('[id^="tela-"]').forEach(t => t.classList.add('hidden'));
                    document.getElementById(`tela-${n}`).classList.remove('hidden');
                    this.telaAtual = n;
                    this.atualizarEtapas();
                }

                atualizarEtapas() {
                    document.querySelectorAll('.step-pill').forEach((p, i) => {
                        p.classList.toggle('active', i + 1 === this.telaAtual);
                        p.classList.toggle('pending', i + 1 !== this.telaAtual);
                    });
                }

                atualizarListaDocumentos() {
                    const sidebar = document.getElementById('lista-documentos-sidebar');
                    sidebar.innerHTML = [...this.documentos.basicos, ...this.documentos.diversos].map(d => `<div>${d.titulo}</div>`).join('');
                }
            }

            const sistema = new SistemaSISPRO();
            window.sistema = sistema;

            // Mobile toggle
            document.getElementById('sidebar-toggle').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('sidebar').classList.toggle('open');
            });
            document.addEventListener('click', () => document.getElementById('sidebar').classList.remove('open'));
            document.getElementById('sidebar').addEventListener('click', e => e.stopPropagation());
        </script>
    </div>
</body>
</html>
