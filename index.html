<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SJD PMAM - Gerador de Documentos Disciplinares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
      // Configuração de cores e estilos PMAM
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'pmam-blue': '#1e3a8a', // Azul Marinho
              'pmam-lightBlue': '#3b82f6', // Azul Claro
              'pmam-accent': '#0ea5e9', // Destaque Moderno
              'pmam-success': '#10b981', // Verde
              'pmam-error': '#ef4444', // Vermelho
              'pmam-secondary': '#64748b', // Cinza
              'pmam-bg': '#f8fafc', // Fundo Claro
              'pmam-card': '#ffffff', // Cartão Branco
            },
            boxShadow: {
              'pmam-xl': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
            },
            borderRadius: {
              'pmam-lg': '8px',
            }
          }
        }
      }
    </script>
    
    <script type="importmap">
    {
      "imports": {
        "jspdf": "https://aistudiocdn.com/jspdf@^3.0.4"
      }
    }
    </script>
    
    <style>
      /* Estilos para o menu lateral (sidebar) e responsividade */
      .sidebar {
        transform: translateX(0);
        transition: transform 0.3s ease-in-out;
      }
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          height: 100%;
          z-index: 20;
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
      }

      /* Estilo para o item de menu ativo/hover */
      .sidebar-item:hover, .sidebar-item.ativo {
        background-color: #0ea5e9; /* pmam-accent */
        color: #1e3a8a; /* pmam-blue */
        font-weight: 600;
      }
      
      /* Estilo para a pré-visualização de documento */
      #preview-documento {
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 0.9rem;
        color: #333;
        border: 1px solid #e2e8f0;
        min-height: 200px;
        background-color: #f0f4f8; 
      }
      
      /* Estilo para a animação do Toast */
      .toast {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
    </style>
  </head>
  
  <body class="bg-pmam-bg text-slate-800 antialiased min-h-screen flex">
    
    <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-30 p-2 bg-pmam-blue text-pmam-card rounded-md shadow-lg">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar" class="sidebar w-64 bg-pmam-blue text-pmam-card py-5 shadow-pmam-xl z-10 flex-shrink-0">
      <h2 class="text-center mb-7 text-2xl border-b border-white/10 pb-4 font-semibold">
        <i class="fas fa-balance-scale-right mr-2"></i> PMAM SJD
      </h2>
      
      <div id="menu-procedimentos" class="px-5 text-center text-sm">
          <p class="text-white/70 mb-2">Selecione um Procedimento:</p>
      </div>

      <div id="menu-documentos" class="mt-5 border-t border-white/10 pt-4">
        <p class="text-white/70 text-center text-sm px-5">Escolha o tipo de Procedimento no campo ao lado.</p>
      </div>
      
    </div>

    <div class="main-content flex-grow p-5 md:p-10">
      <div class="card bg-pmam-card p-5 md:p-8 rounded-pmam-lg shadow-pmam-xl">
        <h1 id="titulo-documento" class="text-pmam-blue mb-5 text-2xl md:text-3xl border-b-2 border-pmam-accent pb-3 font-semibold">
          <i class="fas fa-file-invoice mr-2"></i> Gerador de Documentos PMAM
        </h1>
        <p class="mb-5 text-gray-600" id="descricao-documento">Primeiro, selecione o tipo de Procedimento (Sindicância, IPM, etc.) para carregar os documentos adequados.</p>
        
        <div id="selecao-procedimento" class="mb-6 pb-4 border-b border-gray-200">
            <label for="procedimento-select" class="block mb-2 font-semibold text-pmam-blue text-lg"><i class="fas fa-folder-open mr-2"></i> Tipo de Procedimento:</label>
            <select id="procedimento-select" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" onchange="sistema.carregarProcedimento(this.value)">
                <option value="" disabled selected>-- Selecione o Tipo de Procedimento --</option>
                <option value="SD">Sindicância Disciplinar (SD)</option>
                <option value="SI">Sindicância Investigativa (SI)</option>
                <option value="IPM">Inquérito Policial Militar (IPM)</option>
                <option value="PAD">Processo Administrativo Disciplinar (PAD)</option>
                <option value="PARE">Procedimento Administrativo de Revisão Ex-Officio (PARE)</option>
            </select>
        </div>
        
        <form id="form-documento">
          
          <div id="campos-dinamicos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2 text-center py-10 text-pmam-secondary">Selecione um Procedimento acima para iniciar.</div>
          </div>

          <div class="mt-8 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
                <label for="data_dia" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Dia):</label>
                <input type="number" id="data_dia" name="data_dia" min="1" max="31" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
            <div class="form-group">
                <label for="data_mes" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Mês):</label>
                <input type="text" id="data_mes" name="data_mes" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
            <div class="form-group">
                <label for="data_ano" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Ano):</label>
                <input type="number" id="data_ano" name="data_ano" min="2000" max="2100" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
          </div>

          <div class="form-group mt-6">
            <label class="block mb-2 font-semibold text-pmam-blue border-b-2 border-pmam-lightBlue pb-1">Pré-visualização do Documento:</label>
            <div id="preview-documento" class="p-5 mt-2 rounded-lg shadow-inner">
              ... O documento será renderizado aqui ...
            </div>
          </div>

          <div class="botoes-acao flex flex-wrap gap-4 mt-8">
            <button type="button" class="btn btn-primario bg-pmam-lightBlue text-pmam-card py-3 px-6 rounded-md cursor-pointer font-semibold transition-all hover:bg-pmam-accent hover:shadow-lg hover:shadow-pmam-accent/50 hover:-translate-y-0.5 flex items-center justify-center" onclick="sistema.gerarPDF()">
              <i class="fas fa-file-pdf mr-2"></i> Gerar PDF
            </button>
            <button type="button" class="btn btn-secundario bg-pmam-secondary text-pmam-card py-3 px-6 rounded-md cursor-pointer font-semibold transition-all hover:bg-gray-700 hover:shadow-lg hover:shadow-pmam-secondary/50 hover:-translate-y-0.5 flex items-center justify-center" onclick="sistema.copiarTexto()">
              <i class="fas fa-copy mr-2"></i> Copiar Texto
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="toast-container fixed top-5 right-5 z-50" id="toast-container">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      const { jsPDF } = window.jspdf;

      // Função utilitária para obter o nome do mês
      const obterNomeMes = (numero) => {
          const meses = [
              'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
          ];
          return meses[numero - 1];
      };

      // Classe principal do sistema
      class SistemaPMAM {
        constructor() {
          this.procedimentos = this.definirModelos();
          this.camposContainer = document.getElementById('campos-dinamicos');
          this.previewArea = document.getElementById('preview-documento');
          this.form = document.getElementById('form-documento');
          this.tituloDocumento = document.getElementById('titulo-documento');
          this.descricaoDocumento = document.getElementById('descricao-documento');
          this.menuDocumentos = document.getElementById('menu-documentos');
          this.sidebar = document.getElementById('sidebar');
          this.toggleButton = document.getElementById('sidebar-toggle');
          
          this.procedimentoAtualId = null;
          this.modeloAtualId = null;
          
          // Configuração de Datas (preenche automaticamente)
          const hoje = new Date();
          document.getElementById('data_dia').value = hoje.getDate();
          document.getElementById('data_mes').value = obterNomeMes(hoje.getMonth() + 1);
          document.getElementById('data_ano').value = hoje.getFullYear();
          
          // Listeners
          this.form.addEventListener('input', () => this.atualizarPreview());
          this.toggleButton.addEventListener('click', () => this.toggleSidebar());

          // O sistema inicia aguardando a seleção do procedimento
        }

        // === 1. DEFINIÇÃO DOS MODELOS POR TIPO DE PROCEDIMENTO ===
        definirModelos() {
          return {
            // --- SINDICÂNCIA DISCIPLINAR (SD) ---
            SD: {
              nome: "SINDICÂNCIA DISCIPLINAR",
              documentos: {
                termoAbertura: {
                    titulo: "Termo de Abertura e Autuação",
                    campos: [
                        { id: 'numero_portaria', label: 'Nº da Portaria (Instauração)', tipo: 'text', placeholder: 'Ex: 05.02/2024/SIND/SJD/CPA OESTE/PMAM', valorPadrao: 'XX.XX/AAAA/SD/SJD/PMAM' },
                        { id: 'data_portaria', label: 'Data da Portaria', tipo: 'text', placeholder: 'Ex: 23 de Julho de 2024', valorPadrao: `${document.getElementById('data_dia').value} de ${document.getElementById('data_mes').value} de ${document.getElementById('data_ano').value}` },
                        { id: 'sindicado_nome', label: 'Nome, Posto/Grad e CI do Sindicado', tipo: 'text', placeholder: 'Ex: CAP QOPM Stanley O. De Araújo (CI 20943)', valorPadrao: 'NOME DO MILITAR (POSTO/GRAD CI XXXX)' },
                        { id: 'sindicante_nome', label: 'Nome, Posto/Grad e CI do Sindicante', tipo: 'text', placeholder: 'Ex: MAJ QOPM Olavo P. Da Silva Filho (CI 15000)', valorPadrao: 'NOME DO MILITAR (POSTO/GRAD CI XXXX)' },
                        { id: 'objeto_apuracao', label: 'Objeto da Apuração (Sucinto)', tipo: 'textarea', placeholder: 'Ex: Apurar a suposta irregularidade administrativa e disciplinar de abandono de posto...', valorPadrao: 'APURAR A SUPOSTA TRANSGRESSÃO DISCIPLINAR PRATICADA PELO MILITAR ACIMA QUALIFICADO...' },
                        { id: 'local_quartel', label: 'Local do Quartel/Unidade', tipo: 'text', placeholder: 'Ex: Quartel do CPA OESTE', valorPadrao: 'SJD DO COMANDO DE POLICIAMENTO' },
                    ],
                    template: (dados, proc) => `
                        ${proc.nome.toUpperCase()}
                        
                        SINDICANTE: ${dados.sindicante_nome || '____________________'}
                        SINDICADO: ${dados.sindicado_nome || '____________________'}
                        OFENDIDO: POLÍCIA MILITAR DO ESTADO DO AMAZONAS
                        
                        
                        A U T U A Ç Ã O
                        
                        Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta cidade de Manaus, Estado do Amazonas, na sala da ${dados.local_quartel || '____________________'}, autuo a Portaria nº ${dados.numero_portaria || '__________'}, datada de ${dados.data_portaria || '__________'}, e demais documentos que a este junto, do que para constar, lavro o presente termo. Eu, ${dados.sindicante_nome || '____________________'}, Sindicante que o digitei e assino.
                        
                        __________________________________
                        ${dados.sindicante_nome || '____________________'}
                        Sindicante
                        
                        
                        TERMO DE ABERTURA
                        
                        Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta cidade de Manaus, Estado do Amazonas, na ${dados.local_quartel || '____________________'}, dei início à presente ${proc.nome.toUpperCase()}, tendo como objeto: ${dados.objeto_apuracao || '____________________'}. Do que para constar lavro o presente Termo que o escrevi e assino.
                        
                        __________________________________
                        ${dados.sindicante_nome || '____________________'}
                        Sindicante
                    `
                },
                termoOitiva: this.modeloTermoOitiva(), 
                designacaoEscrivao: this.modeloDesignacaoEscrivao('SD'),
                prorrogacao: this.modeloProrrogacao('SD'),
                encaminhamento: this.modeloEncaminhamento()
              }
            },
            
            // --- SINDICÂNCIA INVESTIGATIVA (SI) ---
            SI: {
                nome: "SINDICÂNCIA INVESTIGATIVA",
                documentos: {
                    termoAbertura: {
                         titulo: "Termo de Abertura e Autuação",
                         // Campos iguais ao SD, mas com valores padrão SI
                         campos: [
                            { id: 'numero_portaria', label: 'Nº da Portaria (Instauração)', tipo: 'text', placeholder: 'Ex: 05.02/2024/SIND/SJD/CPA OESTE/PMAM', valorPadrao: 'XX.XX/AAAA/SI/SJD/PMAM' },
                            { id: 'data_portaria', label: 'Data da Portaria', tipo: 'text', placeholder: 'Ex: 23 de Julho de 2024', valorPadrao: `${document.getElementById('data_dia').value} de ${document.getElementById('data_mes').value} de ${document.getElementById('data_ano').value}` },
                            { id: 'sindicado_nome', label: 'Nome, Posto/Grad e CI do Sindicado', tipo: 'text', placeholder: 'Ex: CAP QOPM Stanley O. De Araújo (CI 20943)', valorPadrao: 'NOME DO MILITAR (POSTO/GRAD CI XXXX) - SE HOUVER' },
                            { id: 'sindicante_nome', label: 'Nome, Posto/Grad e CI do Sindicante', tipo: 'text', placeholder: 'Ex: MAJ QOPM Olavo P. Da Silva Filho (CI 15000)', valorPadrao: 'NOME DO MILITAR (POSTO/GRAD CI XXXX)' },
                            { id: 'objeto_apuracao', label: 'Objeto da Apuração (Sucinto)', tipo: 'textarea', placeholder: 'Ex: Apurar a suposta prática de crime militar de Lesão Corporal...', valorPadrao: 'APURAR A SUPOSTA INFRAÇÃO PENAL/CRIMINAL PRATICADA POR MILITAR...' },
                            { id: 'local_quartel', label: 'Local do Quartel/Unidade', tipo: 'text', placeholder: 'Ex: Quartel do CPA OESTE', valorPadrao: 'SJD DO COMANDO DE POLICIAMENTO' },
                        ],
                        template: (dados, proc) => this.procedimentos.SD.documentos.termoAbertura.template(dados, proc)
                    },
                    termoOitiva: this.modeloTermoOitiva(), 
                    prorrogacao: this.modeloProrrogacao('SI'),
                    encaminhamento: this.modeloEncaminhamento()
                }
            },

            // --- INQUÉRITO POLICIAL MILITAR (IPM) ---
            IPM: {
                nome: "INQUÉRITO POLICIAL MILITAR",
                documentos: {
                    termoOitiva: this.modeloTermoOitiva(), 
                    designacaoEscrivao: this.modeloDesignacaoEscrivao('IPM'),
                    prorrogacao: this.modeloProrrogacao('IPM'),
                    encaminhamento: this.modeloEncaminhamento()
                }
            },
            
            // --- PROCESSO ADM. DISCIPLINAR (PAD) ---
            PAD: {
                nome: "PROCESSO ADMINISTRATIVO DISCIPLINAR",
                documentos: {
                    termoOitiva: this.modeloTermoOitiva(), 
                    prorrogacao: this.modeloProrrogacao('PAD'),
                    encaminhamento: this.modeloEncaminhamento()
                }
            },
            
            // --- PROCEDIMENTO DE REVISÃO EX-OFFICIO (PARE) ---
            PARE: {
                nome: "PROCEDIMENTO DE REVISÃO EX-OFFICIO",
                documentos: {
                    termoOitiva: this.modeloTermoOitiva(), 
                    encaminhamento: this.modeloEncaminhamento()
                }
            }
          };
        }
        
        // --- MODELO REUTILIZÁVEL: TERMO DE OITIVA (Refatorado) ---
        modeloTermoOitiva() {
            return {
                titulo: "Termo de Oitiva",
                campos: [
                    { id: 'tipo_oitiva', label: 'Tipo da Oitiva (Declarante/Acusado)', tipo: 'select', 
                      opcoes: [
                          'DECLARAÇÃO DO OFENDIDO', 
                          'DECLARAÇÃO DE TESTEMUNHA', 
                          'INTERROGATÓRIO DO ACUSADO/SINDICADO'
                      ], 
                      valorPadrao: 'DECLARAÇÃO DE TESTEMUNHA' 
                    },
                    // Dados do Encarregado
                    { id: 'encarregado_nome', label: 'Nome e Posto/Grad do Encarregado', tipo: 'text', valorPadrao: 'MAJ QOPM FULANO DA SILVA (CI XXXX)' },
                    { id: 'procedimento_numero', label: 'Nº do Procedimento (Portaria/Instrução)', tipo: 'text', valorPadrao: 'XX.XX/AAAA/PROCEDIMENTO/PMAM' },

                    // Dados do Declarante
                    { id: 'declarante_nome', label: 'Nome Completo', tipo: 'text', placeholder: 'Nome e Qualificação', valorPadrao: 'NOME COMPLETO E QUALIFICAÇÃO' },
                    { id: 'declarante_cpf', label: 'CPF', tipo: 'text', placeholder: 'Apenas números' },
                    { id: 'declarante_identidade', label: 'Identidade (RG)', tipo: 'text', placeholder: 'RG e Órgão Emissor' },
                    { id: 'declarante_filiacao', label: 'Filiação (Mãe e Pai)', tipo: 'text', placeholder: 'Nome da Mãe e do Pai' },
                    { id: 'declarante_endereco', label: 'Endereço Completo', tipo: 'textarea', placeholder: 'Rua, Número, Bairro, Cidade/UF' },

                    // Local do depoimento
                    { id: 'local_oitiva', label: 'Local da Oitiva (Sala/Unidade)', tipo: 'text', placeholder: 'Ex: SJD do Comando de Policiamento Leste', valorPadrao: 'SJD DO COMANDO DE POLICIAMENTO' },
                    
                    // Descrição do Fato/Depoimento
                    { id: 'depoimento_livre', label: 'DESCREVA: Narração dos Fatos/Perguntas e Respostas', tipo: 'textarea', placeholder: 'O Declarante disse que... (Perguntas e Respostas em tópicos)', valorPadrao: 'O DECLARANTE INICIA SUA OITIVA (DEPOIMENTO LIVRE):\n\nPERGUNTA: [P1]\nRESPOSTA: [R1]\n\nPERGUNTA: [P2]\nRESPOSTA: [R2]' },
                ],
                // Template ajustado para o tipo de oitiva
                template: (dados, proc) => {
                    const tipoOitiva = dados.tipo_oitiva || 'DECLARAÇÃO DE TESTEMUNHA';
                    const oitivaCapitalizada = tipoOitiva.toUpperCase().replace(/DO |DE /g, 'DE ');
                    const termoAssinatura = tipoOitiva.includes('ACUSADO') ? 'Interrogado/Acusado' : 
                                            tipoOitiva.includes('OFENDIDO') ? 'Declarante/Ofendido' : 'Declarante/Testemunha';

                    return `
                        TERMO DE OITIVA - ${oitivaCapitalizada}
                        
                        AUTOS: ${proc.nome.toUpperCase()} (${proc.id}) nº ${dados.procedimento_numero || '__________'}
                        ENCARREGADO: ${dados.encarregado_nome || '____________________'}
                        
                        
                        ${termoAssinatura.toUpperCase()}: ${dados.declarante_nome || '____________________'}
                        CPF: ${dados.declarante_cpf || '__________'}
                        IDENTIDADE: ${dados.declarante_identidade || '__________'}
                        FILIAÇÃO: ${dados.declarante_filiacao || '__________'}
                        ENDEREÇO: ${dados.declarante_endereco || '__________'}
                        
                        
                        Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta Cidade de Manaus, Estado do Amazonas, na ${dados.local_oitiva || '____________________'}, perante o Encarregado, presente o Escrivão, foi inquirido o(a) ${termoAssinatura.toLowerCase()} acima qualificado(a), que ao ser perguntado(a) sobre o objeto da apuração, declarou:
                        
                        
                        ${dados.depoimento_livre || '____________________'}
                        
                        
                        Lida e achada conforme, dou por encerrado o presente Termo, que segue assinado pelo Encarregado, pelo Escrivão e pelo ${termoAssinatura}.
                        
                        
                        Manaus-AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.
                        
                        __________________________________
                        ${dados.declarante_nome || '____________________'}
                        ${termoAssinatura}
                        
                        __________________________________
                        [NOME DO ESCRIVÃO (Posto/Grad CI)]
                        Escrivão
                        
                        __________________________________
                        ${dados.encarregado_nome || '____________________'}
                        Encarregado / Sindicante
                    `;
                }
            };
        }

        // --- MODELO REUTILIZÁVEL: DESIGNAÇÃO DE ESCRIVÃO ---
        modeloDesignacaoEscrivao(procId) {
            return {
                titulo: "Termo de Designação de Escrivão",
                campos: [
                    { id: 'sindicante_nome', label: 'Nome e Posto/Grad do Sindicante/Encarregado', tipo: 'text', valorPadrao: 'MAJ QOPM Olavo P. Da Silva Filho (CI 15000)' },
                    { id: 'escrivao_nome', label: 'Nome, Posto/Grad e CI do Militar Designado (Escrivão)', tipo: 'text', valorPadrao: 'SD PM FULANO DE TAL (CI YYYY)' },
                    { id: 'procedimento_numero', label: 'Nº do Procedimento (Portaria/Instrução)', tipo: 'text', valorPadrao: 'XX.XX/AAAA/PROCEDIMENTO/PMAM' },
                ],
                template: (dados, proc) => `
                    TERMO DE DESIGNAÇÃO DE ESCRIVÃO
                    
                    AUTOS: ${proc.nome.toUpperCase()} (${proc.id}) nº ${dados.procedimento_numero || '__________'}
                    ENCARREGADO: ${dados.sindicante_nome || '____________________'}
                    
                    Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, em face da necessidade de dar andamento regular aos trabalhos, eu, ${dados.sindicante_nome || '____________________'}, Encarregado, RESOLVO:
                    
                    DESIGNAR o ${dados.escrivao_nome || '____________________'}, para exercer a função de **Escrivão** no presente ${proc.nome.toUpperCase()} acima referenciado, devendo cumprir todas as determinações legais inerentes ao cargo, conforme a legislação processual militar.
                    
                    Para constar, lavro o presente termo que vai assinado.
                    
                    Quartel em Manaus-AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.
                    
                    __________________________________
                    ${dados.sindicante_nome || '____________________'}
                    Encarregado / Sindicante
                `
            };
        }
        
        // --- MODELO REUTILIZÁVEL: PRORROGAÇÃO DE PRAZO ---
        modeloProrrogacao(procId) {
            let artigoCPPM = (procId === 'IPM') ? "Art. 20, §1º do CPPM (Decreto-Lei nº 1.002/69)" : "Art. 135 da Portaria Normativa nº 001/2019/DJD/PMAM (ou similar)";
            let prazoPadrao = (procId === 'IPM') ? 40 : 30;
            let prazoSolicitadoPadrao = (procId === 'IPM') ? 20 : 20;

            return {
                titulo: "Ofício de Pedido de Prorrogação de Prazo",
                campos: [
                    { id: 'destinatario_posto', label: 'Posto/Grad do Destinatário', tipo: 'text', valorPadrao: 'EXMO. SR. CEL. QOPM' },
                    { id: 'destinatario_cargo', label: 'Cargo do Destinatário (Autoridade Superior)', tipo: 'text', valorPadrao: 'COMANDANTE DO CPA OESTE' },
                    { id: 'sindicante_nome', label: 'Nome, Posto/Grad e CI do Encarregado/Sindicante', tipo: 'text', valorPadrao: 'MAJ QOPM FULANO DA SILVA (CI XXXX)' },
                    { id: 'procedimento_numero', label: 'Nº do Procedimento (Portaria/Instrução)', tipo: 'text', valorPadrao: 'XX.XX/AAAA/PROCEDIMENTO/PMAM' },
                    { id: 'prazo_atual', label: 'Prazo Anterior (em dias)', tipo: 'number', valorPadrao: prazoPadrao },
                    { id: 'prazo_solicitado', label: 'Novo Prazo Solicitado (em dias)', tipo: 'number', valorPadrao: prazoSolicitadoPadrao },
                    { id: 'justificativa', label: 'Justificativa Detalhada da Prorrogação', tipo: 'textarea', placeholder: 'Ex: Necessidade de oitiva de novas testemunhas e realização de perícia técnica que ainda não foi concluída...', valorPadrao: 'Em razão da complexidade da apuração, e da necessidade de realização de diligências imprescindíveis (oitiva de XXX e análise de documentos YYY), cujo prazo se esgota no dia [Data], e que demandam tempo para conclusão.' },
                ],
                template: (dados, proc) => `
                    OFÍCIO Nº XXX/${dados.data_ano || 'AAAA'}/${proc.id} - Quartel em Manaus/AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.
                    
                    Ao ${dados.destinatario_posto || '____________________'} ${dados.destinatario_cargo || '____________________'}
                    
                    Assunto: Solicita Prorrogação de Prazo para Conclusão de ${proc.nome.toUpperCase()} (${proc.id})
                    
                    Senhor Comandante/Diretor,
                    
                    Em cumprimento à Portaria de Instauração nº ${dados.procedimento_numero || '__________'}, o Sindicante/Encarregado ${dados.sindicante_nome || '____________________'} vem, respeitosamente, solicitar a Prorrogação do Prazo Legal para conclusão do procedimento em epígrafe.
                    
                    O prazo anterior de ${dados.prazo_atual || 'XX'} dias se esgota em [Data de Vencimento], sendo solicitado um prazo adicional de **${dados.prazo_solicitado || 'XX'} ( ${dados.prazo_solicitado || 'XX'} )** dias, com base no **${artigoCPPM}**.
                    
                    A prorrogação é necessária e imprescindível, conforme justificativa abaixo:
                    
                    **JUSTIFICATIVA:**
                    
                    ${dados.justificativa || '____________________'}
                    
                    Em anexo, segue os autos para apreciação e decisão.
                    
                    Atenciosamente,
                    
                    __________________________________
                    ${dados.sindicante_nome || '____________________'}
                    Encarregado / Sindicante
                `
            };
        }

        // --- MODELO REUTILIZÁVEL: OFÍCIO DE ENCAMINHAMENTO ---
        modeloEncaminhamento() {
            return { 
                titulo: "Ofício de Encaminhamento de Autos", 
                campos: [
                    { id: 'destinatario_posto', label: 'Posto/Grad do Destinatário', tipo: 'text', valorPadrao: 'EXMO. SR. CEL. QOPM' },
                    { id: 'destinatario_cargo', label: 'Cargo do Destinatário', tipo: 'text', valorPadrao: 'COMANDANTE GERAL DA PMAM' },
                    { id: 'remetente_posto', label: 'Posto/Grad do Remetente', tipo: 'text', valorPadrao: 'MAJ QOPM' },
                    { id: 'remetente_cargo', label: 'Cargo do Remetente', tipo: 'text', valorPadrao: 'SINDICANTE/ENCARREGADO' },
                    { id: 'assunto', label: 'Assunto do Ofício', tipo: 'text', valorPadrao: 'ENCAMINHAMENTO DE AUTOS' },
                    { id: 'referencia', label: 'Referência (Portaria ou N° do Procedimento)', tipo: 'text', valorPadrao: 'Portaria nº XX.XX/AAAA/PROCEDIMENTO/PMAM' },
                    { id: 'conteudo', label: 'Conteúdo do Ofício', tipo: 'textarea', placeholder: 'Ex: Tenho a honra de encaminhar os autos do procedimento em epígrafe para a devida análise e solução...', valorPadrao: 'Tenho a honra de encaminhar a Vossa Excelência os autos do procedimento em epígrafe (com XX laudas), devidamente concluídos, para a devida análise e deliberação da Autoridade Competente.' },
                ], 
                template: (dados, proc) => `
                    OFÍCIO Nº XXX/${dados.data_ano || 'AAAA'}/${proc.id} - Quartel em Manaus/AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.
                    
                    Ao ${dados.destinatario_posto || '____________________'} ${dados.destinatario_cargo || '____________________'}
                    
                    Assunto: ${dados.assunto || '____________________'} - Ref.: ${dados.referencia || '____________________'}
                    
                    Senhor Comandante/Diretor,
                    
                    ${dados.conteudo || '____________________'}
                    
                    Atenciosamente,
                    
                    __________________________________
                    ${dados.remetente_posto || '____________________'}
                    ${dados.remetente_cargo || '____________________'}
                ` 
            };
        }


        // === 2. LÓGICA DE INTERFACE E FORMULÁRIO ===
        
        toggleSidebar() {
            this.sidebar.classList.toggle('open');
            document.body.classList.toggle('overflow-hidden');
        }

        criarCampoHTML(campo) {
            const div = document.createElement('div');
            div.className = 'mb-4';
            let inputElement;

            const inputClasses = 'w-full p-3 border border-gray-300 rounded-lg box-border text-base transition-all focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30';

            if (campo.tipo === 'textarea') {
                inputElement = `<textarea id="${campo.id}" name="${campo.id}" rows="4" placeholder="${campo.placeholder || ''}" class="${inputClasses} resize-y"></textarea>`;
            } else if (campo.tipo === 'select' && campo.opcoes) {
                const opcoesHTML = campo.opcoes.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                inputElement = `<select id="${campo.id}" name="${campo.id}" class="${inputClasses}">${opcoesHTML}</select>`;
            } else {
                inputElement = `<input type="${campo.tipo}" id="${campo.id}" name="${campo.id}" placeholder="${campo.placeholder || ''}" class="${inputClasses}" ${campo.tipo === 'number' ? `min="${campo.min || ''}" max="${campo.max || ''}"` : ''}>`;
            }

            div.innerHTML = `
                <label for="${campo.id}" class="block mb-2 font-semibold text-pmam-secondary">${campo.label}:</label>
                ${inputElement}
            `;
            
            const element = div.querySelector(`#${campo.id}`);
            if (element && campo.valorPadrao !== undefined) {
                element.value = campo.valorPadrao;
            }

            return div;
        }

        carregarProcedimento(procedimentoId) {
            this.procedimentoAtualId = procedimentoId;
            this.modeloAtualId = null; 
            const proc = this.procedimentos[procedimentoId];
            
            if (proc) {
                // Atualiza o menu lateral (Sidebar)
                let menuHTML = '';
                for (const [modeloId, modelo] of Object.entries(proc.documentos)) {
                    menuHTML += `
                        <a href="#" class="sidebar-item block py-4 px-5 mx-2 my-1 rounded-pmam-lg text-pmam-card text-sm transition-all" onclick="sistema.carregarModelo('${modeloId}')">
                            <i class="${this.getIcone(modeloId)} mr-2"></i> ${modelo.titulo}
                        </a>
                    `;
                }
                this.menuDocumentos.innerHTML = menuHTML;
                
                // Limpa e atualiza o conteúdo principal
                this.tituloDocumento.innerHTML = `<i class="fas fa-file-invoice mr-2"></i> Documentos: ${proc.nome}`;
                this.descricaoDocumento.textContent = `Selecione um documento abaixo para gerar o modelo para o procedimento de ${proc.nome}.`;
                this.camposContainer.innerHTML = '<div class="md:col-span-2 text-center py-10 text-pmam-secondary">Selecione um tipo de documento no menu lateral.</div>';
                this.previewArea.textContent = '... O documento será renderizado aqui ...';

                // Se houver sidebar aberta no mobile, fecha.
                if (window.innerWidth < 768 && this.sidebar.classList.contains('open')) {
                    this.toggleSidebar();
                }

            } else {
                 this.menuDocumentos.innerHTML = '<p class="text-white/70 text-center text-sm px-5">Escolha o tipo de Procedimento no campo ao lado.</p>';
            }
        }
        
        carregarModelo(modeloId) {
          if (!this.procedimentoAtualId) {
              this.mostrarToast('Selecione primeiro o Tipo de Procedimento.', 'erro');
              return;
          }
            
          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[modeloId];

          if (!modelo) {
            this.mostrarToast('Modelo não encontrado.', 'erro');
            return;
          }
          
          if (window.innerWidth < 768) {
              this.toggleSidebar();
          }

          this.modeloAtualId = modeloId;
          this.tituloDocumento.innerHTML = `<i class="${this.getIcone(modeloId)} mr-2"></i> Gerador de ${modelo.titulo} (${proc.id})`;
          this.descricaoDocumento.textContent = `Preencha os campos abaixo para gerar o ${modelo.titulo} referente à ${proc.nome}.`;
          this.camposContainer.innerHTML = '';
          
          // Tratamento especial para o Termo de Declaração para que a Oitiva seja em tela inteira.
          const isFullWidth = (modeloId === 'termoOitiva');
          this.camposContainer.classList.toggle('md:grid-cols-2', !isFullWidth);
          this.camposContainer.classList.toggle('md:grid-cols-1', isFullWidth);


          modelo.campos.forEach(campo => {
            const campoElement = this.criarCampoHTML(campo);
            
            // Tratamento especial para o campo depoimento_livre (ocupa 2 colunas se houver mais de uma)
            if (campo.id === 'depoimento_livre' && !isFullWidth) {
                 campoElement.classList.add('md:col-span-2');
            }
            
            this.camposContainer.appendChild(campoElement);
          });

          document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('ativo'));
          document.querySelector(`[onclick="sistema.carregarModelo('${modeloId}')"]`).classList.add('ativo');

          this.atualizarPreview();
        }

        getIcone(modeloId) {
            switch(modeloId) {
                case 'termoAbertura': return 'fas fa-file-alt';
                case 'termoOitiva': return 'fas fa-microphone-alt';
                case 'designacaoEscrivao': return 'fas fa-user-tie';
                case 'prorrogacao': return 'fas fa-clock';
                case 'encaminhamento': return 'fas fa-share-square';
                default: return 'fas fa-file';
            }
        }
        
        obterDados() {
            const dados = {};
            const formElements = this.form.querySelectorAll('input, textarea, select'); 
            formElements.forEach(element => {
                if (element.name) {
                    dados[element.name] = element.value.trim().toUpperCase(); 
                }
            });
            
            // Exceção para o conteúdo do depoimento (permite letras minúsculas e pontuação normal)
            const depoimentoElement = this.form.querySelector('#depoimento_livre');
            if (depoimentoElement) {
                 dados.depoimento_livre = depoimentoElement.value.trim();
            }
            
            // Exceção para o tipo de oitiva (para não ficar tudo em maiúsculo no template, mas sim na saída)
            const tipoOitivaElement = this.form.querySelector('#tipo_oitiva');
            if (tipoOitivaElement) {
                 dados.tipo_oitiva = tipoOitivaElement.value.trim();
            }


            // O nome do mês deve ser formatado corretamente (título)
            if (dados.data_mes) {
                 dados.data_mes = dados.data_mes.charAt(0) + dados.data_mes.slice(1).toLowerCase();
            }
            return dados;
        }

        atualizarPreview() {
          if (!this.modeloAtualId || !this.procedimentoAtualId) return;

          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[this.modeloAtualId];

          if (modelo && modelo.template) {
            const dados = this.obterDados();
            this.previewArea.textContent = modelo.template(dados, proc).trim(); // Passa proc para o template
          }
        }

        // === 3. FUNÇÕES DE AÇÃO ===

        gerarPDF() {
          if (!this.modeloAtualId || !this.procedimentoAtualId) {
            this.mostrarToast('Selecione um documento para gerar o PDF.', 'erro');
            return;
          }

          const dados = this.obterDados();
          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[this.modeloAtualId];
          
          const nomeArquivo = `${proc.id}_${modelo.titulo.replace(/\s/g, '_').replace(/\//g, '')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
          const conteudo = modelo.template(dados, proc);

          try {
            const doc = new jsPDF({ unit: 'mm', format: 'a4' });
            const margem = 20;
            const larguraMax = 210 - 2 * margem; 
            
            doc.setFont('times'); 
            doc.setFontSize(12);

            // Adiciona o conteúdo com quebra de linha automática
            const linhas = doc.splitTextToSize(conteudo, larguraMax);
            let y = margem;

            // Título (Centralizado e Negrito)
            const tituloCompleto = `${proc.nome.toUpperCase()} - ${modelo.titulo.toUpperCase()}`;
            const tituloLinhas = doc.splitTextToSize(tituloCompleto, larguraMax);
            doc.setFont(doc.getFont().fontName, 'bold');
            doc.text(tituloLinhas, 105, y, { align: 'center' });
            y += tituloLinhas.length * 6; 

            doc.setFont(doc.getFont().fontName, 'normal'); 
            y += 5; 

            // Itera sobre as linhas do conteúdo para adicionar ao PDF
            linhas.forEach(line => {
                // Checagem de quebra de página
                if (y > 280) { 
                    doc.addPage();
                    y = margem;
                }
                doc.text(line, margem, y);
                y += 5; 
            });

            doc.save(nomeArquivo);
            this.mostrarToast('PDF gerado com sucesso!', 'sucesso');

          } catch (e) {
            console.error('Erro ao gerar PDF:', e);
            this.mostrarToast('Erro ao gerar PDF. Verifique o console.', 'erro');
          }
        }

        async copiarTexto() {
          const texto = this.previewArea.textContent;
          try {
            await navigator.clipboard.writeText(texto);
            this.mostrarToast('Texto do documento copiado!', 'sucesso');
          } catch (err) {
            console.error('Erro ao copiar texto:', err);
            this.mostrarToast('Erro ao copiar. Use Ctrl+C / Cmd+C.', 'erro');
          }
        }

        mostrarToast(mensagem, tipo = 'info') {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          let iconeClass = '';

          if (tipo === 'sucesso') {
            iconeClass = 'fas fa-check-circle';
            toast.className = `toast bg-pmam-success text-pmam-card min-w-64 p-4 rounded-pmam-lg shadow-pmam-xl mb-3 opacity-0 transform translate-x-full flex items-center`;
          } else if (tipo === 'erro') {
            iconeClass = 'fas fa-times-circle';
            toast.className = `toast bg-pmam-error text-pmam-card min-w-64 p-4 rounded-pmam-lg shadow-pmam-xl mb-3 opacity-0 transform translate-x-full flex items-center`;
          } else if (tipo === 'info') {
            iconeClass = 'fas fa-info-circle';
            toast.className = `toast bg-pmam-blue text-pmam-card min-w-64 p-4 rounded-pmam-lg shadow-pmam-xl mb-3 opacity-0 transform translate-x-full flex items-center`;
          }

          toast.innerHTML = `<i class="${iconeClass} mr-3 text-lg"></i> <span>${mensagem}</span>`;
          container.appendChild(toast);

          // Animação para mostrar
          setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-x-full');
          }, 10);

          // Animação para remover
          setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => {
              container.removeChild(toast);
            }, 300); 
          }, 3000);
        }
      }

      // Inicializar o sistema ao carregar a página
      let sistema;
      document.addEventListener('DOMContentLoaded', () => {
        sistema = new SistemaPMAM();
      });
    </script>
  </body>
</html>
