<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Procedimentos - PMAM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'pmam-blue': '#1e3a8a',
              'pmam-lightBlue': '#3b82f6',
              'pmam-accent': '#0ea5e9',
              'pmam-success': '#10b981',
              'pmam-error': '#ef4444',
              'pmam-secondary': '#64748b',
              'pmam-bg': '#f8fafc',
              'pmam-card': '#ffffff',
            },
            boxShadow: {
              'pmam-xl': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
            },
            borderRadius: {
              'pmam-lg': '8px',
            }
          }
        }
      }
    </script>
    
    <style>
      .sidebar {
        transform: translateX(0);
        transition: transform 0.3s ease-in-out;
      }
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          left: 0;
          height: 100%;
          z-index: 20;
          transform: translateX(-100%);
        }
        .sidebar.open {
          transform: translateX(0);
        }
      }

      .sidebar-item:hover, .sidebar-item.ativo {
        background-color: #0ea5e9;
        color: #ffffff;
        font-weight: 600;
      }
      
      #preview-documento {
        white-space: pre-wrap;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        color: #1e293b;
        border: 1px solid #e2e8f0;
        min-height: 200px;
        background-color: #f8fafc;
        line-height: 1.6;
      }
      
      .toast {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }
    </style>
  </head>
  
  <body class="bg-pmam-bg text-slate-800 antialiased min-h-screen flex">
    
    <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-30 p-2 bg-pmam-blue text-pmam-card rounded-md shadow-lg">
        <i class="fas fa-bars"></i>
    </button>

    <div id="sidebar" class="sidebar w-64 bg-pmam-blue text-pmam-card py-5 shadow-pmam-xl z-10 flex-shrink-0">
      <h2 class="text-center mb-7 text-2xl border-b border-white/10 pb-4 font-semibold">
        <i class="fas fa-shield-alt mr-2"></i> PMAM SJD
      </h2>
      
      <div id="menu-procedimentos" class="px-5 text-center text-sm mb-4">
          <p class="text-white/70 mb-2">Procedimento Atual:</p>
          <p id="proc-atual-nome" class="text-white font-semibold text-base">Nenhum</p>
      </div>

      <div id="menu-documentos" class="mt-5 border-t border-white/10 pt-4">
        <p class="text-white/70 text-center text-sm px-5">Escolha o tipo de Procedimento no campo principal.</p>
      </div>
      
    </div>

    <div class="main-content flex-grow p-5 md:p-10">
      <div class="card bg-pmam-card p-5 md:p-8 rounded-pmam-lg shadow-pmam-xl">
        <h1 id="titulo-documento" class="text-pmam-blue mb-5 text-2xl md:text-3xl border-b-2 border-pmam-accent pb-3 font-semibold">
          <i class="fas fa-file-contract mr-2"></i> Sistema de Procedimentos - PMAM
        </h1>
        <p class="mb-5 text-gray-600" id="descricao-documento">Selecione o tipo de Procedimento para carregar os documentos adequados.</p>
        
        <div id="selecao-procedimento" class="mb-6 pb-4 border-b border-gray-200">
            <label for="procedimento-select" class="block mb-2 font-semibold text-pmam-blue text-lg">
              <i class="fas fa-folder-open mr-2"></i> Tipo de Procedimento:
            </label>
            <select id="procedimento-select" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" onchange="sistema.carregarProcedimento(this.value)">
                <option value="" disabled selected>-- Selecione o Tipo de Procedimento --</option>
                <option value="SD">Sindicância Disciplinar (SD)</option>
                <option value="SI">Sindicância Investigativa (SI)</option>
                <option value="IPM">Inquérito Policial Militar (IPM)</option>
                <option value="PAD">Processo Administrativo Disciplinar (PAD)</option>
                <option value="PARE">Procedimento de Ressarcimento (PARE)</option>
            </select>
        </div>
        
        <form id="form-documento">
          
          <div id="campos-dinamicos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2 text-center py-10 text-pmam-secondary">
              <i class="fas fa-arrow-up text-4xl mb-3 text-pmam-accent"></i>
              <p>Selecione um Procedimento acima para iniciar.</p>
            </div>
          </div>

          <div class="mt-8 pt-4 border-t border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="form-group">
                <label for="data_dia" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Dia):</label>
                <input type="number" id="data_dia" name="data_dia" min="1" max="31" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
            <div class="form-group">
                <label for="data_mes" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Mês):</label>
                <input type="text" id="data_mes" name="data_mes" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
            <div class="form-group">
                <label for="data_ano" class="block mb-2 font-semibold text-pmam-blue">Data Atual (Ano):</label>
                <input type="number" id="data_ano" name="data_ano" min="2000" max="2100" class="w-full p-3 border border-gray-300 rounded-lg focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30" required>
            </div>
          </div>

          <div class="form-group mt-6">
            <label class="block mb-2 font-semibold text-pmam-blue border-b-2 border-pmam-lightBlue pb-1">
              <i class="fas fa-eye mr-2"></i> Pré-visualização do Documento:
            </label>
            <div id="preview-documento" class="p-5 mt-2 rounded-lg shadow-inner">
              ... O documento será renderizado aqui ...
            </div>
          </div>

          <div class="botoes-acao flex flex-wrap gap-4 mt-8">
            <button type="button" class="btn btn-primario bg-pmam-lightBlue text-pmam-card py-3 px-6 rounded-md cursor-pointer font-semibold transition-all hover:bg-pmam-accent hover:shadow-lg hover:shadow-pmam-accent/50 hover:-translate-y-0.5 flex items-center justify-center" onclick="sistema.gerarPDF()">
              <i class="fas fa-file-pdf mr-2"></i> Gerar PDF
            </button>
            <button type="button" class="btn btn-secundario bg-pmam-secondary text-pmam-card py-3 px-6 rounded-md cursor-pointer font-semibold transition-all hover:bg-gray-700 hover:shadow-lg hover:shadow-pmam-secondary/50 hover:-translate-y-0.5 flex items-center justify-center" onclick="sistema.copiarTexto()">
              <i class="fas fa-copy mr-2"></i> Copiar Texto
            </button>
          </div>
        </form>
      </div>
    </div>

    <div class="toast-container fixed top-5 right-5 z-50" id="toast-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      const { jsPDF } = window.jspdf;

      const obterNomeMes = (numero) => {
          const meses = [
              'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
          ];
          return meses[numero - 1];
      };

      class SistemaProcedimentosPMAM {
        constructor() {
          this.procedimentos = this.definirModelos();
          this.camposContainer = document.getElementById('campos-dinamicos');
          this.previewArea = document.getElementById('preview-documento');
          this.form = document.getElementById('form-documento');
          this.tituloDocumento = document.getElementById('titulo-documento');
          this.descricaoDocumento = document.getElementById('descricao-documento');
          this.menuDocumentos = document.getElementById('menu-documentos');
          this.procAtualNome = document.getElementById('proc-atual-nome');
          this.sidebar = document.getElementById('sidebar');
          this.toggleButton = document.getElementById('sidebar-toggle');
          
          this.procedimentoAtualId = null;
          this.modeloAtualId = null;
          
          const hoje = new Date();
          document.getElementById('data_dia').value = hoje.getDate();
          document.getElementById('data_mes').value = obterNomeMes(hoje.getMonth() + 1);
          document.getElementById('data_ano').value = hoje.getFullYear();
          
          this.form.addEventListener('input', () => this.atualizarPreview());
          this.toggleButton.addEventListener('click', () => this.toggleSidebar());
        }
        
        modeloAutuacaoAbertura(procId) {
            const proc = this.procedimentos[procId];
            const isPARE = procId === 'PARE';
            
            return {
                titulo: "AUTUAÇÃO, ABERTURA E DESIGNAÇÃO DE ESCRIVÃO",
                campos: [
                    { id: 'numero_portaria', label: 'Nº da Portaria (Instauração)', tipo: 'text', placeholder: `Ex: 05.02/2024/${procId}/SJD/PMAM`, valorPadrao: `XX.XX/AAAA/${procId}/SJD/PMAM` },
                    { id: 'data_portaria', label: 'Data da Portaria (por extenso)', tipo: 'text', placeholder: 'Ex: 23 de Julho de 2024', valorPadrao: '' },
                    { id: 'sindicado_nome', label: `Nome, Posto/Grad e CI do Militar ${isPARE ? 'Responsável' : 'Acusado/Sindicado'}`, tipo: 'text', placeholder: 'Ex: SD QPPM JOSÉ DE RIBAMAR FERREIRA (CI 25774)', valorPadrao: '' },
                    { id: 'sindicante_nome', label: `Nome, Posto/Grad e CI do ${isPARE ? 'Encarregado' : 'Encarregado/Sindicante'}`, tipo: 'text', placeholder: 'Ex: CAP QOPM ELSON PEREIRA DE FARIAS (CI 22826)', valorPadrao: '' },
                    { id: 'escrivao_nome', label: 'Nome, Posto/Grad e CI do Escrivão', tipo: 'text', placeholder: 'Ex: SD PM JOÃO DA SILVA (CI 12345)', valorPadrao: '' },
                    { id: 'objeto_apuracao', label: `Objeto da Apuração ${isPARE ? '(Ressarcimento)' : ''}`, tipo: 'textarea', placeholder: isPARE ? 'Ex: APURAR A RESPONSABILIDADE CIVIL QUANTO AO PREJUÍZO À FAZENDA PÚBLICA DECORRENTE DE EXTRAVIO DE 01 COLETE BALÍSTICO' : 'Ex: APURAR A SUPOSTA TRANSGRESSÃO DISCIPLINAR...', valorPadrao: '' },
                    { id: 'local_quartel', label: 'Local do Quartel/Unidade', tipo: 'text', placeholder: 'Ex: Sala da SJD do CPA LESTE', valorPadrao: 'SALA DA SJD DO COMANDO DE POLICIAMENTO' },
                ],
                template: (dados) => {
                    const titulo = isPARE ? 'RESPONSÁVEL' : 'ACUSADO/SINDICADO';
                    const ofendido = isPARE ? 'FAZENDA PÚBLICA DO ESTADO DO AMAZONAS' : 'POLÍCIA MILITAR DO ESTADO DO AMAZONAS';
                    
                    return `${proc.nome.toUpperCase()}

ENCARREGADO: ${dados.sindicante_nome || '____________________'}
${titulo}: ${dados.sindicado_nome || '____________________'}
OFENDIDO: ${ofendido}


AUTUAÇÃO

Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta cidade de Manaus, Capital do Estado do Amazonas, na ${dados.local_quartel || '____________________'}, autuo a Portaria nº ${dados.numero_portaria || '__________'}, datada de ${dados.data_portaria || '__________'}, e demais documentos que a esta se juntam, do que para constar, lavro o presente termo. Eu, ${dados.sindicante_nome || '____________________'}, Encarregado, que o digitei e assino.


__________________________________
${dados.sindicante_nome || '____________________'}
Encarregado


TERMO DE ABERTURA

Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta cidade de Manaus, Capital do Estado do Amazonas, na ${dados.local_quartel || '____________________'}, dei início ao presente ${proc.nome.toUpperCase()}, tendo como objeto: ${dados.objeto_apuracao || '____________________'}. Do que para constar lavro o presente Termo, que escrevi e assino.


__________________________________
${dados.sindicante_nome || '____________________'}
Encarregado


TERMO DE DESIGNAÇÃO DE ESCRIVÃO

Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, eu, ${dados.sindicante_nome || '____________________'}, Encarregado nomeado pela Portaria nº ${dados.numero_portaria || '__________'}, RESOLVO:

DESIGNAR o ${dados.escrivao_nome || '____________________'}, para exercer a função de ESCRIVÃO no presente ${proc.nome.toUpperCase()}, devendo cumprir todas as determinações legais inerentes ao cargo.

Para constar, lavro o presente termo que vai assinado.


__________________________________
${dados.sindicante_nome || '____________________'}
Encarregado`;
                }
            };
        }

        modeloTermoDeclaracao() {
            return {
                titulo: "TERMO DE DECLARAÇÃO",
                campos: [
                    { id: 'tipo_declaracao', label: 'Tipo da Declaração', tipo: 'select', 
                      opcoes: [
                          'DECLARAÇÃO DO OFENDIDO/VÍTIMA', 
                          'DECLARAÇÃO DA TESTEMUNHA', 
                          'INTERROGATÓRIO DO ACUSADO/SINDICADO'
                      ], 
                      valorPadrao: 'DECLARAÇÃO DA TESTEMUNHA' 
                    },
                    { id: 'encarregado_nome', label: 'Nome, Posto/Grad e CI do Encarregado', tipo: 'text', valorPadrao: '' },
                    { id: 'escrivao_nome_termo', label: 'Nome, Posto/Grad e CI do Escrivão', tipo: 'text', valorPadrao: '' },
                    { id: 'procedimento_numero', label: 'Nº do Procedimento (Portaria)', tipo: 'text', placeholder: 'Ex: 05.02/2024/SD/SJD/PMAM', valorPadrao: '' },
                    { id: 'declarante_nome', label: 'Nome Completo do Declarante', tipo: 'text', placeholder: 'Nome completo', valorPadrao: '' },
                    { id: 'declarante_qualificacao', label: 'Posto/Grad e CI (se militar) ou Profissão', tipo: 'text', placeholder: 'Ex: SD QPPM CI 12345 ou Professor', valorPadrao: '' },
                    { id: 'declarante_cpf', label: 'CPF', tipo: 'text', placeholder: 'Apenas números', valorPadrao: '' },
                    { id: 'declarante_identidade', label: 'Identidade (RG)', tipo: 'text', placeholder: 'RG e Órgão Emissor', valorPadrao: '' },
                    { id: 'declarante_filiacao', label: 'Filiação (Mãe e Pai)', tipo: 'text', placeholder: 'Nome da Mãe e do Pai', valorPadrao: '' },
                    { id: 'declarante_nascimento', label: 'Data de Nascimento', tipo: 'text', placeholder: 'Ex: 15/03/1985', valorPadrao: '' },
                    { id: 'declarante_naturalidade', label: 'Naturalidade', tipo: 'text', placeholder: 'Ex: Manaus/AM', valorPadrao: '' },
                    { id: 'declarante_endereco', label: 'Endereço Completo', tipo: 'textarea', placeholder: 'Rua, Número, Bairro, Cidade/UF', valorPadrao: '' },
                    { id: 'local_oitiva', label: 'Local da Oitiva (Sala/Unidade)', tipo: 'text', placeholder: 'Ex: Sala da SJD do CPA LESTE', valorPadrao: 'SALA DA SJD DO COMANDO DE POLICIAMENTO' },
                    { id: 'depoimento_livre', label: 'NARRAÇÃO DOS FATOS / PERGUNTAS E RESPOSTAS', tipo: 'textarea', placeholder: 'Descreva o depoimento livre, seguido de perguntas e respostas...', valorPadrao: '' },
                ],
                template: (dados, proc) => {
                    const tipoDeclaracao = dados.tipo_declaracao || 'DECLARAÇÃO DA TESTEMUNHA';
                    let tipoTermo = '';
                    let qualificacao = '';
                    
                    if (tipoDeclaracao.includes('INTERROGATÓRIO')) {
                        tipoTermo = 'INTERROGATÓRIO DO ACUSADO/SINDICADO';
                        qualificacao = 'INTERROGADO/ACUSADO';
                    } else if (tipoDeclaracao.includes('OFENDIDO')) {
                        tipoTermo = 'DECLARAÇÃO DO OFENDIDO/VÍTIMA';
                        qualificacao = 'DECLARANTE/OFENDIDO';
                    } else {
                        tipoTermo = 'DECLARAÇÃO DA TESTEMUNHA';
                        qualificacao = 'DECLARANTE/TESTEMUNHA';
                    }

                    return `TERMO DE ${tipoTermo}

AUTOS: ${proc.nome.toUpperCase()} nº ${dados.procedimento_numero || '__________'}
ENCARREGADO: ${dados.encarregado_nome || '____________________'}


${qualificacao}: ${dados.declarante_nome || '____________________'}
QUALIFICAÇÃO: ${dados.declarante_qualificacao || '____________________'}
CPF: ${dados.declarante_cpf || '__________'}
IDENTIDADE: ${dados.declarante_identidade || '__________'}
FILIAÇÃO: ${dados.declarante_filiacao || '__________'}
DATA DE NASCIMENTO: ${dados.declarante_nascimento || '__________'}
NATURALIDADE: ${dados.declarante_naturalidade || '__________'}
ENDEREÇO: ${dados.declarante_endereco || '__________'}


Aos ${dados.data_dia || '[Dia]'} dias do mês de ${dados.data_mes || '[Mês]'} do ano de ${dados.data_ano || '[Ano]'}, nesta cidade de Manaus, Capital do Estado do Amazonas, na ${dados.local_oitiva || '____________________'}, perante o Encarregado, presente o Escrivão, foi inquirido(a) o(a) ${qualificacao.toLowerCase()} acima qualificado(a), que, ao ser perguntado(a) sobre os fatos objeto da apuração, declarou:


${dados.depoimento_livre || '____________________'}


Lida e achada conforme, dou por encerrado o presente Termo, que segue assinado pelo Encarregado, pelo Escrivão e pelo(a) ${qualificacao}.


Manaus/AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.


__________________________________
${dados.declarante_nome || '____________________'}
${qualificacao}


__________________________________
${dados.escrivao_nome_termo || '____________________'}
Escrivão


__________________________________
${dados.encarregado_nome || '____________________'}
Encarregado`;
                }
            };
        }

        modeloOficioGenerico() {
            return { 
                titulo: "OFÍCIOS (Diversos)", 
                campos: [
                    { id: 'numero_oficio', label: 'Nº do Ofício', tipo: 'text', placeholder: 'Ex: 123/2024/SD/SJD', valorPadrao: '' },
                    { id: 'destinatario_tratamento', label: 'Tratamento do Destinatário', tipo: 'select',
                      opcoes: ['Excelentíssimo Senhor', 'Senhor', 'Ilustríssimo Senhor'],
                      valorPadrao: 'Excelentíssimo Senhor'
                    },
                    { id: 'destinatario_posto', label: 'Posto/Grad do Destinatário', tipo: 'text', placeholder: 'Ex: CEL QOPM', valorPadrao: '' },
                    { id: 'destinatario_nome', label: 'Nome do Destinatário', tipo: 'text', placeholder: 'Nome completo', valorPadrao: '' },
                    { id: 'destinatario_cargo', label: 'Cargo do Destinatário', tipo: 'text', placeholder: 'Ex: Comandante Geral da PMAM', valorPadrao: '' },
                    { id: 'remetente_posto', label: 'Posto/Grad do Remetente', tipo: 'text', placeholder: 'Ex: MAJ QOPM', valorPadrao: '' },
                    { id: 'remetente_nome', label: 'Nome do Remetente', tipo: 'text', placeholder: 'Nome completo', valorPadrao: '' },
                    { id: 'remetente_cargo', label: 'Cargo do Remetente', tipo: 'text', placeholder: 'Ex: Encarregado', valorPadrao: '' },
                    { id: 'assunto', label: 'Assunto do Ofício', tipo: 'text', placeholder: 'Ex: Solicita Prorrogação de Prazo', valorPadrao: '' },
                    { id: 'referencia', label: 'Referência (Portaria ou Nº do Procedimento)', tipo: 'text', placeholder: 'Ex: Portaria nº 05.02/2024/SD/SJD/PMAM', valorPadrao: '' },
                    { id: 'conteudo', label: 'Conteúdo do Ofício (Corpo do Texto)', tipo: 'textarea', placeholder: 'Detalhe o pedido ou informação...', valorPadrao: '' },
                ], 
                template: (dados, proc) => {
                    const tratamento = dados.destinatario_tratamento || 'Excelentíssimo Senhor';
                    
                    return `OFÍCIO Nº ${dados.numero_oficio || '___/___/___'}

Quartel em Manaus/AM, ${dados.data_dia || '[Dia]'} de ${dados.data_mes || '[Mês]'} de ${dados.data_ano || '[Ano]'}.


Ao ${tratamento}
${dados.destinatario_posto || '____________________'} ${dados.destinatario_nome || '____________________'}
${dados.destinatario_cargo || '____________________'}


Assunto: ${dados.assunto || '____________________'}
Referência: ${dados.referencia || '____________________'}


Senhor ${dados.destinatario_posto || 'Comandante'},


${dados.conteudo || '____________________'}


Respeitosamente,


__________________________________
${dados.remetente_posto || '____________________'} ${dados.remetente_nome || '____________________'}
${dados.remetente_cargo || '____________________'}`;
                } 
            };
        }
        
        definirModelos() {
          return {
            SD: {
              id: "SD",
              nome: "Sindicância Disciplinar",
              sigla: "SD",
              documentos: {
                autuacao: this.modeloAutuacaoAbertura('SD'),
                declaracao: this.modeloTermoDeclaracao(), 
                oficio: this.modeloOficioGenerico()
              }
            },
            
            SI: {
                id: "SI",
                nome: "Sindicância Investigativa",
                sigla: "SI",
                documentos: {
                    autuacao: this.modeloAutuacaoAbertura('SI'),
                    declaracao: this.modeloTermoDeclaracao(), 
                    oficio: this.modeloOficioGenerico()
                }
            },

            IPM: {
                id: "IPM",
                nome: "Inquérito Policial Militar",
                sigla: "IPM",
                documentos: {
                    autuacao: this.modeloAutuacaoAbertura('IPM'),
                    declaracao: this.modeloTermoDeclaracao(), 
                    oficio: this.modeloOficioGenerico()
                }
            },
            
            PAD: {
                id: "PAD",
                nome: "Processo Administrativo Disciplinar",
                sigla: "PAD",
                documentos: {
                    autuacao: this.modeloAutuacaoAbertura('PAD'),
                    declaracao: this.modeloTermoDeclaracao(), 
                    oficio: this.modeloOficioGenerico()
                }
            },
            
            PARE: {
                id: "PARE",
                nome: "Procedimento de Ressarcimento",
                sigla: "PARE",
                documentos: {
                    autuacao: this.modeloAutuacaoAbertura('PARE'),
                    declaracao: this.modeloTermoDeclaracao(), 
                    oficio: this.modeloOficioGenerico()
                }
            }
          };
        }

        toggleSidebar() {
            this.sidebar.classList.toggle('open');
            document.body.classList.toggle('overflow-hidden');
        }

        criarCampoHTML(campo) {
            const div = document.createElement('div');
            div.className = 'mb-4';
            let inputElement;

            const inputClasses = 'w-full p-3 border border-gray-300 rounded-lg box-border text-base transition-all focus:border-pmam-accent focus:outline-none focus:ring-2 focus:ring-pmam-accent/30';

            if (campo.tipo === 'textarea') {
                inputElement = `<textarea id="${campo.id}" name="${campo.id}" rows="5" placeholder="${campo.placeholder || ''}" class="${inputClasses} resize-y">${campo.valorPadrao || ''}</textarea>`;
            } else if (campo.tipo === 'select' && campo.opcoes) {
                const opcoesHTML = campo.opcoes.map(opt => 
                    `<option value="${opt}" ${opt === campo.valorPadrao ? 'selected' : ''}>${opt}</option>`
                ).join('');
                inputElement = `<select id="${campo.id}" name="${campo.id}" class="${inputClasses}">${opcoesHTML}</select>`;
            } else {
                const valor = campo.valorPadrao || '';
                inputElement = `<input type="${campo.tipo}" id="${campo.id}" name="${campo.id}" placeholder="${campo.placeholder || ''}" value="${valor}" class="${inputClasses}" ${campo.tipo === 'number' ? `min="${campo.min || ''}" max="${campo.max || ''}"` : ''}>`;
            }

            div.innerHTML = `
                <label for="${campo.id}" class="block mb-2 font-semibold text-pmam-blue">${campo.label}:</label>
                ${inputElement}
            `;

            return div;
        }

        carregarProcedimento(procedimentoId) {
            this.procedimentoAtualId = procedimentoId;
            this.modeloAtualId = null; 
            const proc = this.procedimentos[procedimentoId];
            
            if (proc) {
                this.procAtualNome.textContent = `${proc.sigla}`;
                
                let menuHTML = '';
                for (const [modeloId, modelo] of Object.entries(proc.documentos)) {
                    menuHTML += `
                        <a href="#" class="sidebar-item block py-4 px-5 mx-2 my-1 rounded-pmam-lg text-pmam-card text-sm transition-all" onclick="sistema.carregarModelo('${modeloId}'); return false;">
                            <i class="${this.getIcone(modeloId)} mr-2"></i> ${modelo.titulo}
                        </a>
                    `;
                }
                this.menuDocumentos.innerHTML = menuHTML;
                
                this.tituloDocumento.innerHTML = `<i class="fas fa-folder-open mr-2"></i> ${proc.nome} (${proc.sigla})`;
                this.descricaoDocumento.textContent = `Selecione um documento no menu lateral para gerar o modelo adequado.`;
                this.camposContainer.innerHTML = `<div class="md:col-span-2 text-center py-10 text-pmam-secondary">
                    <i class="fas fa-hand-point-left text-4xl mb-3 text-pmam-accent"></i>
                    <p>Selecione um tipo de documento no menu lateral.</p>
                </div>`;
                this.previewArea.textContent = '... O documento será renderizado aqui ...';

                if (window.innerWidth < 768 && this.sidebar.classList.contains('open')) {
                    this.toggleSidebar();
                }

            } else {
                 this.menuDocumentos.innerHTML = '<p class="text-white/70 text-center text-sm px-5">Escolha o tipo de Procedimento no campo principal.</p>';
                 this.procAtualNome.textContent = 'Nenhum';
            }
        }
        
        carregarModelo(modeloId) {
          if (!this.procedimentoAtualId) {
              this.mostrarToast('Selecione primeiro o Tipo de Procedimento.', 'erro');
              return;
          }
            
          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[modeloId];

          if (!modelo) {
            this.mostrarToast('Modelo não encontrado.', 'erro');
            return;
          }
          
          if (window.innerWidth < 768) {
              this.toggleSidebar();
          }

          this.modeloAtualId = modeloId;
          this.tituloDocumento.innerHTML = `<i class="${this.getIcone(modeloId)} mr-2"></i> ${modelo.titulo} - ${proc.sigla}`;
          this.descricaoDocumento.textContent = `Preencha os campos abaixo para gerar o documento "${modelo.titulo}" do procedimento ${proc.nome}.`;
          this.camposContainer.innerHTML = '';
          
          const isFullWidth = (modeloId === 'declaracao' || modeloId === 'oficio');
          this.camposContainer.classList.toggle('md:grid-cols-2', !isFullWidth);
          this.camposContainer.classList.toggle('md:grid-cols-1', isFullWidth);

          modelo.campos.forEach(campo => {
            const campoElement = this.criarCampoHTML(campo);
            
            if (campo.id === 'depoimento_livre' || campo.id === 'conteudo' || campo.id === 'objeto_apuracao' || campo.id === 'declarante_endereco') {
                 campoElement.classList.add('md:col-span-2');
            }
            
            this.camposContainer.appendChild(campoElement);
          });

          document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('ativo'));
          const linkAtivo = Array.from(document.querySelectorAll('.sidebar-item')).find(
              link => link.onclick && link.onclick.toString().includes(`carregarModelo('${modeloId}')`)
          );
          if (linkAtivo) linkAtivo.classList.add('ativo');

          this.atualizarPreview();
        }

        getIcone(modeloId) {
            switch(modeloId) {
                case 'autuacao': return 'fas fa-file-alt';
                case 'declaracao': return 'fas fa-microphone-alt';
                case 'oficio': return 'fas fa-envelope';
                default: return 'fas fa-file';
            }
        }
        
        obterDados() {
            const dados = {};
            const formElements = this.form.querySelectorAll('input, textarea, select'); 
            formElements.forEach(element => {
                if (element.name) {
                    let valor = element.value.trim();
                    
                    if (element.id !== 'depoimento_livre' && 
                        element.id !== 'conteudo' && 
                        element.id !== 'tipo_declaracao' &&
                        element.id !== 'destinatario_tratamento' &&
                        element.id !== 'data_mes') {
                        valor = valor.toUpperCase();
                    }
                    
                    dados[element.name] = valor;
                }
            });

            if (dados.data_mes) {
                 dados.data_mes = dados.data_mes.charAt(0).toUpperCase() + dados.data_mes.slice(1).toLowerCase();
            }
            
            return dados;
        }

        atualizarPreview() {
          if (!this.modeloAtualId || !this.procedimentoAtualId) return;

          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[this.modeloAtualId];

          if (modelo && modelo.template) {
            const dados = this.obterDados();
            this.previewArea.textContent = modelo.template(dados, proc).trim();
          }
        }

        gerarPDF() {
          if (!this.modeloAtualId || !this.procedimentoAtualId) {
            this.mostrarToast('Selecione um documento para gerar o PDF.', 'erro');
            return;
          }

          const dados = this.obterDados();
          const proc = this.procedimentos[this.procedimentoAtualId];
          const modelo = proc.documentos[this.modeloAtualId];
          
          const nomeArquivo = `${proc.sigla}_${modelo.titulo.replace(/\s+/g, '_').replace(/[^\w]/g, '')}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
          const conteudo = modelo.template(dados, proc);

          try {
            const doc = new jsPDF({ 
                unit: 'mm', 
                format: 'a4',
                putOnlyUsedFonts: true,
                compress: true
            });
            
            const margem = 20;
            const margemDireita = 20;
            const larguraMax = 210 - margem - margemDireita; 
            
            doc.setFont('times', 'normal');
            doc.setFontSize(12);

            const linhas = doc.splitTextToSize(conteudo, larguraMax);
            let y = margem;

            linhas.forEach(linha => {
                if (y > 277) { 
                    doc.addPage();
                    y = margem;
                }
                
                if (linha.trim().length > 0) {
                    doc.text(linha, margem, y);
                }
                
                y += 5;
            });

            doc.save(nomeArquivo);
            this.mostrarToast('PDF gerado com sucesso!', 'sucesso');

          } catch (e) {
            console.error('Erro ao gerar PDF:', e);
            this.mostrarToast('Erro ao gerar PDF. Verifique o console.', 'erro');
          }
        }

        async copiarTexto() {
          const texto = this.previewArea.textContent;
          if (!texto || texto === '... O documento será renderizado aqui ...') {
              this.mostrarToast('Nenhum documento para copiar.', 'erro');
              return;
          }
          
          try {
            await navigator.clipboard.writeText(texto);
            this.mostrarToast('Texto copiado com sucesso!', 'sucesso');
          } catch (err) {
            console.error('Erro ao copiar texto:', err);
            this.mostrarToast('Erro ao copiar. Use Ctrl+C / Cmd+C.', 'erro');
          }
        }

        mostrarToast(mensagem, tipo = 'info') {
          const container = document.getElementById('toast-container');
          const toast = document.createElement('div');
          let iconeClass = '';
          let bgClass = '';

          if (tipo === 'sucesso') {
            iconeClass = 'fas fa-check-circle';
            bgClass = 'bg-pmam-success';
          } else if (tipo === 'erro') {
            iconeClass = 'fas fa-times-circle';
            bgClass = 'bg-pmam-error';
          } else {
            iconeClass = 'fas fa-info-circle';
            bgClass = 'bg-pmam-blue';
          }

          toast.className = `toast ${bgClass} text-pmam-card min-w-64 p-4 rounded-pmam-lg shadow-pmam-xl mb-3 opacity-0 transform translate-x-full flex items-center`;
          toast.innerHTML = `<i class="${iconeClass} mr-3 text-lg"></i> <span>${mensagem}</span>`;
          container.appendChild(toast);

          setTimeout(() => {
            toast.classList.remove('opacity-0', 'translate-x-full');
          }, 10);

          setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-x-full');
            setTimeout(() => {
              container.removeChild(toast);
            }, 300); 
          }, 3500);
        }
      }

      let sistema;
      document.addEventListener('DOMContentLoaded', () => {
        sistema = new SistemaProcedimentosPMAM();
      });
    </script>
  </body>
</html>
