<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO PMAM | Dashboard de Procedimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=Roboto+Mono&display=swap');
        
        :root {
            --pbi-blue: #001f3f;
            --pbi-accent: #f2c811;
            --pbi-bg: #f3f4f6;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--pbi-bg); color: #2d3748; }
        
        .bi-card { @apply bg-white rounded-lg shadow-sm border border-slate-200 p-6 transition-all hover:shadow-md; }
        .sidebar-item { @apply flex items-center gap-4 p-4 w-full text-left rounded-lg transition-all text-slate-400 font-semibold hover:bg-slate-700 hover:text-white; }
        .sidebar-item.active { @apply bg-slate-800 text-yellow-500 border-l-4 border-yellow-500; }
        
        .proc-tile { @apply relative overflow-hidden flex flex-col items-center justify-center p-8 rounded-xl cursor-pointer transition-all hover:scale-105; }
        .input-bi { @apply w-full p-3 bg-slate-50 border border-slate-300 rounded-md focus:border-yellow-600 outline-none text-sm transition-all; }
        
        .status-badge { @apply px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-tighter; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside id="sidebar" class="w-72 bg-[#001b33] text-white flex flex-col shadow-2xl z-50">
        <div class="p-8 border-b border-white/10 flex flex-col items-center gap-4">
            <img src="sispro-mam.png" alt="SISPRO" class="h-16">
            <span class="text-xs font-black tracking-[0.4em] text-yellow-500 uppercase">Inteligência Operacional</span>
        </div>
        
        <nav class="flex-1 p-4 space-y-2 mt-4">
            <button onclick="app.navegar(1)" id="btn-1" class="sidebar-item active">
                <i class="fas fa-th-large"></i> Dashboard Principal
            </button>
            <button onclick="app.navegar(2)" id="btn-2" class="sidebar-item">
                <i class="fas fa-user-edit"></i> Qualificação
            </button>
            <button onclick="app.navegar(3)" id="btn-3" class="sidebar-item">
                <i class="fas fa-copy"></i> Repositório de Documentos
            </button>
            <button onclick="app.navegar(4)" id="btn-4" class="sidebar-item">
                <i class="fas fa-file-signature"></i> Relatório Final
            </button>
        </nav>

        <div class="p-4 border-t border-white/10 space-y-2">
            <button onclick="app.abrirBusca()" class="w-full bg-yellow-600 hover:bg-yellow-700 p-3 rounded-lg text-xs font-bold transition-all">
                <i class="fas fa-search mr-2"></i> CONSULTAR PROCEDIMENTOS
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col overflow-y-auto">
        
        <header class="bg-white border-b border-slate-200 px-8 py-4 flex items-center justify-between sticky top-0 z-40">
            <img src="logo-pmam.png" alt="PMAM" class="h-14">
            <div class="text-center">
                <h2 class="text-sm font-black text-slate-800 uppercase tracking-tighter">Polícia Militar do Amazonas</h2>
                <p class="text-[10px] font-bold text-slate-400">Comando Geral | DJD</p>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p class="text-xs font-bold" id="header-procedimento">Sem Procedimento Ativo</p>
                    <span class="status-badge bg-green-100 text-green-700">Sistema Online</span>
                </div>
            </div>
        </header>

        <div class="p-10 space-y-8">

            <section id="tela-1" class="space-y-8">
                <div class="flex justify-between items-end">
                    <h3 class="text-2xl font-black text-slate-800 italic uppercase">Seletor de Ritos</h3>
                    <p class="text-xs text-slate-400 font-bold">Inicie um novo fluxo jurídico-administrativo</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6">
                    <div onclick="app.setTipo('IPM', 'bg-blue-800')" class="proc-tile bg-blue-800 text-white group">
                        <i class="fas fa-shield-halved text-5xl mb-4 group-hover:rotate-12 transition-transform"></i>
                        <span class="text-xl font-black">IPM</span>
                        <div class="mt-4 text-[10px] opacity-60 font-bold">Inquérito Policial Militar</div>
                    </div>
                    <div onclick="app.setTipo('Sindicância Adm.', 'bg-emerald-700')" class="proc-tile bg-emerald-700 text-white group">
                        <i class="fas fa-gavel text-5xl mb-4 group-hover:rotate-12 transition-transform"></i>
                        <span class="text-xl font-black uppercase">Sind. ADM</span>
                        <div class="mt-4 text-[10px] opacity-60 font-bold">Sindicância Administrativa</div>
                    </div>
                    <div onclick="app.setTipo('Sindicância Inv.', 'bg-amber-600')" class="proc-tile bg-amber-600 text-white group">
                        <i class="fas fa-search text-5xl mb-4 group-hover:rotate-12 transition-transform"></i>
                        <span class="text-xl font-black uppercase">Sind. INV</span>
                        <div class="mt-4 text-[10px] opacity-60 font-bold">Sindicância Investigativa</div>
                    </div>
                    <div onclick="app.setTipo('PARE', 'bg-red-700')" class="proc-tile bg-red-700 text-white group">
                        <i class="fas fa-exclamation-triangle text-5xl mb-4 group-hover:rotate-12 transition-transform"></i>
                        <span class="text-xl font-black">PARE</span>
                        <div class="mt-4 text-[10px] opacity-60 font-bold">Apuração de Acidentes</div>
                    </div>
                    <div onclick="app.setTipo('PAD', 'bg-slate-900')" class="proc-tile bg-slate-900 text-white group">
                        <i class="fas fa-landmark text-5xl mb-4 group-hover:rotate-12 transition-transform"></i>
                        <span class="text-xl font-black">PAD</span>
                        <div class="mt-4 text-[10px] opacity-60 font-bold">Conselhos e PAD</div>
                    </div>
                </div>
            </section>

            <section id="tela-2" class="hidden space-y-6">
                <div class="bi-card grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="space-y-4">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest italic">Base Legal</h4>
                        <input type="text" id="num-portaria" class="input-bi" placeholder="Portaria (Ex: 001/2024)">
                        <input type="date" id="data-portaria" class="input-bi" title="Data da Portaria">
                    </div>
                    <div class="md:col-span-2 space-y-4">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest italic">Resumo dos Fatos</h4>
                        <textarea id="fatos" class="input-bi h-28" placeholder="Transcreva aqui o objeto da investigação conforme portaria..."></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="app.abrirModalQualif('Encarregado')" class="bg-slate-800 text-white px-6 py-3 rounded-lg text-[10px] font-black hover:bg-black transition-all">ADD ENCARREGADO</button>
                    <button onclick="app.abrirModalQualif('Escrivão')" class="bg-slate-800 text-white px-6 py-3 rounded-lg text-[10px] font-black hover:bg-black transition-all">ADD ESCRIVÃO</button>
                    <button onclick="app.abrirModalQualif('Envolvido')" class="bg-blue-700 text-white px-6 py-3 rounded-lg text-[10px] font-black hover:bg-blue-800 transition-all">ADD ENVOLVIDO</button>
                </div>

                <div id="lista-qualificados" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <section id="tela-3" class="hidden grid grid-cols-1 md:grid-cols-2 gap-10 animate-fadeIn">
                <div class="bi-card">
                    <h4 class="text-sm font-black text-blue-900 mb-6 uppercase border-b pb-4 border-slate-100 italic">
                        <i class="fas fa-certificate mr-2 text-yellow-500"></i> Documentos Padrão (PMAM)
                    </h4>
                    <div id="grid-padrao" class="space-y-2"></div>
                </div>
                <div class="bi-card">
                    <h4 class="text-sm font-black text-slate-700 mb-6 uppercase border-b pb-4 border-slate-100 italic">
                        <i class="fas fa-folder-open mr-2 text-blue-500"></i> Atos Diversos e Instrução
                    </h4>
                    <div id="grid-diversos" class="space-y-2"></div>
                </div>
            </section>

            <section id="tela-4" class="hidden space-y-6">
                <div class="bi-card min-h-[800px] flex flex-col">
                    <div class="flex justify-between items-center mb-8 bg-slate-50 p-6 rounded-xl border border-slate-200">
                        <div class="flex gap-2">
                            <span class="status-badge bg-blue-100 text-blue-700">Edição Ativa</span>
                            <span class="status-badge bg-slate-100 text-slate-500">Auto-Save On</span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="app.editRelatorio()" class="bg-slate-800 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-black">EDITAR</button>
                            <button onclick="app.saveRelatorio()" class="bg-emerald-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-emerald-700">SALVAR</button>
                            <button onclick="app.exportarWord()" class="bg-blue-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-blue-700">DOCX</button>
                            <button onclick="app.exportarPDF()" class="bg-red-600 text-white px-6 py-2 rounded-lg text-xs font-bold hover:bg-red-700">PDF</button>
                        </div>
                    </div>
                    <textarea id="relatorio-editor" class="flex-1 w-full p-10 font-mono text-sm leading-relaxed border-0 bg-transparent outline-none" readonly></textarea>
                </div>
            </section>

        </div>
    </main>

    <div id="modal-qualif" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-[100] p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden animate-zoomIn">
            <div class="p-6 bg-slate-800 text-white flex justify-between">
                <h3 class="font-black text-lg uppercase italic" id="modal-papel">Qualificação</h3>
                <button onclick="app.fecharModalQualif()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Nome Completo</label>
                    <input type="text" id="q-nome" class="input-bi uppercase">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">CI / RG</label>
                    <input type="text" id="q-rg" class="input-bi">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Posto / Graduação</label>
                    <input type="text" id="q-posto" class="input-bi uppercase">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Idade</label>
                    <input type="number" id="q-idade" class="input-bi">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Naturalidade</label>
                    <input type="text" id="q-naturalidade" class="input-bi uppercase">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Profissão</label>
                    <input type="text" id="q-profissao" class="input-bi uppercase">
                </div>
                <div class="col-span-2">
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Endereço Completo</label>
                    <input type="text" id="q-endereco" class="input-bi">
                </div>
                <button onclick="app.salvarQualificado()" class="col-span-2 bg-yellow-600 text-white font-black py-4 rounded-xl shadow-lg hover:bg-yellow-700 mt-4 transition-all uppercase italic">Salvar Registro no Procedimento</button>
            </div>
        </div>
    </div>

    <div id="modal-doc" class="fixed inset-0 bg-slate-900/95 hidden items-center justify-center z-[110] p-6">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-2xl flex flex-col shadow-2xl overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-slate-50">
                <h3 id="doc-tit" class="font-black text-slate-800 uppercase italic">Pré-visualização do Documento</h3>
                <div class="flex gap-4">
                    <button onclick="app.fecharDoc()" class="text-xs font-bold text-slate-400">FECHAR</button>
                    <button onclick="app.confirmarDoc()" class="bg-[#001b33] text-white px-10 py-2 rounded-lg font-black text-[10px]">SALVAR ALTERAÇÕES</button>
                </div>
            </div>
            <textarea id="doc-area" class="flex-1 p-16 font-mono text-sm leading-relaxed outline-none border-0"></textarea>
        </div>
    </div>

    <script>
        class SISPRO_BI {
            constructor() {
                this.dados = { tipo: '', portaria: '', dataP: '', fatos: '', envolvidos: [], docs: {}, numOficio: 1 };
                this.travarDatas();
            }

            travarDatas() {
                const hoje = new Date().toISOString().split('T')[0];
                document.getElementById('data-portaria').setAttribute('min', hoje);
            }

            navegar(n) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`tela-${n}`).classList.remove('hidden');
                document.querySelectorAll('.sidebar-item').forEach(b => b.classList.remove('active'));
                document.getElementById(`btn-${n}`).classList.add('active');
                if(n === 3) this.gerarDocumentos();
                if(n === 4) this.gerarRelatorio();
            }

            setTipo(t, cor) { 
                this.dados.tipo = t; 
                document.getElementById('header-procedimento').innerText = t;
                this.navegar(2);
            }

            abrirModalQualif(papel) {
                this.papelAtual = papel;
                document.getElementById('modal-papel').innerText = papel;
                document.getElementById('modal-qualif').style.display = 'flex';
            }

            fecharModalQualif() { document.getElementById('modal-qualif').style.display = 'none'; }

            salvarQualificado() {
                const q = {
                    papel: this.papelAtual,
                    nome: document.getElementById('q-nome').value,
                    rg: document.getElementById('q-rg').value,
                    posto: document.getElementById('q-posto').value,
                    idade: document.getElementById('q-idade').value,
                    nat: document.getElementById('q-naturalidade').value,
                    prof: document.getElementById('q-profissao').value,
                    end: document.getElementById('q-endereco').value
                };
                this.dados.envolvidos.push(q);
                this.renderLista();
                this.fecharModalQualif();
            }

            renderLista() {
                const div = document.getElementById('lista-qualificados');
                div.innerHTML = this.dados.envolvidos.map((e, i) => `
                    <div class="bi-card border-l-4 border-l-blue-900 group">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[8px] font-black text-blue-600 uppercase tracking-widest">${e.papel}</span>
                                <h4 class="font-bold text-slate-800 text-sm">${e.posto} ${e.nome}</h4>
                                <p class="text-[10px] text-slate-400">CI ${e.rg} | ${e.idade} anos</p>
                            </div>
                            <button onclick="app.remover(${i})" class="text-slate-200 group-hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            }

            formatData(data) {
                if(!data) return "___ de __________ de 202__";
                const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
                const d = new Date(data + "T12:00:00");
                return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
            }

            gerarDocumentos() {
                this.dados.portaria = document.getElementById('num-portaria').value;
                this.dados.dataP = document.getElementById('data-portaria').value;
                this.dados.fatos = document.getElementById('fatos').value;
                
                const enc = this.dados.envolvidos.find(x => x.papel === 'Encarregado') || {nome: '______', posto: '____'};
                const esc = this.dados.envolvidos.find(x => x.papel === 'Escrivão') || {nome: '______', posto: '____', rg: '____'};
                const dataH = this.formatData(new Date().toISOString().split('T')[0]);
                const dataP = this.formatData(this.dados.dataP);

                const padrao = {
                    'Autuação': `AUTUAÇÃO\n\nAos ${dataH}, nesta Cidade de Manaus, Estado do Amazonas, autuo a Portaria nº ${this.dados.portaria}, de ${dataP}, do que para constar lavro o presente termo.\n\n__________________________\n${esc.nome}\nEscrivão`,
                    'Termo de Abertura': `TERMO DE ABERTURA\n\nAos ${dataH}, nesta Cidade de Manaus-AM, dou início a presente ${this.dados.tipo}, para apurar: ${this.dados.fatos}.\n\n__________________________\n${enc.nome}\nEncarregado`,
                    'Designação de Escrivão': `DESIGNAÇÃO DE ESCRIVÃO\n\nDesigno o militar ${esc.nome}, CI ${esc.rg}, para servir como escrivão neste feito.\n\n__________________________\nEncarregado`,
                    'Compromisso': `TERMO DE COMPROMISSO\n\nO Escrivão designado prestou compromisso legal de manter o sigilo e a fiel execução do rito.`,
                    'Encerramento': `TERMO DE ENCERRAMENTO\n\nAos ${dataH}, dou por encerrado os trabalhos desta instrução.`
                };

                const diversos = {
                    'Juntada': `TERMO DE JUNTADA\n\nFaço a juntada aos autos de: ____________________.\n\nEscrivão`,
                    'Ofícios': `OFÍCIO Nº ${this.dados.numOficio}/2024-SJD\n\nAo Sr. Comandante,\n\nAssunto: Requisição.\n\nSolicito a apresentação do militar...`,
                    'Termos': `TERMO DE ____________________\n\n(Texto Genérico para Depoimentos e Oitivas)`,
                    'Declarações': `DECLARAÇÕES DE ____________________\n\nAos ${dataH}, compareceu o militar...`,
                    'Despachos': `DESPACHO\n\n1. Determino que se proceda a...`
                };

                this.dados.docs = {...padrao, ...diversos};
                document.getElementById('grid-padrao').innerHTML = Object.keys(padrao).map(k => this.cardDoc(k, 'text-blue-900 bg-blue-50')).join('');
                document.getElementById('grid-diversos').innerHTML = Object.keys(diversos).map(k => this.cardDoc(k, 'text-slate-600 bg-slate-100')).join('');
            }

            cardDoc(k, cor) {
                return `<div onclick="app.abrirEditor('${k}')" class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-lg shadow-sm cursor-pointer hover:border-yellow-500 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-md flex items-center justify-center font-bold text-[10px] ${cor}">DOC</div>
                        <span class="text-xs font-bold text-slate-700">${k}</span>
                    </div>
                    <i class="fas fa-chevron-right text-slate-200 text-[10px]"></i>
                </div>`;
            }

            abrirEditor(k) {
                this.docAtivo = k;
                document.getElementById('doc-tit').innerText = k;
                document.getElementById('doc-area').value = this.dados.docs[k];
                document.getElementById('modal-doc').style.display = 'flex';
            }

            confirmarDoc() { this.dados.docs[this.docAtivo] = document.getElementById('doc-area').value; this.fecharDoc(); }
            fecharDoc() { document.getElementById('modal-doc').style.display = 'none'; }

            gerarRelatorio() {
                const enc = this.dados.envolvidos.find(x => x.papel === 'Encarregado') || {nome: '______', posto: '____'};
                let r = `POLÍCIA MILITAR DO AMAZONAS\nRELATÓRIO DE ${this.dados.tipo.toUpperCase()}\n\n`;
                r += `I - DOS FATOS\nApura-se via Portaria ${this.dados.portaria}: ${this.dados.fatos}.\n\n`;
                r += `II - DA INSTRUÇÃO\nForam qualificados: ${this.dados.envolvidos.map(e => e.nome).join(', ')}.\n\n`;
                r += `III - CONCLUSÃO\nDiante do exposto, concluo que...\n\n__________________________\nEncarregado`;
                document.getElementById('relatorio-editor').value = r;
            }

            editRelatorio() { document.getElementById('relatorio-editor').readOnly = false; document.getElementById('relatorio-editor').focus(); }
            saveRelatorio() { document.getElementById('relatorio-editor').readOnly = true; alert("Relatório Salvo no Banco Local!"); }
            
            exportarPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const lines = doc.splitTextToSize(document.getElementById('relatorio-editor').value, 180);
                doc.text(lines, 15, 20);
                doc.save(`RELATORIO_${this.dados.tipo}.pdf`);
            }
        }

        const app = new SISPRO_BI();
    </script>
</body>
</html>
