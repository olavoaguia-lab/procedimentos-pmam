<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO - PMAM | Sistema de Procedimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pmam-blue': '#1e3a8a',
                        'pmam-navy': '#0f172a',
                        'pmam-light': '#3b82f6',
                        'pmam-accent': '#0ea5e9',
                        'pmam-success': '#10b981',
                        'pmam-warning': '#f59e0b',
                        'pmam-error': '#ef4444',
                        'pmam-surface': '#f8fafc',
                        'pmam-card': '#ffffff',
                        'pmam-border': '#e2e8f0',
                        'pmam-text': '#334155',
                        'pmam-muted': '#64748b',
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'slide-in': 'slideIn 0.4s ease-out',
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                    },
                    boxShadow: {
                        'pmam-lg': '0 10px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'pmam-xl': '0 20px 40px -10px rgba(0, 0, 0, 0.1)',
                    },
                }
            }
        }
    </script>
    
    <style>
        body {
            font-feature-settings: "kern", "liga", "clig", "calt";
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .sidebar {
            width: 280px;
            transition: transform 0.3s ease;
        }
        
        .main-content {
            margin-left: 280px;
            transition: margin 0.3s ease;
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                position: fixed;
                left: 0;
                height: 100vh;
                z-index: 40;
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        .doc-item {
            @apply border-l-4 border-transparent hover:border-pmam-blue transition-all;
        }
        
        .doc-item.active {
            @apply border-pmam-blue bg-blue-50;
        }
        
        .step-indicator {
            @apply w-8 h-8 rounded-full flex items-center justify-center text-sm font-semibold;
        }
        
        .step-indicator.active {
            @apply bg-pmam-blue text-white;
        }
        
        .step-indicator.completed {
            @apply bg-green-500 text-white;
        }
        
        .step-indicator.inactive {
            @apply bg-gray-200 text-gray-500;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-pmam-surface text-pmam-text font-sans">
    
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar bg-white border-r border-pmam-border fixed top-0 left-0 h-full overflow-y-auto custom-scrollbar">
        <div class="p-6 border-b border-pmam-border">
            <h2 class="text-xl font-bold text-pmam-navy text-center">SISPRO - PMAM</h2>
            <p class="text-sm text-pmam-muted text-center mt-1">Sistema de Procedimentos</p>
        </div>
        
        <!-- Passos do Processo -->
        <div class="p-6 border-b border-pmam-border">
            <h3 class="font-semibold text-pmam-navy mb-4">Progresso do Procedimento</h3>
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <div id="step-1" class="step-indicator active">1</div>
                    <div>
                        <div class="font-medium text-sm">Tipo de Procedimento</div>
                        <div id="step-1-info" class="text-xs text-pmam-muted">Não selecionado</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="step-2" class="step-indicator inactive">2</div>
                    <div>
                        <div class="font-medium text-sm">Caracterização</div>
                        <div id="step-2-info" class="text-xs text-pmam-muted">Aguardando</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="step-3" class="step-indicator inactive">3</div>
                    <div>
                        <div class="font-medium text-sm">Documentos</div>
                        <div id="step-3-info" class="text-xs text-pmam-muted">0/7 documentos</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="step-4" class="step-indicator inactive">4</div>
                    <div>
                        <div class="font-medium text-sm">Preview Final</div>
                        <div class="text-xs text-pmam-muted">Todos os documentos</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Documentos Gerados -->
        <div class="p-6">
            <h3 class="font-semibold text-pmam-navy mb-4">Documentos do Procedimento</h3>
            <div id="lista-documentos" class="space-y-2">
                <!-- Documentos serão listados aqui -->
            </div>
        </div>
        
        <!-- Botão para abrir/fechar sidebar no mobile -->
        <button id="sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-pmam-blue text-white rounded-lg shadow-lg">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    
    <!-- Main Content -->
    <div class="main-content min-h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-pmam-border sticky top-0 z-30">
            <div class="p-6">
                <h1 class="text-3xl font-bold text-pmam-navy text-center">Sistema de Procedimentos - PMAM</h1>
                <div class="flex justify-center mt-4 space-x-4">
                    <button onclick="sistema.salvarProcedimento()" 
                            class="px-4 py-2 bg-pmam-success text-white rounded-lg hover:bg-green-600 text-sm flex items-center">
                        <i class="fas fa-save mr-2"></i> Salvar
                    </button>
                    <button onclick="sistema.abrirGerenciador()" 
                            class="px-4 py-2 bg-pmam-blue text-white rounded-lg hover:bg-blue-800 text-sm flex items-center">
                        <i class="fas fa-folder-open mr-2"></i> Procedimentos
                    </button>
                    <button onclick="sistema.irParaPreview()" 
                            class="px-4 py-2 bg-pmam-accent text-white rounded-lg hover:bg-blue-600 text-sm flex items-center">
                        <i class="fas fa-eye mr-2"></i> Preview Final
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Content Area -->
        <div class="p-6">
            <!-- Step 1: Tipo de Procedimento -->
            <div id="step1-content" class="max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-pmam-navy mb-2">Selecionar Tipo de Procedimento</h2>
                    <p class="text-pmam-muted">Escolha o tipo de procedimento para iniciar</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div onclick="sistema.selecionarProcedimento('SAD')" 
                         class="bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-pmam-blue to-pmam-light flex items-center justify-center">
                                <i class="fas fa-gavel text-white text-xl"></i>
                            </div>
                            <span class="text-xs font-semibold bg-blue-50 text-blue-700 px-3 py-1 rounded-full">DISCIPLINAR</span>
                        </div>
                        <h3 class="text-lg font-bold text-pmam-navy mb-2">SAD - Sindicância Disciplinar</h3>
                        <p class="text-pmam-muted text-sm mb-4">Para apuração de infrações disciplinares</p>
                    </div>
                    
                    <div onclick="sistema.selecionarProcedimento('SINDINVEST')" 
                         class="bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-600 to-purple-500 flex items-center justify-center">
                                <i class="fas fa-search text-white text-xl"></i>
                            </div>
                            <span class="text-xs font-semibold bg-purple-50 text-purple-700 px-3 py-1 rounded-full">INVESTIGATIVO</span>
                        </div>
                        <h3 class="text-lg font-bold text-pmam-navy mb-2">SINDINVEST - Sindicância Investigativa</h3>
                        <p class="text-pmam-muted text-sm mb-4">Para investigação de fatos</p>
                    </div>
                    
                    <div onclick="sistema.selecionarProcedimento('IPM')" 
                         class="bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-red-600 to-red-500 flex items-center justify-center">
                                <i class="fas fa-shield-alt text-white text-xl"></i>
                            </div>
                            <span class="text-xs font-semibold bg-red-50 text-red-700 px-3 py-1 rounded-full">PENAL MILITAR</span>
                        </div>
                        <h3 class="text-lg font-bold text-pmam-navy mb-2">IPM - Inquérito Policial Militar</h3>
                        <p class="text-pmam-muted text-sm mb-4">Para investigação de infrações penais militares</p>
                    </div>
                    
                    <div onclick="sistema.selecionarProcedimento('PAD')" 
                         class="bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-amber-600 to-amber-500 flex items-center justify-center">
                                <i class="fas fa-scale-balanced text-white text-xl"></i>
                            </div>
                            <span class="text-xs font-semibold bg-amber-50 text-amber-700 px-3 py-1 rounded-full">ADMINISTRATIVO</span>
                        </div>
                        <h3 class="text-lg font-bold text-pmam-navy mb-2">PAD - Processo Administrativo Disciplinar</h3>
                        <p class="text-pmam-muted text-sm mb-4">Processo formal para apuração de infrações</p>
                    </div>
                    
                    <div onclick="sistema.selecionarProcedimento('PARE')" 
                         class="bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all group">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-600 to-emerald-500 flex items-center justify-center">
                                <i class="fas fa-hand-holding-usd text-white text-xl"></i>
                            </div>
                            <span class="text-xs font-semibold bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full">RESSARCIMENTO</span>
                        </div>
                        <h3 class="text-lg font-bold text-pmam-navy mb-2">PARE - Procedimento de Ressarcimento</h3>
                        <p class="text-pmam-muted text-sm mb-4">Para apuração de responsabilidade civil</p>
                    </div>
                </div>
                
                <div id="procedimento-selecionado-info" class="hidden mt-8 bg-blue-50 border border-blue-200 rounded-xl p-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <div class="flex items-center mb-2">
                                <div id="procedimento-icon" class="w-10 h-10 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas text-white"></i>
                                </div>
                                <div>
                                    <h3 id="procedimento-nome" class="text-xl font-bold text-pmam-navy"></h3>
                                    <p id="procedimento-descricao" class="text-pmam-muted"></p>
                                </div>
                            </div>
                        </div>
                        <button onclick="sistema.avancarParaCaracterizacao()" 
                                class="mt-4 md:mt-0 bg-gradient-to-r from-pmam-blue to-pmam-light text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg hover:shadow-pmam-blue/25 transition-all flex items-center">
                            Continuar para Caracterização
                            <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Caracterização -->
            <div id="step2-content" class="hidden max-w-4xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-pmam-navy mb-2">Caracterização do Procedimento</h2>
                    <p class="text-pmam-muted">Preencha os dados fundamentais do procedimento</p>
                </div>
                
                <div class="bg-white rounded-xl border border-pmam-border p-6 mb-6">
                    <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <div class="font-medium text-pmam-blue mb-2">Procedimento Selecionado:</div>
                        <div id="procedimento-atual-info" class="text-lg font-bold"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Coluna 1 -->
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2">Número da Portaria*</label>
                                <input type="text" id="numero-portaria" 
                                       class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: 05.02/2024/SAD/SJD/PMAM"
                                       required>
                                <p class="text-xs text-pmam-muted mt-1">Este número será usado para identificar o procedimento</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2">Data da Portaria*</label>
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <input type="number" id="data-dia" min="1" max="31"
                                               class="w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                               required>
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Dia</label>
                                    </div>
                                    <div>
                                        <input type="text" id="data-mes" 
                                               class="w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                               required>
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Mês</label>
                                    </div>
                                    <div>
                                        <input type="number" id="data-ano" min="2000" max="2100"
                                               class="w-full p-3 border border-pmam-border rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                               required>
                                        <label class="text-xs text-pmam-muted mt-1 block text-center">Ano</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2">Local/Unidade*</label>
                                <input type="text" id="local-unidade" 
                                       class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: SJD do Comando de Policiamento Leste"
                                       required>
                            </div>
                        </div>
                        
                        <!-- Coluna 2 -->
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2" id="label-encarregado">Encarregado/Responsável*</label>
                                <input type="text" id="encarregado-nome" 
                                       class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Ex: CAP QOPM NOME COMPLETO (12345)"
                                       required>
                                <div class="text-xs text-pmam-muted mt-1" id="descricao-encarregado"></div>
                            </div>
                            
                            <div>
                                <label id="titulo-acusado" class="block text-sm font-medium text-pmam-text mb-2">Acusado/Sindicado*</label>
                                <input type="text" id="acusado-nome" 
                                       class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                                       placeholder="Nome, Posto/Grad e CI"
                                       required>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2">Ofendido/Vítima*</label>
                                <select id="ofendido-tipo" class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                                    <option value="PMAM">Polícia Militar do Amazonas</option>
                                    <option value="FAZENDA">Fazenda Pública/PMAM</option>
                                    <option value="PARTICULAR">Particular</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-pmam-text mb-2">Objeto da Apuração*</label>
                                <textarea id="objeto-apuracao" rows="3"
                                          class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue resize-none"
                                          placeholder="Descreva sucintamente o objeto do procedimento..."
                                          required></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8 pt-6 border-t border-pmam-border">
                        <button onclick="sistema.voltarParaProcedimento()" 
                                class="px-6 py-3 border border-pmam-border text-pmam-text rounded-lg font-medium hover:bg-pmam-surface transition-all flex items-center">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Voltar
                        </button>
                        <button onclick="sistema.avancarParaDocumentos()" 
                                class="bg-gradient-to-r from-pmam-blue to-pmam-light text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg hover:shadow-pmam-blue/25 transition-all flex items-center">
                            Gerar Documentos
                            <i class="fas fa-file-alt ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Documentos -->
            <div id="step3-content" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-pmam-navy mb-2">Documentos do Procedimento</h2>
                    <p class="text-pmam-muted">Clique em cada documento para preencher e gerar</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 max-w-6xl mx-auto">
                    <!-- Documentos -->
                    <div onclick="sistema.criarDocumento('autuacao')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-pmam-blue to-pmam-light flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-signature text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Autuação</h3>
                        <p class="text-sm text-pmam-muted mb-4">Termo inicial do procedimento</p>
                        <div class="text-xs text-pmam-success" id="status-autuacao">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('abertura')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-purple-600 to-purple-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-folder-open text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Abertura</h3>
                        <p class="text-sm text-pmam-muted mb-4">Termo de abertura formal</p>
                        <div class="text-xs text-pmam-muted" id="status-abertura">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('designacao')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-emerald-600 to-emerald-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-user-tie text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Designação</h3>
                        <p class="text-sm text-pmam-muted mb-4">Nomeação de escrivão</p>
                        <div class="text-xs text-pmam-muted" id="status-designacao">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('termos')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-amber-600 to-amber-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-gavel text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Termos</h3>
                        <p class="text-sm text-pmam-muted mb-4">Declarações e interrogatórios</p>
                        <div class="text-xs text-pmam-muted" id="status-termos">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('oficios')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-red-600 to-red-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-envelope text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Ofícios</h3>
                        <p class="text-sm text-pmam-muted mb-4">Comunicações oficiais</p>
                        <div class="text-xs text-pmam-muted" id="status-oficios">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('certidoes')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-600 to-indigo-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-certificate text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Certidões</h3>
                        <p class="text-sm text-pmam-muted mb-4">Documentos certificados</p>
                        <div class="text-xs text-pmam-muted" id="status-certidoes">Não gerado</div>
                    </div>
                    
                    <div onclick="sistema.criarDocumento('relatorio')" 
                         class="doc-card bg-white rounded-xl border-2 border-pmam-border p-6 cursor-pointer hover:border-pmam-blue transition-all text-center">
                        <div class="w-16 h-16 rounded-lg bg-gradient-to-br from-cyan-600 to-cyan-500 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-file-contract text-white text-2xl"></i>
                        </div>
                        <h3 class="font-bold text-pmam-navy mb-2">Relatório</h3>
                        <p class="text-sm text-pmam-muted mb-4">Relatório final e conclusão</p>
                        <div class="text-xs text-pmam-muted" id="status-relatorio">Não gerado</div>
                    </div>
                </div>
                
                <div class="flex justify-center mt-12">
                    <button onclick="sistema.irParaPreview()" 
                            class="px-8 py-3 bg-gradient-to-r from-pmam-accent to-pmam-light text-white rounded-lg font-medium hover:shadow-lg hover:shadow-pmam-blue/25 transition-all flex items-center text-lg">
                        <i class="fas fa-eye mr-3"></i>
                        Visualizar Todos os Documentos (Preview Final)
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Preview Final -->
            <div id="step4-content" class="hidden">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-pmam-navy mb-2">Preview Final - Todos os Documentos</h2>
                    <p class="text-pam-muted">Revise todos os documentos antes de exportar</p>
                </div>
                
                <div class="bg-white rounded-xl border border-pmam-border p-6 mb-6">
                    <div class="flex flex-wrap gap-4 mb-6">
                        <select id="seletor-documento-preview" 
                                class="flex-1 min-w-[200px] p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue">
                            <option value="">Selecione um documento para visualizar</option>
                        </select>
                        <button onclick="sistema.gerarPDFDocumentoSelecionado()" 
                                class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
                        </button>
                        <button onclick="sistema.gerarPDFTodosDocumentos()" 
                                class="px-6 py-3 bg-pmam-blue text-white rounded-lg hover:bg-blue-800 flex items-center">
                            <i class="fas fa-file-archive mr-2"></i> Todos em PDF
                        </button>
                    </div>
                    
                    <div class="border border-pmam-border rounded-lg overflow-hidden">
                        <div id="preview-conteudo" 
                             class="p-6 min-h-[600px] max-h-[800px] overflow-auto font-mono text-sm bg-gray-50">
                            Selecione um documento para visualizar...
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between">
                    <button onclick="sistema.voltarParaDocumentos()" 
                            class="px-6 py-3 border border-pmam-border text-pmam-text rounded-lg font-medium hover:bg-pmam-surface transition-all flex items-center">
                        <i class="fas fa-arrow-left mr-2"></i>
                        Voltar para Documentos
                    </button>
                    <button onclick="sistema.finalizarProcedimento()" 
                            class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-lg font-medium hover:shadow-lg hover:shadow-green-500/25 transition-all flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>
                        Finalizar Procedimento
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para Criar Documento -->
    <div id="modal-documento" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-pmam-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-pmam-border flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 id="modal-titulo" class="text-xl font-bold text-pmam-navy"></h3>
                    <button onclick="sistema.fecharModalDocumento()" class="text-pmam-muted hover:text-pmam-navy">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-6">
                <div id="modal-conteudo"></div>
            </div>
            
            <div class="p-6 border-t border-pmam-border">
                <div class="flex justify-end space-x-3">
                    <button onclick="sistema.fecharModalDocumento()" 
                            class="px-6 py-3 border border-pmam-border rounded-lg text-pmam-text hover:bg-pmam-surface">
                        Cancelar
                    </button>
                    <button onclick="sistema.salvarDocumentoModal()" 
                            class="px-6 py-3 bg-pmam-blue text-white rounded-lg hover:bg-blue-800">
                        Salvar Documento
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gerenciador de Procedimentos -->
    <div id="gerenciador-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-pmam-xl w-full max-w-4xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b border-pmam-border flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold text-pmam-navy">Gerenciador de Procedimentos</h3>
                    <button onclick="sistema.fecharGerenciador()" class="text-pmam-muted hover:text-pmam-navy">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 border-b border-pmam-border">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <input type="text" id="busca-gerenciador" 
                               class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue"
                               placeholder="Buscar por número da portaria...">
                    </div>
                    <button onclick="sistema.buscarProcedimentos()" 
                            class="px-6 py-3 bg-pmam-blue text-white rounded-lg hover:bg-blue-800">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-auto p-6">
                <div id="lista-procedimentos" class="space-y-3">
                    <!-- Procedimentos serão carregados aqui -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-3 w-80"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        const { jsPDF } = window.jspdf;
        
        class SistemaProcedimentosPMAM {
            constructor() {
                this.procedimentoSelecionado = null;
                this.dadosCaracterizacao = {};
                this.documentos = {
                    autuacao: { gerado: false, conteudo: '' },
                    abertura: { gerado: false, conteudo: '' },
                    designacao: { gerado: false, conteudo: '' },
                    termos: { gerado: false, conteudo: '' },
                    oficios: { gerado: false, conteudo: '' },
                    certidoes: { gerado: false, conteudo: '' },
                    relatorio: { gerado: false, conteudo: '' }
                };
                this.documentoAtual = null;
                this.procedimentosSalvos = this.carregarProcedimentosSalvos();
                this.passoAtual = 1;
                
                this.inicializarEventos();
                this.atualizarPasso(1);
            }
            
            inicializarEventos() {
                // Sidebar toggle
                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    document.getElementById('sidebar').classList.toggle('open');
                });
                
                // Preencher data atual
                this.preencherDataAtual();
            }
            
            selecionarProcedimento(tipo) {
                const procedimentos = {
                    'SAD': { 
                        id: 'SAD', 
                        nome: 'SINDICÂNCIA DISCIPLINAR',
                        descricao: 'Para apuração de infrações disciplinares cometidas por militares.',
                        cor: 'blue',
                        icon: 'fa-gavel'
                    },
                    'SINDINVEST': { 
                        id: 'SINDINVEST', 
                        nome: 'SINDICÂNCIA INVESTIGATIVA',
                        descricao: 'Para investigação de fatos que possam configurar infrações.',
                        cor: 'purple',
                        icon: 'fa-search'
                    },
                    'IPM': { 
                        id: 'IPM', 
                        nome: 'INQUÉRITO POLICIAL MILITAR',
                        descricao: 'Para investigação de infrações penais militares.',
                        cor: 'red',
                        icon: 'fa-shield-alt'
                    },
                    'PAD': { 
                        id: 'PAD', 
                        nome: 'PROCESSO ADMINISTRATIVO DISCIPLINAR',
                        descricao: 'Processo formal para apuração de infrações disciplinares.',
                        cor: 'amber',
                        icon: 'fa-scale-balanced'
                    },
                    'PARE': { 
                        id: 'PARE', 
                        nome: 'PROCEDIMENTO DE RESSARCIMENTO',
                        descricao: 'Para apuração de responsabilidade civil por danos.',
                        cor: 'emerald',
                        icon: 'fa-hand-holding-usd'
                    }
                };
                
                this.procedimentoSelecionado = procedimentos[tipo];
                
                // Atualizar interface
                const infoDiv = document.getElementById('procedimento-selecionado-info');
                infoDiv.classList.remove('hidden');
                
                document.getElementById('procedimento-nome').textContent = 
                    `${this.procedimentoSelecionado.id} - ${this.procedimentoSelecionado.nome}`;
                document.getElementById('procedimento-descricao').textContent = this.procedimentoSelecionado.descricao;
                
                // Atualizar ícone
                const iconDiv = document.getElementById('procedimento-icon');
                iconDiv.className = `w-10 h-10 rounded-lg flex items-center justify-center mr-3 bg-${this.procedimentoSelecionado.cor}-500`;
                iconDiv.innerHTML = `<i class="fas ${this.procedimentoSelecionado.icon} text-white"></i>`;
                
                // Atualizar sidebar
                document.getElementById('step-1-info').textContent = this.procedimentoSelecionado.nome;
                document.getElementById('step-1').classList.remove('active');
                document.getElementById('step-1').classList.add('completed');
                document.getElementById('step-2').classList.remove('inactive');
                document.getElementById('step-2').classList.add('active');
                
                this.mostrarToast('Procedimento selecionado com sucesso', 'sucesso');
            }
            
            avancarParaCaracterizacao() {
                if (!this.procedimentoSelecionado) {
                    this.mostrarToast('Selecione um tipo de procedimento primeiro', 'erro');
                    return;
                }
                
                this.atualizarPasso(2);
                
                // Atualizar título
                document.getElementById('procedimento-atual-info').textContent = 
                    `${this.procedimentoSelecionado.id} - ${this.procedimentoSelecionado.nome}`;
                
                // Preencher número da portaria com padrão
                const ano = document.getElementById('data-ano').value;
                const numeroPadrao = `XX.XX/${ano}/${this.procedimentoSelecionado.id}/SJD/PMAM`;
                if (!document.getElementById('numero-portaria').value) {
                    document.getElementById('numero-portaria').value = numeroPadrao;
                }
                
                // Atualizar labels específicas para IPM
                if (this.procedimentoSelecionado.id === 'IPM') {
                    document.getElementById('label-encarregado').textContent = 'Encarregado do IPM*';
                    document.getElementById('descricao-encarregado').textContent = 'Responsável pela condução do Inquérito Policial Militar';
                } else {
                    document.getElementById('label-encarregado').textContent = 'Encarregado/Sindicante*';
                    document.getElementById('descricao-encarregado').textContent = 'Responsável pelo procedimento';
                }
                
                if (this.procedimentoSelecionado.id === 'PARE') {
                    document.getElementById('titulo-acusado').textContent = 'Indiciado/Responsável*';
                } else {
                    document.getElementById('titulo-acusado').textContent = 'Acusado/Sindicado*';
                }
            }
            
            voltarParaProcedimento() {
                this.atualizarPasso(1);
            }
            
            avancarParaDocumentos() {
                // Validar campos
                const campos = ['numero-portaria', 'data-dia', 'data-mes', 'data-ano', 
                               'local-unidade', 'encarregado-nome', 'acusado-nome', 'objeto-apuracao'];
                
                for (const campoId of campos) {
                    const campo = document.getElementById(campoId);
                    if (!campo.value.trim()) {
                        this.mostrarToast(`Preencha o campo obrigatório: "${campo.placeholder || campoId}"`, 'erro');
                        campo.focus();
                        return;
                    }
                }
                
                // Coletar dados
                this.coletarDadosCaracterizacao();
                
                // Atualizar passo
                this.atualizarPasso(3);
                
                // Gerar autuação automaticamente
                this.gerarAutuacaoAutomatica();
            }
            
            coletarDadosCaracterizacao() {
                this.dadosCaracterizacao = {
                    procedimento: this.procedimentoSelecionado,
                    portaria: {
                        numero: document.getElementById('numero-portaria').value,
                        data: `${document.getElementById('data-dia').value} de ${document.getElementById('data-mes').value} de ${document.getElementById('data-ano').value}`
                    },
                    data: {
                        dia: document.getElementById('data-dia').value,
                        mes: document.getElementById('data-mes').value,
                        ano: document.getElementById('data-ano').value
                    },
                    local: {
                        unidade: document.getElementById('local-unidade').value
                    },
                    encarregado: {
                        nome: document.getElementById('encarregado-nome').value,
                        cargo: this.procedimentoSelecionado.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado/Sindicante'
                    },
                    acusado: {
                        nome: document.getElementById('acusado-nome').value
                    },
                    ofendido: {
                        tipo: document.getElementById('ofendido-tipo').value,
                        nome: document.getElementById('ofendido-tipo').options[document.getElementById('ofendido-tipo').selectedIndex].text
                    },
                    objeto: {
                        apuracao: document.getElementById('objeto-apuracao').value
                    }
                };
                
                // Atualizar sidebar
                document.getElementById('step-2-info').textContent = 'Completo';
                document.getElementById('step-2').classList.remove('active');
                document.getElementById('step-2').classList.add('completed');
                document.getElementById('step-3').classList.remove('inactive');
                document.getElementById('step-3').classList.add('active');
            }
            
            gerarAutuacaoAutomatica() {
                const conteudo = this.gerarConteudoAutuacao();
                this.documentos.autuacao = {
                    gerado: true,
                    conteudo: conteudo
                };
                
                // Atualizar interface
                document.getElementById('status-autuacao').textContent = '✓ Gerado';
                document.getElementById('status-autuacao').classList.remove('text-pmam-muted');
                document.getElementById('status-autuacao').classList.add('text-pmam-success');
                
                this.atualizarListaDocumentos();
                this.mostrarToast('Autuação gerada automaticamente', 'sucesso');
            }
            
            gerarConteudoAutuacao() {
                const d = this.dadosCaracterizacao;
                const encarregadoLabel = d.procedimento.id === 'IPM' ? 'ENCARREGADO:' : 'SINDICANTE:';
                const acusadoLabel = d.procedimento.id === 'PARE' ? 'RESPONSÁVEL:' : 'ACUSADO:';
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante';
                
                return `${d.procedimento.nome.toUpperCase()}

${encarregadoLabel} ${d.encarregado.nome}
${acusadoLabel} ${d.acusado.nome}
OFENDIDO: ${d.ofendido.nome}


A U T U A Ç Ã O

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta cidade de Manaus, Estado do Amazonas, na ${d.local.unidade}, autuo a Portaria nº ${d.portaria.numero}, datada de ${d.portaria.data}, e demais documentos que a este junto, do que para constar, lavro o presente termo. Eu, ${d.encarregado.nome}, ${d.procedimento.id === 'IPM' ? 'Encarregado' : 'Sindicante'} que o digitei e assino.

__________________________________
${d.encarregado.nome}
${cargo}`;
            }
            
            criarDocumento(tipo) {
                this.documentoAtual = tipo;
                
                const modelos = {
                    autuacao: {
                        titulo: 'Autuação',
                        campos: [],
                        template: () => this.gerarConteudoAutuacao()
                    },
                    abertura: {
                        titulo: 'Termo de Abertura',
                        campos: [],
                        template: () => this.gerarConteudoAbertura()
                    },
                    designacao: {
                        titulo: 'Designação de Escrivão',
                        campos: [
                            { id: 'escrivao_nome', label: 'Nome do Escrivão Designado', tipo: 'text', placeholder: 'Nome, Posto/Grad e CI' }
                        ],
                        template: (campos) => this.gerarConteudoDesignacao(campos)
                    },
                    termos: {
                        titulo: 'Termo de Declaração',
                        campos: [
                            { id: 'tipo_declaracao', label: 'Tipo de Declaração', tipo: 'select', opcoes: ['Vítima/Ofendido', 'Testemunha', 'Acusado/Sindicado'] },
                            { id: 'declarante_nome', label: 'Nome Completo', tipo: 'text' },
                            { id: 'declarante_cpf', label: 'CPF', tipo: 'text', placeholder: '000.000.000-00' },
                            { id: 'declarante_rg', label: 'RG/Identidade', tipo: 'text', placeholder: 'Número e órgão expedidor' },
                            { id: 'declarante_filiacao', label: 'Filiação (Pai e Mãe)', tipo: 'text' },
                            { id: 'declarante_endereco', label: 'Endereço Completo', tipo: 'textarea' },
                            { id: 'depoimento', label: 'Depoimento/Narração', tipo: 'textarea', placeholder: 'Descreva os fatos...' }
                        ],
                        template: (campos) => this.gerarConteudoTermos(campos)
                    },
                    oficios: {
                        titulo: 'Ofício',
                        campos: [
                            { id: 'destinatario', label: 'Destinatário', tipo: 'text', placeholder: 'Nome, cargo e unidade' },
                            { id: 'assunto', label: 'Assunto', tipo: 'text' },
                            { id: 'conteudo', label: 'Conteúdo', tipo: 'textarea', placeholder: 'Texto do ofício...' }
                        ],
                        template: (campos) => this.gerarConteudoOficio(campos)
                    },
                    certidoes: {
                        titulo: 'Certidão',
                        campos: [
                            { id: 'tipo_certidao', label: 'Tipo de Certidão', tipo: 'select', opcoes: ['Certidão de Autos', 'Certidão de Publicação', 'Certidão de Conclusão'] },
                            { id: 'conteudo_certidao', label: 'Conteúdo da Certidão', tipo: 'textarea' }
                        ],
                        template: (campos) => this.gerarConteudoCertidao(campos)
                    },
                    relatorio: {
                        titulo: 'Relatório Final',
                        campos: [
                            { id: 'historico', label: 'Histórico', tipo: 'textarea' },
                            { id: 'diligencias', label: 'Diligências Realizadas', tipo: 'textarea' },
                            { id: 'analise', label: 'Análise e Fundamentação', tipo: 'textarea' },
                            { id: 'conclusao', label: 'Conclusão e Proposta', tipo: 'textarea' }
                        ],
                        template: (campos) => this.gerarConteudoRelatorio(campos)
                    }
                };
                
                const modelo = modelos[tipo];
                
                // Configurar modal
                document.getElementById('modal-titulo').textContent = modelo.titulo;
                
                // Gerar campos
                let camposHTML = '';
                if (modelo.campos.length > 0) {
                    camposHTML = modelo.campos.map(campo => {
                        if (campo.tipo === 'textarea') {
                            return `<div class="mb-4">
                                <label class="block text-sm font-medium text-pmam-text mb-2">${campo.label}</label>
                                <textarea id="modal-${campo.id}" class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue" rows="4" placeholder="${campo.placeholder || ''}"></textarea>
                            </div>`;
                        } else if (campo.tipo === 'select') {
                            const opcoes = campo.opcoes.map(op => `<option value="${op}">${op}</option>`).join('');
                            return `<div class="mb-4">
                                <label class="block text-sm font-medium text-pmam-text mb-2">${campo.label}</label>
                                <select id="modal-${campo.id}" class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue">${opcoes}</select>
                            </div>`;
                        } else {
                            return `<div class="mb-4">
                                <label class="block text-sm font-medium text-pmam-text mb-2">${campo.label}</label>
                                <input type="text" id="modal-${campo.id}" class="w-full p-3 border border-pmam-border rounded-lg focus:outline-none focus:ring-2 focus:ring-pmam-blue" placeholder="${campo.placeholder || ''}">
                            </div>`;
                        }
                    }).join('');
                } else {
                    camposHTML = `<div class="text-center py-8">
                        <i class="fas fa-info-circle text-pmam-muted text-3xl mb-3"></i>
                        <p class="text-pmam-muted">Este documento será gerado automaticamente com os dados fornecidos.</p>
                    </div>`;
                }
                
                document.getElementById('modal-conteudo').innerHTML = camposHTML;
                document.getElementById('modal-documento').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            salvarDocumentoModal() {
                const tipo = this.documentoAtual;
                const campos = {};
                
                // Coletar valores dos campos
                const inputs = document.querySelectorAll('#modal-conteudo input, #modal-conteudo textarea, #modal-conteudo select');
                inputs.forEach(input => {
                    const id = input.id.replace('modal-', '');
                    campos[id] = input.value;
                });
                
                // Gerar conteúdo
                let conteudo;
                switch(tipo) {
                    case 'autuacao':
                        conteudo = this.gerarConteudoAutuacao();
                        break;
                    case 'abertura':
                        conteudo = this.gerarConteudoAbertura();
                        break;
                    case 'designacao':
                        conteudo = this.gerarConteudoDesignacao(campos);
                        break;
                    case 'termos':
                        conteudo = this.gerarConteudoTermos(campos);
                        break;
                    case 'oficios':
                        conteudo = this.gerarConteudoOficio(campos);
                        break;
                    case 'certidoes':
                        conteudo = this.gerarConteudoCertidao(campos);
                        break;
                    case 'relatorio':
                        conteudo = this.gerarConteudoRelatorio(campos);
                        break;
                }
                
                // Salvar documento
                this.documentos[tipo] = {
                    gerado: true,
                    conteudo: conteudo
                };
                
                // Atualizar interface
                document.getElementById(`status-${tipo}`).textContent = '✓ Gerado';
                document.getElementById(`status-${tipo}`).classList.remove('text-pmam-muted');
                document.getElementById(`status-${tipo}`).classList.add('text-pmam-success');
                
                this.atualizarListaDocumentos();
                this.fecharModalDocumento();
                this.mostrarToast('Documento salvo com sucesso', 'sucesso');
            }
            
            fecharModalDocumento() {
                document.getElementById('modal-documento').classList.add('hidden');
                document.body.style.overflow = 'auto';
                this.documentoAtual = null;
            }
            
            gerarConteudoAbertura() {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante';
                
                return `TERMO DE ABERTURA

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta cidade de Manaus, Estado do Amazonas, na ${d.local.unidade}, dei início ao presente ${d.procedimento.nome.toUpperCase()}, tendo como objeto: ${d.objeto.apuracao}. Do que para constar lavro o presente Termo que o escrevi e assino.

__________________________________
${d.encarregado.nome}
${cargo}`;
            }
            
            gerarConteudoDesignacao(campos) {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado' : 'Sindicante';
                
                return `TERMO DE DESIGNAÇÃO DE ESCRIVÃO

Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, eu, ${d.encarregado.nome}, ${cargo}, RESOLVO:

DESIGNAR o ${campos.escrivao_nome || '____________________'}, para exercer a função de **Escrivão** no presente ${d.procedimento.nome.toUpperCase()} acima referenciado, devendo cumprir todas as determinações legais inerentes ao cargo.

Para constar, lavro o presente termo que vai assinado.

__________________________________
${d.encarregado.nome}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante'}`;
            }
            
            gerarConteudoTermos(campos) {
                const d = this.dadosCaracterizacao;
                const tipo = campos.tipo_declaracao || 'Testemunha';
                const qualificacao = tipo === 'Vítima/Ofendido' ? 'OFENDIDO/VÍTIMA' : 
                                   tipo === 'Acusado/Sindicado' ? 'ACUSADO/SINDICADO' : 'TESTEMUNHA';
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado' : 'Sindicante';
                
                return `TERMO DE DECLARAÇÃO - ${tipo.toUpperCase()}

AUTOS: ${d.procedimento.nome.toUpperCase()} (${d.procedimento.id}) nº ${d.portaria.numero}
${d.procedimento.id === 'IPM' ? 'ENCARREGADO:' : 'SINDICANTE:'} ${d.encarregado.nome}


${qualificacao}: ${campos.declarante_nome || '____________________'}
CPF: ${campos.declarante_cpf || '__________'}
RG/IDENTIDADE: ${campos.declarante_rg || '__________'}
FILIAÇÃO: ${campos.declarante_filiacao || '__________'}
ENDEREÇO: ${campos.declarante_endereco || '__________'}


Aos ${d.data.dia} dias do mês de ${d.data.mes} do ano de ${d.data.ano}, nesta Cidade de Manaus, Estado do Amazonas, na ${d.local.unidade}, perante o ${cargo}, presente o Escrivão, foi inquirido(a) o(a) ${qualificacao.toLowerCase()} acima qualificado(a), que ao ser perguntado(a) sobre o objeto da apuração, declarou:


${campos.depoimento || '____________________'}


Lida e achada conforme, dou por encerrado o presente Termo, que segue assinado pelo ${cargo}, pelo Escrivão e pelo(a) ${qualificacao.toLowerCase()}.


Manaus-AM, ${d.data.dia} de ${d.data.mes} de ${d.data.ano}.

__________________________________
${campos.declarante_nome || '____________________'}
${qualificacao}

__________________________________
[NOME DO ESCRIVÃO]
Escrivão

__________________________________
${d.encarregado.nome}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante'}`;
            }
            
            gerarConteudoOficio(campos) {
                const d = this.dadosCaracterizacao;
                
                return `OFÍCIO Nº XXX/${d.data.ano}/${d.procedimento.id}
Quartel em Manaus/AM, ${d.data.dia} de ${d.data.mes} de ${d.data.ano}.

Ao ${campos.destinatario || '____________________'}

Assunto: ${campos.assunto || '____________________'}

Senhor(a),

${campos.conteudo || '____________________'}

Atenciosamente,

__________________________________
${d.encarregado.nome}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante'}`;
            }
            
            gerarConteudoCertidao(campos) {
                const d = this.dadosCaracterizacao;
                const tipo = campos.tipo_certidao || 'Certidão de Autos';
                
                return `${tipo.toUpperCase()}

AUTOS: ${d.procedimento.nome.toUpperCase()} (${d.procedimento.id}) nº ${d.portaria.numero}

CERTIFICO que, nos autos acima referenciados, constam os seguintes documentos e diligências:

${campos.conteudo_certidao || '____________________'}

Para constar, lavro a presente certidão.

Manaus-AM, ${d.data.dia} de ${d.data.mes} de ${d.data.ano}.

__________________________________
${d.encarregado.nome}
${d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado / Sindicante'}`;
            }
            
            gerarConteudoRelatorio(campos) {
                const d = this.dadosCaracterizacao;
                const cargo = d.procedimento.id === 'IPM' ? 'Encarregado do IPM' : 'Encarregado/Sindicante';
                
                return `RELATÓRIO DO ${d.procedimento.nome.toUpperCase()} (${d.procedimento.id})

Nº DO PROCEDIMENTO: ${d.portaria.numero}
ENCARREGADO: ${d.encarregado.nome}
${d.procedimento.id === 'PARE' ? 'RESPONSÁVEL' : 'ACUSADO'}: ${d.acusado.nome}


1. HISTÓRICO / PREAMBULAR

${campos.historico || '____________________'}


2. DILIGÊNCIAS REALIZADAS

${campos.diligencias || '____________________'}


3. ANÁLISE E FUNDAMENTAÇÃO

${campos.analise || '____________________'}


4. CONCLUSÃO E PROPOSTA

${campos.conclusao || '____________________'}


Manaus-AM, ${d.data.dia} de ${d.data.mes} de ${d.data.ano}.

__________________________________
${d.encarregado.nome}
${cargo}`;
            }
            
            irParaPreview() {
                // Verificar se há documentos gerados
                const documentosGerados = Object.values(this.documentos).filter(doc => doc.gerado).length;
                if (documentosGerados === 0) {
                    this.mostrarToast('Gere pelo menos um documento primeiro', 'erro');
                    return;
                }
                
                this.atualizarPasso(4);
                
                // Atualizar sidebar
                document.getElementById('step-3-info').textContent = `${documentosGerados}/7 documentos`;
                document.getElementById('step-3').classList.remove('active');
                document.getElementById('step-3').classList.add('completed');
                document.getElementById('step-4').classList.remove('inactive');
                document.getElementById('step-4').classList.add('active');
                
                // Configurar seletor de documentos
                const seletor = document.getElementById('seletor-documento-preview');
                seletor.innerHTML = '<option value="">Selecione um documento para visualizar</option>';
                
                const tipos = ['autuacao', 'abertura', 'designacao', 'termos', 'oficios', 'certidoes', 'relatorio'];
                tipos.forEach(tipo => {
                    if (this.documentos[tipo].gerado) {
                        const nome = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = nome;
                        seletor.appendChild(option);
                    }
                });
                
                // Selecionar primeiro documento
                if (seletor.options.length > 1) {
                    seletor.selectedIndex = 1;
                    this.mostrarPreview(seletor.value);
                }
            }
            
            mostrarPreview(tipo) {
                if (!tipo || !this.documentos[tipo]?.gerado) {
                    document.getElementById('preview-conteudo').textContent = 'Selecione um documento para visualizar...';
                    return;
                }
                
                document.getElementById('preview-conteudo').textContent = this.documentos[tipo].conteudo;
            }
            
            voltarParaDocumentos() {
                this.atualizarPasso(3);
            }
            
            atualizarPasso(passo) {
                this.passoAtual = passo;
                
                // Esconder todos os conteúdos
                document.getElementById('step1-content').classList.add('hidden');
                document.getElementById('step2-content').classList.add('hidden');
                document.getElementById('step3-content').classList.add('hidden');
                document.getElementById('step4-content').classList.add('hidden');
                
                // Mostrar conteúdo do passo atual
                document.getElementById(`step${passo}-content`).classList.remove('hidden');
            }
            
            atualizarListaDocumentos() {
                const lista = document.getElementById('lista-documentos');
                let html = '';
                let count = 0;
                
                const tipos = [
                    { id: 'autuacao', nome: 'Autuação' },
                    { id: 'abertura', nome: 'Abertura' },
                    { id: 'designacao', nome: 'Designação' },
                    { id: 'termos', nome: 'Termos' },
                    { id: 'oficios', nome: 'Ofícios' },
                    { id: 'certidoes', nome: 'Certidões' },
                    { id: 'relatorio', nome: 'Relatório' }
                ];
                
                tipos.forEach(tipo => {
                    const doc = this.documentos[tipo.id];
                    if (doc.gerado) {
                        count++;
                        html += `<div class="doc-item active p-3 rounded">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">${tipo.nome}</span>
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                        </div>`;
                    } else {
                        html += `<div class="doc-item p-3 rounded">
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-pmam-muted">${tipo.nome}</span>
                                <i class="far fa-circle text-gray-300"></i>
                            </div>
                        </div>`;
                    }
                });
                
                lista.innerHTML = html;
                document.getElementById('step-3-info').textContent = `${count}/7 documentos`;
            }
            
            gerarPDFDocumentoSelecionado() {
                const tipo = document.getElementById('seletor-documento-preview').value;
                if (!tipo || !this.documentos[tipo]?.gerado) {
                    this.mostrarToast('Selecione um documento primeiro', 'erro');
                    return;
                }
                
                const doc = new jsPDF();
                doc.setFont('helvetica');
                doc.setFontSize(11);
                
                const margem = 20;
                const largura = 210 - 2 * margem;
                
                // Título
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                const nomeDocumento = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                doc.text(`${this.procedimentoSelecionado.id} - ${nomeDocumento}`, 105, margem, { align: 'center' });
                
                // Conteúdo
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                const linhas = doc.splitTextToSize(this.documentos[tipo].conteudo, largura);
                doc.text(linhas, margem, margem + 15);
                
                const nomeArquivo = `${this.procedimentoSelecionado.id}_${tipo}_${new Date().getTime()}.pdf`;
                doc.save(nomeArquivo);
                
                this.mostrarToast('PDF gerado com sucesso!', 'sucesso');
            }
            
            gerarPDFTodosDocumentos() {
                const tipos = ['autuacao', 'abertura', 'designacao', 'termos', 'oficios', 'certidoes', 'relatorio'];
                const docsGerados = tipos.filter(tipo => this.documentos[tipo].gerado);
                
                if (docsGerados.length === 0) {
                    this.mostrarToast('Nenhum documento gerado', 'erro');
                    return;
                }
                
                docsGerados.forEach((tipo, index) => {
                    setTimeout(() => {
                        const doc = new jsPDF();
                        doc.setFont('helvetica');
                        doc.setFontSize(11);
                        
                        const margem = 20;
                        const largura = 210 - 2 * margem;
                        
                        // Título
                        doc.setFontSize(14);
                        doc.setFont(undefined, 'bold');
                        const nomeDocumento = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                        doc.text(`${this.procedimentoSelecionado.id} - ${nomeDocumento}`, 105, margem, { align: 'center' });
                        
                        // Conteúdo
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'normal');
                        const linhas = doc.splitTextToSize(this.documentos[tipo].conteudo, largura);
                        doc.text(linhas, margem, margem + 15);
                        
                        const nomeArquivo = `${this.procedimentoSelecionado.id}_${tipo}_${new Date().getTime()}.pdf`;
                        doc.save(nomeArquivo);
                    }, index * 100);
                });
                
                this.mostrarToast(`${docsGerados.length} PDFs gerados com sucesso!`, 'sucesso');
            }
            
            finalizarProcedimento() {
                this.salvarProcedimento();
                this.mostrarToast('Procedimento finalizado com sucesso!', 'sucesso');
            }
            
            salvarProcedimento() {
                if (!this.procedimentoSelecionado || !this.dadosCaracterizacao.portaria?.numero) {
                    this.mostrarToast('Complete a caracterização primeiro', 'erro');
                    return;
                }
                
                const procedimento = {
                    id: Date.now().toString(),
                    numeroPortaria: this.dadosCaracterizacao.portaria.numero,
                    tipo: this.procedimentoSelecionado.id,
                    nome: this.procedimentoSelecionado.nome,
                    data: new Date().toISOString(),
                    caracterizacao: this.dadosCaracterizacao,
                    documentos: this.documentos,
                    status: 'em_andamento',
                    ultimaAtualizacao: new Date().toISOString()
                };
                
                // Salvar no localStorage
                const indexExistente = this.procedimentosSalvos.findIndex(
                    p => p.numeroPortaria === procedimento.numeroPortaria
                );
                
                if (indexExistente >= 0) {
                    this.procedimentosSalvos[indexExistente] = procedimento;
                } else {
                    this.procedimentosSalvos.push(procedimento);
                }
                
                localStorage.setItem('sispro_procedimentos', JSON.stringify(this.procedimentosSalvos));
                this.mostrarToast('Procedimento salvo com sucesso', 'sucesso');
            }
            
            abrirGerenciador() {
                this.atualizarGerenciador();
                document.getElementById('gerenciador-modal').classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
            
            fecharGerenciador() {
                document.getElementById('gerenciador-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            }
            
            atualizarGerenciador() {
                const lista = document.getElementById('lista-procedimentos');
                
                if (this.procedimentosSalvos.length === 0) {
                    lista.innerHTML = `<div class="text-center py-12">
                        <i class="fas fa-folder-open text-pmam-muted text-4xl mb-4"></i>
                        <p class="text-pmam-muted">Nenhum procedimento salvo</p>
                    </div>`;
                    return;
                }
                
                const procedimentosOrdenados = [...this.procedimentosSalvos].sort(
                    (a, b) => new Date(b.ultimaAtualizacao) - new Date(a.ultimaAtualizacao)
                );
                
                lista.innerHTML = procedimentosOrdenados.map(proc => `
                    <div class="bg-white border border-pmam-border rounded-lg p-4 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-folder text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-pmam-navy">${proc.nome}</h4>
                                    <p class="text-sm text-pmam-muted">Portaria: ${proc.numeroPortaria}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="text-pmam-muted">
                                ${new Date(proc.ultimaAtualizacao).toLocaleDateString('pt-BR')}
                            </div>
                            <button onclick="sistema.carregarProcedimentoSalvo('${proc.id}')" 
                                    class="text-pmam-blue hover:text-pmam-light">
                                <i class="fas fa-edit mr-1"></i> Carregar
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            buscarProcedimentos() {
                const termo = document.getElementById('busca-gerenciador').value.toLowerCase();
                const lista = document.getElementById('lista-procedimentos');
                
                if (!termo.trim()) {
                    this.atualizarGerenciador();
                    return;
                }
                
                const resultados = this.procedimentosSalvos.filter(proc => 
                    proc.numeroPortaria.toLowerCase().includes(termo)
                );
                
                if (resultados.length === 0) {
                    lista.innerHTML = `<div class="text-center py-12">
                        <i class="fas fa-search text-pmam-muted text-4xl mb-4"></i>
                        <p class="text-pmam-muted">Nenhum procedimento encontrado</p>
                    </div>`;
                    return;
                }
                
                lista.innerHTML = resultados.map(proc => `
                    <div class="bg-white border border-pmam-border rounded-lg p-4 mb-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-500 flex items-center justify-center">
                                    <i class="fas fa-folder text-white"></i>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-pmam-navy">${proc.nome}</h4>
                                    <p class="text-sm text-pmam-muted">${proc.numeroPortaria}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <button onclick="sistema.carregarProcedimentoSalvo('${proc.id}')" 
                                    class="text-pmam-blue hover:text-pmam-light">
                                <i class="fas fa-edit mr-1"></i> Carregar
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            carregarProcedimentoSalvo(id) {
                const procedimento = this.procedimentosSalvos.find(p => p.id === id);
                if (!procedimento) return;
                
                // Carregar dados
                this.procedimentoSelecionado = {
                    id: procedimento.tipo,
                    nome: procedimento.nome,
                    descricao: '',
                    cor: 'blue',
                    icon: 'fa-folder'
                };
                
                this.dadosCaracterizacao = procedimento.caracterizacao;
                this.documentos = procedimento.documentos;
                
                // Preencher formulários
                document.getElementById('numero-portaria').value = procedimento.numeroPortaria;
                if (procedimento.caracterizacao.data) {
                    document.getElementById('data-dia').value = procedimento.caracterizacao.data.dia;
                    document.getElementById('data-mes').value = procedimento.caracterizacao.data.mes;
                    document.getElementById('data-ano').value = procedimento.caracterizacao.data.ano;
                }
                document.getElementById('local-unidade').value = procedimento.caracterizacao.local?.unidade || '';
                document.getElementById('encarregado-nome').value = procedimento.caracterizacao.encarregado?.nome || '';
                document.getElementById('acusado-nome').value = procedimento.caracterizacao.acusado?.nome || '';
                document.getElementById('objeto-apuracao').value = procedimento.caracterizacao.objeto?.apuracao || '';
                
                // Atualizar interface
                this.atualizarPasso(3);
                this.atualizarListaDocumentos();
                this.fecharGerenciador();
                
                // Atualizar status dos documentos
                Object.keys(this.documentos).forEach(tipo => {
                    if (this.documentos[tipo].gerado) {
                        document.getElementById(`status-${tipo}`).textContent = '✓ Gerado';
                        document.getElementById(`status-${tipo}`).classList.add('text-pmam-success');
                    }
                });
                
                this.mostrarToast('Procedimento carregado com sucesso', 'sucesso');
            }
            
            carregarProcedimentosSalvos() {
                try {
                    const dados = localStorage.getItem('sispro_procedimentos');
                    return dados ? JSON.parse(dados) : [];
                } catch (e) {
                    return [];
                }
            }
            
            preencherDataAtual() {
                const hoje = new Date();
                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                              'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                
                if (!document.getElementById('data-dia').value) {
                    document.getElementById('data-dia').value = hoje.getDate();
                }
                if (!document.getElementById('data-mes').value) {
                    document.getElementById('data-mes').value = meses[hoje.getMonth()];
                }
                if (!document.getElementById('data-ano').value) {
                    document.getElementById('data-ano').value = hoje.getFullYear();
                }
            }
            
            mostrarToast(mensagem, tipo) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                let cor = 'bg-pmam-blue';
                let icone = 'fas fa-info-circle';
                
                if (tipo === 'sucesso') {
                    cor = 'bg-green-500';
                    icone = 'fas fa-check-circle';
                } else if (tipo === 'erro') {
                    cor = 'bg-red-500';
                    icone = 'fas fa-exclamation-circle';
                }
                
                toast.className = `${cor} text-white p-4 rounded-xl shadow-lg`;
                toast.innerHTML = `
                    <div class="flex items-center">
                        <i class="${icone} mr-3"></i>
                        <span>${mensagem}</span>
                    </div>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }
        
        // Inicializar sistema
        const sistema = new SistemaProcedimentosPMAM();
        
        // Configurar eventos do preview
        document.getElementById('seletor-documento-preview').addEventListener('change', function() {
            sistema.mostrarPreview(this.value);
        });
        
        // Configurar busca no gerenciador
        document.getElementById('busca-gerenciador').addEventListener('input', function() {
            if (this.value.length >= 3) {
                sistema.buscarProcedimentos();
            } else if (this.value.length === 0) {
                sistema.atualizarGerenciador();
            }
        });
    </script>
</body>
</html>
