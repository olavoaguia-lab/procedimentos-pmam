<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO PMAM v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Roboto+Mono&display=swap');
        body { font-family: 'Montserrat', sans-serif; background-color: #f8fafc; }
        .proc-card { @apply flex flex-col items-center justify-center p-10 rounded-[2.5rem] transition-all cursor-pointer border-4 border-transparent hover:scale-105 hover:shadow-2xl shadow-lg; }
        .input-pmam { @apply w-full p-4 border-2 border-slate-200 rounded-2xl focus:border-blue-600 outline-none transition-all font-semibold text-slate-700; }
        .doc-item { @apply flex items-center justify-between p-6 bg-white rounded-3xl border-l-8 border-slate-300 shadow-sm hover:border-blue-600 transition-all cursor-pointer; }
    </style>
</head>
<body class="pb-20">

    <header class="bg-[#0f172a] text-white p-8 shadow-2xl rounded-b-[3rem] mb-10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-4xl font-black italic tracking-tighter uppercase text-yellow-500">SISPRO PMAM</h1>
                <p class="text-xs font-bold tracking-[0.3em] text-slate-400">Sistema de Procedimentos Administrativos</p>
            </div>
            <button onclick="app.abrirBusca()" class="bg-white/10 hover:bg-yellow-600 p-4 rounded-full transition-all">
                <i class="fas fa-database mr-2"></i> Pesquisar Salvos
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto px-6">
        
        <section id="tela-1" class="space-y-10">
            <h2 class="text-2xl font-black text-slate-800 text-center uppercase italic">Selecione o Procedimento</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div onclick="app.setTipo('IPM')" class="proc-card bg-blue-600 text-white">
                    <i class="fas fa-balance-scale text-7xl mb-4"></i>
                    <span class="text-2xl font-black uppercase">IPM</span>
                </div>
                <div onclick="app.setTipo('Sindicância Adm.')" class="proc-card bg-emerald-600 text-white">
                    <i class="fas fa-file-invoice text-7xl mb-4"></i>
                    <span class="text-2xl font-black uppercase">SIND. ADM.</span>
                </div>
                <div onclick="app.setTipo('Sindicância Inv.')" class="proc-card bg-amber-600 text-white">
                    <i class="fas fa-search-plus text-7xl mb-4"></i>
                    <span class="text-2xl font-black uppercase">SIND. INV.</span>
                </div>
                <div onclick="app.setTipo('PARE')" class="proc-card bg-red-700 text-white">
                    <i class="fas fa-hand-paper text-7xl mb-4"></i>
                    <span class="text-2xl font-black uppercase">PARE</span>
                </div>
                <div onclick="app.setTipo('PAD')" class="proc-card bg-indigo-900 text-white">
                    <i class="fas fa-gavel text-7xl mb-4"></i>
                    <span class="text-2xl font-black uppercase">PAD</span>
                </div>
            </div>
        </section>

        <section id="tela-2" class="hidden space-y-8 animate-fadeIn">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-white p-8 rounded-[3rem] shadow-xl border border-slate-100">
                <div class="space-y-4">
                    <h3 class="font-black text-blue-900 uppercase italic border-b-2 border-blue-100 pb-2">Identificação da Portaria</h3>
                    <input type="text" id="num-portaria" class="input-pmam" placeholder="Nº da Portaria (Ex: 005.02/2023)">
                    <input type="date" id="data-portaria" class="input-pmam">
                </div>
                <div class="space-y-4">
                    <h3 class="font-black text-blue-900 uppercase italic border-b-2 border-blue-100 pb-2">Resumo do Objeto</h3>
                    <textarea id="fatos" class="input-pmam h-[124px]" placeholder="Transcreva o objeto da portaria..."></textarea>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="app.abrirModal('Encarregado')" class="bg-slate-800 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase hover:bg-black transition-all">Definir Encarregado</button>
                <button onclick="app.abrirModal('Escrivão')" class="bg-slate-800 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase hover:bg-black transition-all">Designar Escrivão</button>
                <button onclick="app.abrirModal('Acusado')" class="bg-red-700 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase hover:bg-red-800 transition-all">Qualificar Acusado</button>
                <button onclick="app.abrirModal('Testemunha')" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-xs uppercase hover:bg-blue-800 transition-all">Adicionar Testemunha</button>
            </div>
            
            <div id="lista-qualificados" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <button onclick="app.navegar(3)" class="w-full bg-yellow-600 p-6 rounded-[2.5rem] font-black text-white shadow-xl hover:bg-yellow-700 transition-all text-xl uppercase italic">Prosseguir para Documentação</button>
        </section>

        <section id="tela-3" class="hidden space-y-10">
            <div class="bg-white p-10 rounded-[3rem] shadow-xl border border-slate-100">
                <h3 class="text-2xl font-black text-blue-900 mb-6 uppercase italic border-l-8 border-yellow-500 pl-4">Documentos Padrão PMAM</h3>
                <div id="grid-padrão" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-10"></div>

                <h3 class="text-2xl font-black text-blue-900 mb-6 uppercase italic border-l-8 border-blue-500 pl-4">Atos de Instrução e Diversos</h3>
                <div id="grid-diversos" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <button onclick="app.navegar(4)" class="w-full bg-blue-900 p-6 rounded-[2.5rem] font-black text-white shadow-xl hover:bg-black transition-all text-xl uppercase italic">Gerar Relatório Final</button>
        </section>

        <section id="tela-4" class="hidden space-y-6">
            <div class="bg-white p-12 rounded-[3.5rem] shadow-2xl border border-slate-200">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-2xl font-black text-slate-800 uppercase italic">Relatório do Encarregado</h2>
                    <div class="flex gap-2">
                        <button onclick="app.toggleEditRelatorio()" class="bg-amber-500 text-white px-6 py-3 rounded-2xl font-black text-xs hover:bg-amber-600">
                            <i class="fas fa-edit mr-2"></i> EDITAR
                        </button>
                        <button onclick="app.salvarNoSupabase()" class="bg-emerald-600 text-white px-6 py-3 rounded-2xl font-black text-xs hover:bg-emerald-700">
                            <i class="fas fa-save mr-2"></i> SALVAR
                        </button>
                        <button onclick="app.gerarPDF('relatorio')" class="bg-red-600 text-white px-6 py-3 rounded-2xl font-black text-xs hover:bg-red-700">
                            <i class="fas fa-file-pdf mr-2"></i> PDF
                        </button>
                    </div>
                </div>
                <textarea id="relatorio-final" class="w-full h-[800px] p-10 bg-slate-50 border-2 border-transparent rounded-[2rem] font-mono text-sm leading-relaxed outline-none transition-all focus:bg-white focus:border-blue-200" readonly></textarea>
            </div>
        </section>

    </main>

    <div id="modal-q" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-[100] backdrop-blur-md p-4">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] overflow-hidden shadow-2xl animate-zoomIn">
            <div class="p-8 bg-blue-900 text-white">
                <h3 id="papel-tit" class="text-3xl font-black uppercase italic text-yellow-500">Qualificação</h3>
            </div>
            <div class="p-10 space-y-4">
                <input type="text" id="q-nome" class="input-pmam" placeholder="Nome Completo">
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="q-rg" class="input-pmam" placeholder="RG / CI PM">
                    <input type="text" id="q-posto" class="input-pmam" placeholder="Posto/Graduação">
                </div>
                <input type="text" id="q-filiacao" class="input-pmam" placeholder="Filiação">
                <button onclick="app.salvarEnvolvido()" class="w-full bg-blue-900 text-white py-5 rounded-2xl font-black mt-4 hover:bg-black">CONFIRMAR DADOS</button>
            </div>
        </div>
    </div>

    <div id="modal-edit" class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[110] p-6">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[3rem] flex flex-col overflow-hidden">
            <div class="p-8 bg-slate-50 border-b flex justify-between items-center px-12">
                <h3 id="edit-tit" class="font-black text-slate-800 uppercase text-lg italic tracking-tight">Documento</h3>
                <div class="flex gap-4">
                    <button onclick="app.fecharEditor()" class="text-xs font-bold text-slate-400">FECHAR</button>
                    <button onclick="app.confirmarEdicao()" class="bg-blue-900 text-white px-10 py-3 rounded-full font-black text-[10px]">SALVAR ALTERAÇÕES</button>
                </div>
            </div>
            <textarea id="edit-area" class="flex-1 p-16 font-mono text-sm leading-relaxed outline-none border-0 bg-white"></textarea>
        </div>
    </div>

    <script>
        class SISPRO_V5 {
            constructor() {
                this.dados = { tipo: '', portaria: '', dataP: '', fatos: '', envolvidos: [], docs: {}, numOficio: 1 };
                this.editMode = false;
            }

            navegar(n) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`tela-${n}`).classList.remove('hidden');
                if(n === 3) this.gerarDocumentos();
                if(n === 4) this.gerarRelatorio();
                window.scrollTo(0,0);
            }

            setTipo(t) { this.dados.tipo = t; this.navegar(2); }

            abrirModal(papel) {
                this.papelAtual = papel;
                document.getElementById('papel-tit').innerText = papel;
                document.getElementById('modal-q').style.display = 'flex';
            }

            salvarEnvolvido() {
                const p = {
                    papel: this.papelAtual,
                    nome: document.getElementById('q-nome').value.toUpperCase(),
                    rg: document.getElementById('q-rg').value,
                    posto: document.getElementById('q-posto').value.toUpperCase()
                };
                this.dados.envolvidos.push(p);
                this.renderLista();
                document.getElementById('modal-q').style.display = 'none';
                this.limparModal();
            }

            limparModal() {
                ['q-nome','q-rg','q-posto','q-filiacao'].forEach(id => document.getElementById(id).value = '');
            }

            renderLista() {
                const div = document.getElementById('lista-qualificados');
                div.innerHTML = this.dados.envolvidos.map((e, i) => `
                    <div class="bg-white p-6 rounded-3xl shadow-md border-l-8 border-blue-900 flex justify-between items-center animate-fadeIn">
                        <div>
                            <span class="text-[9px] font-black text-blue-600 uppercase tracking-widest">${e.papel}</span>
                            <h4 class="font-bold text-slate-800 text-base">${e.posto} ${e.nome}</h4>
                            <p class="text-xs text-slate-400 font-mono">CI Nº ${e.rg}</p>
                        </div>
                        <button onclick="app.remover(${i})" class="text-red-300 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
                    </div>
                `).join('');
            }

            remover(i) { this.dados.envolvidos.splice(i,1); this.renderLista(); }

            formatarDataExtenso(dataStr) {
                if(!dataStr) return "____ de __________ de 202__";
                const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
                const d = new Date(dataStr + "T12:00:00");
                return `${d.getDate()} de ${meses[d.getMonth()]} de ${d.getFullYear()}`;
            }

            gerarDocumentos() {
                this.dados.portaria = document.getElementById('num-portaria').value;
                this.dados.dataP = document.getElementById('data-portaria').value;
                this.dados.fatos = document.getElementById('fatos').value;
                
                const enc = this.dados.envolvidos.find(x => x.papel === 'Encarregado') || {nome: '________________', posto: '____'};
                const esc = this.dados.envolvidos.find(x => x.papel === 'Escrivão') || {nome: '________________', posto: '____', rg: '____'};
                const dataExt = this.formatarDataExtenso(new Date().toISOString().split('T')[0]);
                const dataPort = this.formatarDataExtenso(this.dados.dataP);

                const padrao = {
                    'Autuação': `AUTUAÇÃO\n\nAos ${dataExt}, nesta Cidade de Manaus, Estado do Amazonas, autuo a Portaria nº ${this.dados.portaria}, de ${dataPort}, e demais documentos que a este junto, do que para constar lavro o presente termo.\n\n__________________________\n${esc.nome} - ${esc.posto}\nEscrivão`,
                    'Termo de Abertura': `TERMO DE ABERTURA\n\nAos ${dataExt}, nesta Cidade de Manaus, Estado do Amazonas, dou início a presente ${this.dados.tipo} do que para constar lavro o presente termo.\n\n__________________________\n${enc.nome} - ${enc.posto}\nEncarregado`,
                    'Compromisso de Escrivão': `TERMO DE COMPROMISSO DO ESCRIVÃO\n\nAos ${dataExt}, foi designado pelo Senhor ${enc.posto} ${enc.nome}, Encarregado deste procedimento, o militar ${esc.nome} (CI nº ${esc.rg}), para exercer a função de Escrivão, que prestou compromisso legal de manter o sigilo e cumprir fielmente as determinações legais.\n\n__________________________\nEncarregado`,
                    'Termo de Encerramento': `TERMO DE ENCERRAMENTO\n\nAos ${dataExt}, na cidade de Manaus, Estado do Amazonas, dei por encerrado os trabalhos do presente ${this.dados.tipo}, procedida em cumprimento ao determinado na portaria nº ${this.dados.portaria}.`
                };

                const diversos = {
                    'Ofício de Requisição': `OFÍCIO Nº ${this.dados.numOficio}/2023\n\nAo Sr. Comandante,\n\nSolicito a apresentação de militar para fins de oitiva em instrução de ${this.dados.tipo}.\n\n__________________________\nEncarregado`,
                    'Cota de Juntada': `TERMO DE JUNTADA\n\nAos ${dataExt}, faço a juntada aos presentes autos do documento abaixo descrito.\n\n__________________________\nEscrivão`
                };

                this.dados.docs = {...padrao, ...diversos};
                document.getElementById('grid-padrão').innerHTML = Object.keys(padrao).map(k => this.card(k, 'border-l-yellow-500')).join('');
                document.getElementById('grid-diversos').innerHTML = Object.keys(diversos).map(k => this.card(k, 'border-l-blue-500')).join('');
            }

            card(k, cor) {
                return `<div onclick="app.editarDoc('${k}')" class="doc-item ${cor}">
                    <span class="font-bold text-slate-800 uppercase italic text-sm">${k}</span>
                    <i class="fas fa-file-pen text-slate-300"></i>
                </div>`;
            }

            editarDoc(k) {
                this.docEditando = k;
                document.getElementById('edit-tit').innerText = k;
                document.getElementById('edit-area').value = this.dados.docs[k];
                document.getElementById('modal-edit').style.display = 'flex';
            }

            confirmarEdicao() { this.dados.docs[this.docEditando] = document.getElementById('edit-area').value; document.getElementById('modal-edit').style.display = 'none'; }
            fecharEditor() { document.getElementById('modal-edit').style.display = 'none'; }

            gerarRelatorio() {
                const enc = this.dados.envolvidos.find(x => x.papel === 'Encarregado') || {nome: '________________', posto: '____'};
                const dataExt = this.formatarDataExtenso(new Date().toISOString().split('T')[0]);
                let r = `POLÍCIA MILITAR DO AMAZONAS\nRELATÓRIO DE ${this.dados.tipo.toUpperCase()}\n\n`;
                r += `I - PRELIMINARES\nO presente procedimento foi instaurado visando apurar: ${this.dados.fatos}.\n\n`;
                r += `II - DILIGÊNCIAS REALIZADAS\nForam qualificados e ouvidos os envolvidos conforme termos anexos aos autos.\n\n`;
                r += `III - CONCLUSÃO\nDiante do exposto, este Encarregado conclui que...\n\nQuartel em Manaus-AM, ${dataExt}.\n\n__________________________\n${enc.nome} - ${enc.posto}\nEncarregado`;
                document.getElementById('relatorio-final').value = r;
            }

            toggleEditRelatorio() {
                this.editMode = !this.editMode;
                const area = document.getElementById('relatorio-final');
                area.readOnly = !this.editMode;
                if(this.editMode) area.focus();
                this.notificar(this.editMode ? "Modo de edição ativado" : "Relatório bloqueado para edição");
            }

            notificar(msg) {
                const t = document.createElement('div');
                t.className = "fixed bottom-5 right-5 bg-blue-900 text-white p-5 rounded-2xl shadow-2xl font-black text-xs animate-bounce";
                t.innerText = msg;
                document.body.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            gerarPDF(tipo) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const texto = tipo === 'relatorio' ? document.getElementById('relatorio-final').value : this.dados.docs[this.docEditando];
                doc.setFont("courier", "normal");
                doc.setFontSize(11);
                const lines = doc.splitTextToSize(texto, 175);
                doc.text(lines, 20, 30);
                doc.save(`${this.dados.tipo}_PMAM.pdf`);
            }
        }

        const app = new SISPRO_V5();
    </script>
</body>
</html>
