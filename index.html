<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISPRO - PMAM | Sistema de Procedimentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .input-field { @apply w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-900 outline-none transition-all text-sm; }
        .active-step { @apply bg-yellow-500 text-slate-900 font-bold shadow-md; }
        .doc-card { @apply p-5 bg-white rounded-xl border border-gray-100 hover:border-yellow-500 cursor-pointer shadow-sm transition-all; }
    </style>
</head>
<body class="flex">

    <aside class="fixed h-screen w-64 bg-slate-900 text-slate-300 p-6 flex flex-col">
        <div class="mb-10 text-center border-b border-slate-700 pb-6">
            <h1 class="text-2xl font-black text-white italic">SISPRO</h1>
            <p class="text-[10px] tracking-[0.2em] text-yellow-500">PMAM • PROCEDIMENTOS</p>
        </div>
        
        <nav class="flex-1 space-y-2">
            <button onclick="app.navegar(1)" id="b-1" class="w-full flex items-center gap-3 p-3 rounded-lg active-step"><i class="fas fa-list"></i> 1. Tipo</button>
            <button onclick="app.navegar(2)" id="b-2" class="w-full flex items-center gap-3 p-3 rounded-lg"><i class="fas fa-user-edit"></i> 2. Qualificação</button>
            <button onclick="app.navegar(3)" id="b-3" class="w-full flex items-center gap-3 p-3 rounded-lg"><i class="fas fa-file-alt"></i> 3. Documentos</button>
            <button onclick="app.navegar(4)" id="b-4" class="w-full flex items-center gap-3 p-3 rounded-lg"><i class="fas fa-print"></i> 4. Processo</button>
        </nav>

        <div class="pt-6 border-t border-slate-700">
            <button onclick="app.salvarNoSupabase()" class="w-full bg-emerald-600 text-white p-3 rounded-xl font-bold hover:bg-emerald-700 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-cloud"></i> SALVAR NUVEM
            </button>
        </div>
    </aside>

    <main class="ml-64 flex-1 p-10">
        
        <section id="tela-1" class="space-y-6">
            <h2 class="text-3xl font-black text-slate-800 mb-8">Tipo de Procedimento</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div onclick="app.setTipo('IPM')" class="doc-card text-center py-10">
                    <i class="fas fa-gavel text-4xl mb-4 text-slate-700"></i>
                    <h3 class="font-bold text-xl uppercase">IPM</h3>
                </div>
                <div onclick="app.setTipo('SINDICÂNCIA')" class="doc-card text-center py-10">
                    <i class="fas fa-balance-scale text-4xl mb-4 text-slate-700"></i>
                    <h3 class="font-bold text-xl uppercase">SINDICÂNCIA</h3>
                </div>
                <div onclick="app.setTipo('SAD')" class="doc-card text-center py-10">
                    <i class="fas fa-search text-4xl mb-4 text-slate-700"></i>
                    <h3 class="font-bold text-xl uppercase">SAD</h3>
                </div>
            </div>
        </section>

        <section id="tela-2" class="hidden space-y-6">
            <div class="flex justify-between items-end">
                <h2 class="text-3xl font-black text-slate-800">Qualificação dos Envolvidos</h2>
                <div class="flex gap-2">
                    <button onclick="app.abrirModal('Encarregado')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">+ Encarregado</button>
                    <button onclick="app.abrirModal('Escrivão')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">+ Escrivão</button>
                    <button onclick="app.abrirModal('Acusado')" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm">+ Acusado</button>
                    <button onclick="app.abrirModal('Testemunha')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">+ Testemunha</button>
                </div>
            </div>

            <div id="lista-qualificados" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </section>

        <section id="tela-3" class="hidden space-y-6">
            <h2 class="text-3xl font-black text-slate-800">Documentos Padrão</h2>
            <div id="grid-docs" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </section>

        <section id="tela-4" class="hidden space-y-6">
            <div class="bg-white p-8 rounded-3xl shadow-xl border border-gray-200">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="doc-title" class="text-xl font-bold">Visualização do Documento</h3>
                    <div class="flex gap-2">
                        <button onclick="app.navegar(3)" class="bg-slate-200 px-6 py-2 rounded-xl font-bold uppercase text-xs">Editar/Voltar</button>
                        <button onclick="app.exportarPDF()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold uppercase text-xs flex items-center gap-2">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>
                <textarea id="editor" class="w-full h-[500px] p-10 bg-slate-50 border-0 rounded-2xl font-mono text-sm leading-relaxed" spellcheck="false"></textarea>
            </div>
        </section>
    </main>

    <div id="modal-q" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-[100] backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-3xl overflow-hidden shadow-2xl">
            <div class="p-6 bg-slate-800 text-white flex justify-between">
                <h3 class="font-bold">Qualificar: <span id="span-papel" class="text-yellow-500"></span></h3>
                <button onclick="app.fecharModal()"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 grid grid-cols-2 gap-4">
                <div class="col-span-2"><label class="text-[10px] font-bold uppercase text-gray-400">Nome Completo</label><input type="text" id="q-nome" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">RG / Matrícula</label><input type="text" id="q-rg" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">Posto/Grad</label><input type="text" id="q-posto" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">Naturalidade</label><input type="text" id="q-natural" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">Profissão</label><input type="text" id="q-profissao" class="input-field"></div>
                <div class="col-span-2"><label class="text-[10px] font-bold uppercase text-gray-400">Filiação</label><input type="text" id="q-filiacao" class="input-field"></div>
                <div class="col-span-2"><label class="text-[10px] font-bold uppercase text-gray-400">Endereço</label><input type="text" id="q-endereco" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">Início Oitiva</label><input type="time" id="q-inicio" class="input-field"></div>
                <div><label class="text-[10px] font-bold uppercase text-gray-400">Fim Oitiva</label><input type="time" id="q-fim" class="input-field"></div>
                <button onclick="app.confirmarQualif()" class="col-span-2 bg-yellow-500 text-slate-900 font-black p-4 rounded-xl mt-4 uppercase">Salvar e Qualificar</button>
            </div>
        </div>
    </div>

    <script>
        const SB_URL = "https://dzknjtstiptcbkvszibo.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6a25qdHN0aXB0Y2JrdnN6aWJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTU3NDYsImV4cCI6MjA4MTQ3MTc0Nn0.LN4j37EHqLQpdoS0mNAIW9v-MTgWo8nXoFl1FrhSSHE";
        const _supabase = window.supabase.createClient(SB_URL, SB_KEY);

        class SISPRO {
            constructor() {
                this.dados = { tipo: '', envolvidos: [], id: 'PROC-'+Date.now() };
                this.papelAtual = '';
            }

            navegar(p) {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(`tela-${p}`).classList.remove('hidden');
                document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-step'));
                document.getElementById(`b-${p}`).classList.add('active-step');
                if(p === 3) this.gerarDocumentos();
            }

            setTipo(t) { this.dados.tipo = t; this.navegar(2); }

            abrirModal(papel) {
                this.papelAtual = papel;
                document.getElementById('span-papel').innerText = papel;
                document.getElementById('modal-q').style.display = 'flex';
            }

            fecharModal() { document.getElementById('modal-q').style.display = 'none'; }

            confirmarQualif() {
                const qualificado = {
                    papel: this.papelAtual,
                    nome: document.getElementById('q-nome').value,
                    rg: document.getElementById('q-rg').value,
                    posto: document.getElementById('q-posto').value,
                    naturalidade: document.getElementById('q-natural').value,
                    profissao: document.getElementById('q-profissao').value,
                    filiacao: document.getElementById('q-filiacao').value,
                    endereco: document.getElementById('q-endereco').value,
                    inicio: document.getElementById('q-inicio').value,
                    fim: document.getElementById('q-fim').value
                };
                this.dados.envolvidos.push(qualificado);
                this.renderLista();
                this.fecharModal();
            }

            renderLista() {
                const list = document.getElementById('lista-qualificados');
                list.innerHTML = this.dados.envolvidos.map((e, i) => `
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-yellow-500 flex justify-between items-center">
                        <div>
                            <span class="text-[9px] font-black uppercase text-yellow-600">${e.papel}</span>
                            <h4 class="font-bold text-slate-800">${e.nome}</h4>
                            <p class="text-[10px] text-gray-400">${e.posto} • RG ${e.rg}</p>
                        </div>
                        <button onclick="app.remover(${i})" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }

            remover(i) { this.dados.envolvidos.splice(i, 1); this.renderLista(); }

            async salvarNoSupabase() {
                const { error } = await _supabase.from('procedimentos').upsert([{ 
                    id_ext: this.dados.id, 
                    tipo: this.dados.tipo, 
                    conteudo: this.dados 
                }]);
                alert(error ? "Erro ao conectar Supabase" : "Salvo na Nuvem com Sucesso!");
            }

            gerarDocumentos() {
                const container = document.getElementById('grid-docs');
                const enc = this.dados.envolvidos.find(e => e.papel === 'Encarregado') || {nome: '_________', posto: '____'};
                const esc = this.dados.envolvidos.find(e => e.papel === 'Escrivão') || {nome: '_________', rg: '____'};
                const acu = this.dados.envolvidos.find(e => e.papel === 'Acusado') || {nome: '_________', filiacao: '_______'};
                const hoje = new Date().toLocaleDateString('pt-BR');

                const lista = [
                    { t: 'Autuação', c: `ESTADO DO AMAZONAS\nPOLÍCIA MILITAR DO AMAZONAS\n\nAUTUAÇÃO\n\nAos ${hoje}, autuo a portaria do presente ${this.dados.tipo}.\n\n__________________________\n${esc.nome}\nEscrivão` },
                    { t: 'Termo de Compromisso', c: `TERMO DE COMPROMISSO\n\nDesignado o ${esc.posto} ${esc.nome}, este presta compromisso de manter sigilo e fidelidade no presente ${this.dados.tipo}.\n\n__________________________\nEncarregado` },
                    { t: 'Juntada', c: `TERMO DE JUNTADA\n\nAos ${hoje}, faço a juntada da Folha de Alterações do ${acu.nome} aos autos.\n\n__________________________\nEscrivão` }
                ];

                container.innerHTML = lista.map(d => `
                    <div onclick="app.verDoc('${d.t}', \`${d.c}\`)" class="doc-card">
                        <h4 class="font-bold text-slate-700">${d.t}</h4>
                        <p class="text-[10px] text-emerald-600 font-bold uppercase mt-1 italic">Preenchido com dados colhidos</p>
                    </div>
                `).join('');
            }

            verDoc(t, c) {
                document.getElementById('doc-title').innerText = t;
                document.getElementById('editor').value = c;
                this.navegar(4);
            }

            exportarPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const lines = doc.splitTextToSize(document.getElementById('editor').value, 180);
                doc.text(lines, 15, 20);
                doc.save(`${this.dados.tipo}_Documento.pdf`);
            }
        }

        const app = new SISPRO();
    </script>
</body>
</html>
